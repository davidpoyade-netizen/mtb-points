<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Challenge MTB Points</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    :root{
      --bg:#f4f4f4;--card:#ffffff;--text:#0f172a;--muted:#667085;--border:#e5e7eb;
      --blue:#2563eb;--blue2:#1d4ed8;--shadow:0 12px 34px rgba(2,6,23,.12);
      --ok:#16a34a;--warn:#ea580c;--err:#dc2626;
      --chip:#f1f5f9;--r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}

    /* Header */
    header.header{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.90);
      backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    header.header h1{margin:0;font-size:18px;letter-spacing:.2px}
    nav{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    nav a{
      text-decoration:none;
      padding:8px 10px;border-radius:10px;
      color:var(--blue);font-weight:800;font-size:13px;
    }
    nav a:hover{background:#eff6ff}
    nav a.active{background:#eff6ff;color:var(--blue2)}

    /* Layout */
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      padding:18px;
      box-shadow:var(--shadow);
    }

    /* Hero */
    .hero{
      border-radius:22px;
      padding:18px;
      border:1px solid var(--border);
      background:
        radial-gradient(900px 260px at 12% 0%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(700px 240px at 95% 10%, rgba(16,185,129,.12), transparent 60%),
        #fff;
    }
    .heroTop{
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;
    }
    .hero h2{margin:0;font-size:24px;letter-spacing:-.25px}
    .hero .muted{margin-top:8px;line-height:1.55;color:#334155}

    /* Controls */
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{display:block;font-weight:900;font-size:12px;color:#0f172a}
    input,select{
      width:100%;padding:11px 12px;margin-top:6px;
      border:1px solid #cbd5e1;border-radius:14px;background:#fff;outline:none;
    }
    select:focus,input:focus{border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    .kpiBar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .kpi{
      flex:1;min-width:170px;
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      padding:12px;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    .kpi .big{font-size:22px;font-weight:900;letter-spacing:-.2px}
    .kpi .sub{font-size:12px;color:var(--muted);margin-top:4px}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);background:#fff;font-weight:900;font-size:12px;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#94a3b8;display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--err)}

    /* Main grid */
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }

    /* Leaderboard table */
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{font-size:12px;text-transform:uppercase;letter-spacing:.04em;color:var(--muted)}
    tr.rowBtn{cursor:pointer}
    tr.rowBtn:hover{background:#f8fafc}
    .rank{font-weight:900}
    .name{font-weight:900}
    .mutedTxt{color:var(--muted)}

    /* Badges */
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:12px;border:1px solid var(--border);background:#fff;
      white-space:nowrap;
    }
    .b-bronze{border-color:#f59e0b55}
    .b-silver{border-color:#94a3b855}
    .b-gold{border-color:#fbbf2455}
    .b-legend{border-color:#a855f755}

    /* Right card */
    .side{
      position:sticky;top:86px;
    }
    @media(max-width:980px){ .side{position:relative;top:auto} }

    .box{
      border:1px solid var(--border);
      border-radius:20px;
      padding:14px;
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    .box h3{margin:0;font-size:16px;letter-spacing:-.1px}
    .hint{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.55}

    .empty{
      margin-top:12px;
      padding:12px;
      border:1px dashed var(--border);
      border-radius:16px;
      color:var(--muted);
      background:#fff;
    }

    .btnRow{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;border-radius:14px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:900;color:var(--text);
      text-decoration:none;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 12px 22px rgba(2,6,23,.10)}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.primary:hover{background:var(--blue2);border-color:var(--blue2)}
    .btn.danger{border-color:#fecaca;color:var(--err);background:#fff}

    .note{
      margin-top:12px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      color:#1e3a8a;
      border-radius:16px;
      padding:12px;
      line-height:1.55;
      font-size:13px;
    }

    .small{font-size:12px}
    .hr{height:1px;background:var(--border);margin:12px 0}

    /* Detail list */
    .detailLine{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;
      padding:10px 0;border-bottom:1px dashed var(--border);
    }
    .detailLine:last-child{border-bottom:0}
    .detailRace{font-weight:900}
    .detailMeta{color:var(--muted);font-size:12px;margin-top:4px}
    .detailPts{font-weight:900;white-space:nowrap}

    footer{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
    }
  </style>
</head>
<body>

<header class="header">
  <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <h1>MTB Points ‚Äî Challenge</h1>
    <span class="pill" id="challengePill"><span class="dot" id="pillDot"></span><span id="pillText">Chargement‚Ä¶</span></span>
  </div>

  <nav>
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html">√âv√©nements</a>
    <a href="challengemtbpoints.html" class="active">Challenge</a>
    <a href="reglement.html">R√®glement</a>
    <a href="methodologie.html">M√©thodologie</a>
    <a href="about.html">√Ä propos</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">

    <section class="hero">
      <div class="heroTop">
        <div style="min-width:280px;flex:1">
          <h2>R√©sultats du Challenge MTB Points</h2>
          <div class="muted">
            Cette page agr√®ge les points MTB des coureurs (r√©sultats import√©s) et affiche l‚Äôavancement vers les badges.
          </div>
        </div>

        <div class="row" style="min-width:280px;max-width:560px">
          <div style="min-width:180px;flex:1">
            <label for="season" style="margin-top:0">Saison</label>
            <select id="season">
              <option value="all">Toutes</option>
            </select>
          </div>
          <div style="min-width:180px;flex:1">
            <label for="sort" style="margin-top:0">Tri</label>
            <select id="sort">
              <option value="points">Points (desc)</option>
              <option value="races">√âpreuves (desc)</option>
              <option value="best">Meilleure √©preuve (desc)</option>
              <option value="name">Nom (A‚ÜíZ)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="kpiBar">
        <div class="kpi">
          <div class="big" id="kpiAthletes">‚Äî</div>
          <div class="sub">coureurs class√©s</div>
        </div>
        <div class="kpi">
          <div class="big" id="kpiRaces">‚Äî</div>
          <div class="sub">√©preuves comptabilis√©es</div>
        </div>
        <div class="kpi">
          <div class="big" id="kpiTop">‚Äî</div>
          <div class="sub">meilleur total</div>
        </div>
      </div>

      <div class="note">
        üèÖ Badges : <b>Bronze 500</b> ‚Ä¢ <b>Argent 750</b> ‚Ä¢ <b>Or 1000</b> ‚Ä¢ <b>Legend 2000</b>.
        (Modifiables dans <code style="background:#fff;border:1px solid rgba(30,58,138,.25);border-radius:8px;padding:2px 6px">CHALLENGE.thresholds</code>)
      </div>
    </section>

    <div class="grid">

      <!-- LEFT: Leaderboard -->
      <div>
        <div id="boardWrap"></div>
      </div>

      <!-- RIGHT: Athlete detail -->
      <div class="side">
        <div class="box">
          <h3>D√©tail coureur</h3>
          <div class="hint" id="detailHint">
            Clique sur un coureur dans le classement pour voir ses √©preuves et ses points.
          </div>

          <div id="detailBox" class="empty">Aucun coureur s√©lectionn√©.</div>

          <div class="btnRow">
            <button class="btn" id="exportBtn" type="button">Exporter CSV</button>
            <button class="btn danger" id="resetBtn" type="button">R√©initialiser (local)</button>
          </div>

          <div class="hint small" style="margin-top:10px;">
            * Les donn√©es proviennent du stockage local (storage.js). ‚ÄúR√©initialiser‚Äù supprime les r√©sultats locaux, pas ceux du serveur.
          </div>
        </div>
      </div>

    </div>

    <footer>
      MTB Points ‚Äî Challenge (agr√©gation locale des r√©sultats import√©s).
    </footer>
  </div>
</div>

<script src="js/storage.js"></script>
<script>
  // -----------------------------
  // Challenge configuration
  // -----------------------------
  const CHALLENGE = {
    name: "MTB Points Challenge",
    thresholds: [
      { key: "bronze", label: "Bronze", min: 500,  cls: "b-bronze" },
      { key: "silver", label: "Argent", min: 750,  cls: "b-silver" },
      { key: "gold",   label: "Or",     min: 1000, cls: "b-gold" },
      { key: "legend", label: "Legend", min: 2000, cls: "b-legend" },
    ],
  };

  // -----------------------------
  // Helpers
  // -----------------------------
  function $(id){ return document.getElementById(id); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function fmt(n){ return (n == null || !Number.isFinite(n)) ? "‚Äî" : Math.round(n).toString(); }
  function setPill(text, ok=true){
    const pillText = $("pillText");
    const dot = $("pillDot");
    if (pillText) pillText.textContent = text;
    if (dot) dot.className = "dot " + (ok ? "ok" : "err");
  }
  function getYearFromDate(dateStr){
    if(!dateStr) return null;
    const y = String(dateStr).slice(0,4);
    return /^\d{4}$/.test(y) ? y : null;
  }
  function getBadgeForPoints(total) {
    const t = CHALLENGE.thresholds.slice().sort((a,b)=>a.min-b.min);
    let best = null;
    for (const b of t) if (total >= b.min) best = b;
    return best;
  }

  // -----------------------------
  // Data acquisition (compatible "storage.js" variances)
  // -----------------------------
  function loadAllResultEntries() {
    const candidates = [
      "loadResults",
      "loadStoredResults",
      "loadPublicResults",
      "loadRaceResults",
      "loadEventResults",
    ];
    for (const fn of candidates) {
      if (typeof window[fn] === "function") {
        const out = window[fn]();
        if (Array.isArray(out) && out.length) return out;
      }
    }
    try {
      const raw = localStorage.getItem("mtb_results") || localStorage.getItem("results") || localStorage.getItem("mtbPointsResults");
      if (raw) {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
      }
    } catch (_) {}
    return [];
  }

  function normalizeEntry(e, idx) {
    const athleteId = e.athleteId || e.riderId || e.userId || e.coureurId || e.idAthlete || ("ath_" + idx);
    const athleteName = e.athleteName || e.riderName || e.name || e.coureur || e.user || "Sans nom";
    const date = e.date || e.raceDate || e.eventDate || e.when || null;
    const season = getYearFromDate(date) || "‚Äî";
    const raceId = e.raceId || e.eventId || e.epreuveId || e.idRace || e.idEvent || null;
    const raceName = e.raceName || e.eventName || e.epreuveName || e.nameRace || e.nameEvent || e.race || "√âpreuve";
    const points = Number(e.points ?? e.mtbPoints ?? e.score ?? e.totalPoints ?? 0);

    return {
      athleteId: String(athleteId),
      athleteName: String(athleteName),
      date: date ? String(date) : null,
      season,
      raceId: raceId ? String(raceId) : null,
      raceName: String(raceName),
      points: Number.isFinite(points) ? points : 0,
      _raw: e
    };
  }

  function buildSeasonOptions(entries) {
    const sel = $("season");
    if (!sel) return;
    const years = Array.from(new Set(entries.map(x=>x.season).filter(x=>x && x !== "‚Äî")))
      .sort((a,b)=>b.localeCompare(a));
    sel.innerHTML = `<option value="all">Toutes</option>` + years.map(y=>`<option value="${esc(y)}">${esc(y)}</option>`).join("");
  }

  // -----------------------------
  // Aggregation
  // -----------------------------
  function aggregate(entries, seasonFilter) {
    const filtered = (seasonFilter && seasonFilter !== "all")
      ? entries.filter(e => e.season === seasonFilter)
      : entries;

    const byAthlete = new Map();
    const uniqueRaceIds = new Set();

    for (const e of filtered) {
      if (e.raceId) uniqueRaceIds.add(e.raceId);

      const key = e.athleteId;
      if (!byAthlete.has(key)) {
        byAthlete.set(key, {
          athleteId: e.athleteId,
          athleteName: e.athleteName,
          total: 0,
          races: 0,
          best: 0,
          entries: []
        });
      }
      const a = byAthlete.get(key);
      a.total += e.points;
      a.races += 1;
      a.best = Math.max(a.best, e.points);
      a.entries.push(e);
    }

    const list = Array.from(byAthlete.values()).map(a => {
      a.total = Math.round(a.total * 100) / 100;
      const badge = getBadgeForPoints(a.total);
      return { ...a, badge };
    });

    return {
      athletes: list,
      raceCount: uniqueRaceIds.size,
      rawCount: filtered.length
    };
  }

  function sortAthletes(list, sortKey) {
    const arr = list.slice();
    if (sortKey === "name") arr.sort((a,b)=>a.athleteName.localeCompare(b.athleteName));
    else if (sortKey === "races") arr.sort((a,b)=>b.races-a.races || b.total-a.total);
    else if (sortKey === "best") arr.sort((a,b)=>b.best-a.best || b.total-a.total);
    else arr.sort((a,b)=>b.total-a.total || b.best-a.best);
    return arr;
  }

  // -----------------------------
  // Rendering
  // -----------------------------
  let currentAthletes = [];
  let currentEntries = [];
  let selectedAthleteId = null;

  function renderBoard(athletes){
    if (!athletes.length){
      $("boardWrap").innerHTML = `
        <div class="empty">Aucun r√©sultat trouv√©. Importe des r√©sultats pour voir le challenge.</div>
      `;
      return;
    }

    const rows = athletes.map((a, i) => {
      const b = a.badge;
      const badgeHtml = b
        ? `<span class="badge ${b.cls}">üèÖ ${esc(b.label)}</span>`
        : `<span class="badge">‚Äî</span>`;

      return `
        <tr class="rowBtn" data-ath="${esc(a.athleteId)}">
          <td class="rank">${i+1}</td>
          <td>
            <div class="name">${esc(a.athleteName)}</div>
            <div class="mutedTxt small">Best: ${fmt(a.best)} ‚Ä¢ √âpreuves: ${fmt(a.races)}</div>
          </td>
          <td style="font-weight:900;">${fmt(a.total)}</td>
          <td>${badgeHtml}</td>
        </tr>
      `;
    }).join("");

    $("boardWrap").innerHTML = `
      <table>
        <thead>
          <tr>
            <th style="width:70px;">Rang</th>
            <th>Coureur</th>
            <th style="width:120px;">Points</th>
            <th style="width:140px;">Badge</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="hint small" style="margin-top:10px;">
        Clique sur une ligne pour afficher le d√©tail √† droite.
      </div>
    `;

    // bind
    Array.from(document.querySelectorAll("tr.rowBtn")).forEach(tr => {
      tr.addEventListener("click", () => {
        selectedAthleteId = tr.getAttribute("data-ath");
        const a = athletes.find(x => x.athleteId === selectedAthleteId);
        if (a) renderDetail(a);
        // highlight
        Array.from(document.querySelectorAll("tr.rowBtn")).forEach(x => x.style.outline = "");
        tr.style.outline = "3px solid rgba(59,130,246,.18)";
        tr.style.borderRadius = "10px";
      });
    });
  }

  function renderDetail(a){
    const b = a.badge;
    const badgeHtml = b
      ? `<span class="badge ${b.cls}">üèÖ ${esc(b.label)}</span>`
      : `<span class="badge">Aucun badge</span>`;

    const entries = a.entries.slice().sort((x,y)=>String(y.date||"").localeCompare(String(x.date||"")));

    const lines = entries.map(e => `
      <div class="detailLine">
        <div>
          <div class="detailRace">${esc(e.raceName)}</div>
          <div class="detailMeta">${esc(e.date || "‚Äî")} ‚Ä¢ Saison ${esc(e.season || "‚Äî")}</div>
        </div>
        <div class="detailPts">${fmt(e.points)} pts</div>
      </div>
    `).join("");

    $("detailBox").className = "";
    $("detailBox").innerHTML = `
      <div class="pill" style="margin-top:12px;">
        <span class="dot ok"></span>
        <span><b>${esc(a.athleteName)}</b> ‚Äî Total: ${fmt(a.total)} pts</span>
      </div>
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        ${badgeHtml}
        <span class="pill">üèÅ ${fmt(a.races)} √©preuve${a.races>1?"s":""}</span>
        <span class="pill">‚≠ê Best ${fmt(a.best)}</span>
      </div>
      <div class="hr"></div>
      <div>${lines || `<div class="empty">Aucune √©preuve.</div>`}</div>
    `;
  }

  function updateKpis(agg){
    $("kpiAthletes").textContent = fmt(agg.athletes.length);
    $("kpiRaces").textContent = fmt(agg.raceCount);
    const top = agg.athletes.slice().sort((a,b)=>b.total-a.total)[0];
    $("kpiTop").textContent = top ? fmt(top.total) : "‚Äî";
  }

  function apply(){
    const season = $("season").value;
    const sort = $("sort").value;

    const agg = aggregate(currentEntries, season);
    updateKpis(agg);

    const athletes = sortAthletes(agg.athletes, sort);
    currentAthletes = athletes;

    renderBoard(athletes);

    // reset detail if season changes
    $("detailBox").className = "empty";
    $("detailBox").textContent = "Aucun coureur s√©lectionn√©.";
    selectedAthleteId = null;

    setPill(agg.rawCount ? `OK (${agg.rawCount} r√©sultats)` : "Aucun r√©sultat", !!agg.rawCount);
  }

  // -----------------------------
  // Export / reset
  // -----------------------------
  function toCSV(rows){
    const headers = ["athleteId","athleteName","date","season","raceId","raceName","points"];
    const lines = [headers.join(",")].concat(rows.map(r => headers.map(h => {
      const v = r[h];
      const s = (v == null) ? "" : String(v);
      const escaped = '"' + s.replace(/"/g,'""') + '"';
      return escaped;
    }).join(",")));
    return lines.join("\n");
  }

  function download(filename, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  $("exportBtn").addEventListener("click", () => {
    if (!currentEntries.length) { alert("Aucun r√©sultat √† exporter."); return; }
    download("mtbpoints_challenge.csv", toCSV(currentEntries));
  });

  $("resetBtn").addEventListener("click", () => {
    if (!confirm("R√©initialiser les r√©sultats locaux (storage/localStorage) ?")) return;
    // best-effort reset keys without breaking other parts
    ["mtb_results","results","mtbPointsResults"].forEach(k => localStorage.removeItem(k));
    setPill("R√©initialis√©", true);
    init();
  });

  // -----------------------------
  // Init
  // -----------------------------
  function init(){
    setPill("Chargement‚Ä¶", true);

    const raw = loadAllResultEntries();
    currentEntries = raw.map(normalizeEntry);

    buildSeasonOptions(currentEntries);
    apply();
  }

  $("season").addEventListener("change", apply);
  $("sort").addEventListener("change", apply);

  init();
</script>

</body>
</html>
