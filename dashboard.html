<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‚Äî MTB Points</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    :root{
      --bg:#f4f4f4;--card:#ffffff;--text:#0f172a;--muted:#667085;--muted2:#64748b;--border:#e5e7eb;
      --blue:#2563eb;--blue2:#1d4ed8;--shadow:0 10px 30px rgba(2,6,23,.10);
      --r:22px;
      --ok:#16a34a;--warn:#ea580c;--err:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px}

    /* Header */
    header.header{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.90);
      backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    header.header h1{margin:0;font-size:18px;letter-spacing:.2px}
    nav{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    nav a{
      text-decoration:none;
      padding:8px 10px;
      border-radius:10px;
      color:var(--blue);
      font-weight:900;
      font-size:13px;
    }
    nav a:hover{background:#eff6ff}
    nav a.active{background:#eff6ff;color:var(--blue2)}
    .kpi{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-weight:900;font-size:12px;white-space:nowrap;
    }

    /* Layout */
    .wrap{max-width:1200px;margin:22px auto;padding:0 16px}
    .grid{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:16px;
    }

    /* Sidebar */
    .sideTitle{margin:0 0 10px 0;font-size:14px;letter-spacing:.02em;text-transform:uppercase;color:#334155}
    .sideLinks{display:grid;gap:8px}
    .sideLinks a{
      text-decoration:none;
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      color:#0f172a;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .sideLinks a:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(2,6,23,.08);border-color:#dbeafe}
    .sideSmall{margin-top:12px;border-top:1px dashed var(--border);padding-top:12px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-weight:900;font-size:12px;white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#94a3b8;display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--err)}

    /* Hero */
    .hero{
      border-radius:22px;
      padding:18px;
      border:1px solid var(--border);
      background:
        radial-gradient(900px 260px at 12% 0%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(700px 240px at 95% 10%, rgba(16,185,129,.12), transparent 60%),
        #fff;
    }
    .heroTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .hero h2{margin:0;font-size:22px;letter-spacing:-.2px}
    .hero .desc{margin-top:6px;line-height:1.55;color:#334155}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:1000;color:var(--text);
      text-decoration:none;white-space:nowrap;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(2,6,23,.08);border-color:#dbeafe}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.primary:hover{background:var(--blue2);border-color:var(--blue2)}
    .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
    .btn.ok:hover{background:#15803d;border-color:#15803d}
    .btn.danger{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
    .btn.danger:hover{background:#ffe4e6}
    .btn.ghost{background:#f8fafc}

    /* Filters */
    .filters{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.2fr 220px 220px;
      gap:10px;
      align-items:end;
    }
    @media(max-width:980px){ .filters{grid-template-columns:1fr} }
    label{display:block;font-weight:1000;font-size:12px;color:#0f172a}
    input,select{
      width:100%;
      padding:10px;
      margin-top:6px;
      border:1px solid #cbd5e1;
      border-radius:12px;
      background:#fff;
      font-size:14px;
    }
    input::placeholder{color:#94a3b8}

    /* Table */
    .tableWrap{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      background:#fff;
    }
    table{width:100%;border-collapse:collapse}
    thead th{
      text-align:left;
      font-size:12px;
      letter-spacing:.02em;
      text-transform:uppercase;
      color:#334155;
      background:#f8fafc;
      border-bottom:1px solid var(--border);
      padding:10px 12px;
      white-space:nowrap;
    }
    tbody td{padding:12px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
    tbody tr:hover{background:#fcfdff}
    .right{text-align:right}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:1000;font-size:12px;
      white-space:nowrap;
    }
    .empty{
      margin-top:14px;
      border:1px dashed var(--border);
      border-radius:18px;
      padding:14px;
      color:var(--muted);
      background:#fff;
    }
    .notice{
      margin-top:12px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      color:#1e3a8a;
      border-radius:18px;
      padding:12px 14px;
      line-height:1.5;
      font-size:13px;
    }
    .error{
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#991b1b;
    }

    a:focus, button:focus, input:focus, select:focus{
      outline:3px solid rgba(37,99,235,.25);
      outline-offset:2px;
    }
  </style>
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points ‚Äî Tableau de bord</h1>
    <span class="kpi" id="authState">‚Äî</span>
  </div>

  <nav>
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html">√âv√©nements</a>
    <a href="challengemtbpoints.html">Challenge</a>
    <a href="reglement.html">R√®glement</a>
    <a href="methodologie.html">M√©thodologie</a>
    <a href="about.html">√Ä propos</a>
    <a class="active" href="dashboard.html">Dashboard</a>
  </nav>

  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <button class="btn ghost" id="refreshBtn" type="button">‚Üª Actualiser</button>
    <button class="btn danger" id="logoutBtn" type="button">D√©connexion</button>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- Sidebar -->
    <aside class="panel">
      <div class="sideTitle">Gestion</div>
      <div class="sideLinks">
        <a href="course-create.html">‚ûï Cr√©er une √©preuve <span class="muted2">‚Üí</span></a>
        <a href="meeting-create.html">‚ûï Cr√©er un √©v√©nement <span class="muted2">‚Üí</span></a>
        <a href="import-results.html">üì• Import r√©sultats <span class="muted2">‚Üí</span></a>
      </div>

      <div class="sideSmall">
        <div class="sideTitle">Synchronisation</div>
        <div class="muted2" style="font-size:13px;line-height:1.5">
          Si tu avais d√©j√† des donn√©es en <b>localStorage</b>, tu peux les migrer vers Supabase (une seule fois).
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn ok" id="migrateBtn" type="button">‚á™ Migrer local ‚Üí Supabase</button>
        </div>
        <div id="migrateMsg" class="notice" style="display:none;"></div>
      </div>

      <div class="sideSmall">
        <div class="sideTitle">Statut</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <span class="chip"><span class="dot ok" id="dotAuth"></span><span id="authLabel">‚Äî</span></span>
          <span class="chip"><span class="dot" id="dotRole"></span><span id="roleLabel">‚Äî</span></span>
        </div>
        <div class="muted2" style="margin-top:10px;font-size:13px;line-height:1.5">
          Ce dashboard est pens√© pour <b>organisateurs</b>. Si ton r√¥le est <code>rider</code>, tu seras redirig√©.
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <section class="panel">
      <section class="hero">
        <div class="heroTop">
          <div style="min-width:260px;flex:1">
            <h2>Mes √©preuves</h2>
            <div class="desc">
              Liste de tes √©preuves (Supabase si connect√©, sinon localStorage). Clique sur une √©preuve pour voir la fiche.
            </div>
            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
              <span class="kpi">Total : <span id="count">0</span></span>
              <span class="badge" id="sourceBadge">Source : ‚Äî</span>
            </div>
          </div>

          <div class="actions">
            <a class="btn primary" href="course-create.html">+ Nouvelle √©preuve</a>
            <a class="btn" href="meetings.html">Voir √©v√©nements</a>
          </div>
        </div>

        <div class="filters">
          <div>
            <label for="q">Recherche</label>
            <input id="q" type="text" placeholder="Nom, discipline, niveau‚Ä¶" />
          </div>
          <div>
            <label for="sortBy">Tri</label>
            <select id="sortBy">
              <option value="date_desc">Date (r√©cent ‚Üí ancien)</option>
              <option value="date_asc">Date (ancien ‚Üí r√©cent)</option>
              <option value="name_asc">Nom (A ‚Üí Z)</option>
              <option value="name_desc">Nom (Z ‚Üí A)</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn ghost" id="clearBtn" type="button" style="width:100%">Effacer filtres</button>
          </div>
        </div>
      </section>

      <div id="loading" class="empty" style="display:none;">Chargement‚Ä¶</div>
      <div id="error" class="notice error" style="display:none;"></div>
      <div id="empty" class="empty" style="display:none;">Aucune √©preuve pour le moment.</div>

      <div class="tableWrap" id="tableWrap" style="display:none;">
        <table>
          <thead>
            <tr>
              <th>√âpreuve</th>
              <th>Date</th>
              <th>Discipline</th>
              <th>Niveau</th>
              <th class="right">Distance</th>
              <th class="right">D+</th>
              <th class="right">Global</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>
</main>

<script type="module">
  import { supabase } from "./js/supabaseClient.js";
  import { renderAuthState, signOut } from "./js/auth.js";
  import {
    loadStoredEventsHybrid,
    migrateLocalToSupabase
  } from "./js/storage-supabase.js";

  const $ = (id) => document.getElementById(id);

  const authState = $("authState");
  const dotAuth = $("dotAuth");
  const dotRole = $("dotRole");
  const authLabel = $("authLabel");
  const roleLabel = $("roleLabel");

  const logoutBtn = $("logoutBtn");
  const refreshBtn = $("refreshBtn");
  const migrateBtn = $("migrateBtn");
  const migrateMsg = $("migrateMsg");

  const qEl = $("q");
  const sortEl = $("sortBy");
  const clearBtn = $("clearBtn");

  const loadingEl = $("loading");
  const emptyEl = $("empty");
  const errorEl = $("error");
  const tableWrap = $("tableWrap");
  const tbody = $("tbody");

  const countEl = $("count");
  const sourceBadge = $("sourceBadge");

  function show(el, yes){ el.style.display = yes ? "" : "none"; }

  function normalize(s){
    return String(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
  }
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function valOrDash(x){
    const s = String(x ?? "").trim();
    return s ? s : "‚Äî";
  }
  function safeDateKey(d){
    const m = String(d||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return 0;
    return Number(m[1] + m[2] + m[3]);
  }
  function fmtKm(x){
    const n = Number(x);
    if (!Number.isFinite(n)) return "‚Äî";
    return `${n.toFixed(1).replace(".", ",")} km`;
  }
  function fmtM(x){
    const n = Number(x);
    if (!Number.isFinite(n)) return "‚Äî";
    return `${Math.round(n)} m`;
  }

  async function requireOrganizerOrRedirect() {
    const { data: s } = await supabase.auth.getSession();
    const session = s?.session;

    if (!session) {
      // pas connect√© -> login
      window.location.href = "login.html";
      return false;
    }

    dotAuth.classList.add("ok");
    authLabel.textContent = "Connect√©";

    const { data: u } = await supabase.auth.getUser();
    const user = u?.user;
    authState.textContent = user?.email ? `Connect√© : ${user.email}` : "Connect√©";

    // lire r√¥le via profiles
    const { data: prof, error } = await supabase
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .maybeSingle();

    if (error || !prof) {
      dotRole.classList.remove("ok");
      dotRole.classList.add("err");
      roleLabel.textContent = "R√¥le introuvable";
      // on autorise quand m√™me l‚Äôacc√®s si tu veux tester
      return true;
    }

    const role = prof.role || "rider";
    roleLabel.textContent = `R√¥le : ${role}`;
    dotRole.classList.add("ok");

    if (role !== "organizer" && role !== "admin") {
      // pas organisateur -> retour accueil (ou dashboard rider plus tard)
      window.location.href = "index.html";
      return false;
    }
    return true;
  }

  let ALL = [];

  async function loadRaces() {
    show(errorEl,false);
    show(emptyEl,false);
    show(tableWrap,false);
    show(loadingEl,true);

    try {
      // D√©tection source (Supabase vs local)
      const { data: s } = await supabase.auth.getSession();
      const authed = !!s?.session;
      sourceBadge.textContent = authed ? "Source : Supabase" : "Source : Local";
      ALL = await loadStoredEventsHybrid(); // renvoie races Supabase si authed, sinon localStorage
      applyAndRender();
    } catch (e) {
      console.error(e);
      errorEl.textContent = "Erreur lors du chargement des √©preuves.";
      show(errorEl,true);
    } finally {
      show(loadingEl,false);
    }
  }

  function applyAndRender() {
    const q = normalize(qEl.value);
    const sortBy = sortEl.value;

    let items = Array.isArray(ALL) ? ALL.slice() : [];

    if (q) {
      items = items.filter(ev => normalize([ev.name, ev.disc, ev.level].join(" ")).includes(q));
    }

    if (sortBy === "date_desc") items.sort((a,b) => safeDateKey(b.date) - safeDateKey(a.date) || normalize(a.name).localeCompare(normalize(b.name)));
    if (sortBy === "date_asc")  items.sort((a,b) => safeDateKey(a.date) - safeDateKey(b.date) || normalize(a.name).localeCompare(normalize(b.name)));
    if (sortBy === "name_asc")  items.sort((a,b) => normalize(a.name).localeCompare(normalize(b.name)));
    if (sortBy === "name_desc") items.sort((a,b) => normalize(b.name).localeCompare(normalize(a.name)));

    countEl.textContent = String(items.length);

    if (!items.length) {
      tbody.innerHTML = "";
      show(tableWrap,false);
      show(emptyEl,true);
      return;
    }

    show(emptyEl,false);
    show(tableWrap,true);

    tbody.innerHTML = items.map(ev => {
      const g = (ev.scoreGlobal ?? ev.score_global);
      const globalTxt = Number.isFinite(Number(g)) ? `${Math.round(Number(g))}/100` : "‚Äî";

      return `
        <tr>
          <td><b>${esc(valOrDash(ev.name))}</b></td>
          <td>${esc(valOrDash(ev.date))}</td>
          <td>${esc(valOrDash(ev.disc))}</td>
          <td>${esc(valOrDash(ev.level))}</td>
          <td class="right">${esc(fmtKm(ev.distanceKm ?? ev.distance_km))}</td>
          <td class="right">${esc(fmtM(ev.dplusM ?? ev.dplus_m))}</td>
          <td class="right"><span class="badge">${esc(globalTxt)}</span></td>
          <td>
            <a class="btn" style="padding:7px 10px;border-radius:10px" href="event.html?id=${encodeURIComponent(ev.id)}">Voir</a>
          </td>
        </tr>
      `;
    }).join("");
  }

  // UI events
  qEl.addEventListener("input", applyAndRender);
  sortEl.addEventListener("change", applyAndRender);

  clearBtn.addEventListener("click", () => {
    qEl.value = "";
    sortEl.value = "date_desc";
    applyAndRender();
  });

  refreshBtn.addEventListener("click", loadRaces);

  logoutBtn.addEventListener("click", async () => {
    try {
      await signOut();
    } finally {
      window.location.href = "login.html";
    }
  });

  migrateBtn.addEventListener("click", async () => {
    show(migrateMsg, true);
    migrateMsg.className = "notice";
    migrateMsg.textContent = "Migration en cours‚Ä¶";

    try {
      const res = await migrateLocalToSupabase();
      migrateMsg.textContent = `‚úÖ Migration termin√©e : ${res.meetings} √©v√©nement(s) + ${res.races} √©preuve(s) envoy√©s vers Supabase.`;
      await loadRaces();
    } catch (e) {
      console.error(e);
      migrateMsg.className = "notice error";
      migrateMsg.textContent = `‚ùå Migration impossible : ${e?.message || e}`;
    }
  });

  // Boot
  await renderAuthState();
  const ok = await requireOrganizerOrRedirect();
  if (ok) await loadRaces();
</script>

</body>
</html>
