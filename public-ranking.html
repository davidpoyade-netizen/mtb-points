<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Classement public ‚Äî MTB Points</title>

  <!-- Base + th√®me (le th√®me apr√®s la base) -->
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/theme-nature.css?v=6">

  <style>
    /* Ajustements sp√©cifiques √† cette page (sans r√©√©crire le design system) */
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1280px;margin:22px auto;padding:0 16px}
    .muted{color:var(--muted)}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* Header brand */
    .brandRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brandLogo{
      width:44px;height:44px;border-radius:14px;overflow:hidden;
      border:1px solid rgba(40,60,40,.18);
      box-shadow:0 12px 22px rgba(15,23,42,.18);
      background:#fff;
    }
    .brandLogo img{width:100%;height:100%;object-fit:cover;display:block}

    /* Tabs */
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .tab{
      border:1px solid var(--border);
      background:rgba(255,255,255,.78);
      border-radius:999px;
      padding:8px 12px;
      font-weight:1000;
      font-size:13px;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .tab:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 18px rgba(15,23,42,.10);
      border-color:rgba(47,111,62,.25);
    }
    .tab.active{
      background:rgba(47,111,62,.12);
      border-color:rgba(47,111,62,.25);
      color:var(--blue2);
    }
    .tab:disabled{opacity:.45;cursor:not-allowed}

    /* Two columns */
    .twoCols{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media(max-width:980px){ .twoCols{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--border);
      border-radius:18px;
      background:rgba(255,255,255,.82);
      box-shadow:0 10px 22px rgba(15,23,42,.08);
      overflow:hidden;
    }
    .panelHead{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;
      background:rgba(255,255,255,.70);
    }
    .panelHead h3{margin:0;font-size:14px;letter-spacing:-.1px}
    .panelBody{padding:0}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      position:sticky;top:0;
      background:rgba(255,255,255,.90);
      z-index:1;
      text-align:left;
      font-size:12px;
      color:#3f4e41;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      white-space:nowrap;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:hover td{background:rgba(47,111,62,.06)}
    tbody tr:last-child td{border-bottom:0}

    .rank{font-weight:1000}
    .name{font-weight:1000}
    .small{font-size:12px;color:var(--muted)}
    .points{font-weight:1000;font-variant-numeric:tabular-nums;white-space:nowrap}
    .empty{
      padding:14px;
      border-top:1px dashed var(--border);
      color:var(--muted);
      background:rgba(255,255,255,.70);
    }

    /* Source box */
    .sourceBox{
      margin-top:12px;
      border:1px dashed var(--border);
      border-radius:18px;
      padding:12px;
      background:rgba(255,255,255,.75);
      color:var(--muted);
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      font-size:12px;
    }
    .sourceBox b{color:var(--text)}

    /* Micro ‚Äúhero meta/desc‚Äù (si ton style.css ne les d√©finit pas) */
    .heroTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .heroMeta{margin-top:8px;color:#223024;line-height:1.5}
    .heroDesc{margin-top:8px;color:var(--muted);line-height:1.5}
    .heroActions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:4px}

    /* Filtres : on garde ta grille si elle existe dans style.css,
       sinon on la rend propre ici */
    .filters{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.2fr 220px 220px 160px 160px 180px;
      gap:10px;align-items:end;
    }
    @media(max-width:1200px){
      .filters{grid-template-columns:1fr 1fr}
      .filters .spanAll{grid-column:1/-1}
    }
    label{display:block;font-weight:1000;font-size:12px;color:var(--text)}
    input,select{
      width:100%;
      padding:10px;margin-top:6px;
      border:1px solid rgba(40,60,40,.20);
      border-radius:12px;
      background:rgba(255,255,255,.82);
      font-size:14px;
    }
    .hintRow{
      grid-column:1/-1;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }

    /* Accessibilit√© focus */
    a:focus, button:focus, input:focus, select:focus{
      outline:3px solid rgba(47,111,62,.25);
      outline-offset:2px;
    }
  </style>
</head>

<body class="theme-nature">

<header class="header">
  <div class="brandRow">
    <div class="brandLogo" title="MTB Points">
      <img src="img/mtbpoints-coins.png" alt="MTB Points ‚Äî Coins">
    </div>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <h1 style="margin:0;font-size:18px;letter-spacing:.2px">MTB Points ‚Äî Classement public</h1>
      <span class="pill"><span class="dot ok"></span><span id="pillCount">0</span> riders</span>
    </div>
  </div>

  <nav class="nav">
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html" class="active">Classement</a>
    <a href="meetings.html">√âv√©nements</a>
    <a href="events.html">√âpreuves</a>
    <a href="challengemtbpoints.html">Challenge</a>
    <a href="about.html">√Ä propos</a>
  </nav>
</header>

<main class="wrap">
  <div class="card">

    <section class="hero">
      <div class="heroTop">
        <div style="min-width:280px;flex:1">
          <h2 style="margin:0;font-size:22px;letter-spacing:-.2px">Classement ‚Äî Hommes / Femmes</h2>
          <div class="heroMeta">
            Cumule les points par rider. Tabs = vue (G√©n√©ral / discipline / e-bike), filtres = recherche.
          </div>
          <div class="heroDesc">
            Source prioritaire : <b>Supabase</b> (si vues publiques disponibles) ‚Ä¢ fallback : <b>localStorage</b> (<code>mtb.results.v1</code>).
          </div>
        </div>

        <div class="heroActions">
          <span class="pill"><span class="dot"></span><span id="pillMode">G√©n√©ral</span></span>
          <span class="pill"><span class="dot"></span><span id="pillRows">0</span> lignes</span>
          <span class="pill"><span class="dot warn"></span><span id="pillSource">‚Äî</span></span>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>
    </section>

    <!-- Filters -->
    <div class="filters" style="margin-top:14px;">
      <div class="spanAll">
        <label for="q">Recherche rider</label>
        <input id="q" type="text" placeholder="Nom, email, nationalit√©‚Ä¶" />
      </div>

      <div>
        <label for="nat">Nationalit√©</label>
        <select id="nat"><option value="">Toutes</option></select>
      </div>

      <div>
        <label for="cat">Cat√©gorie</label>
        <select id="cat"><option value="">Toutes</option></select>
      </div>

      <div>
        <label for="ageMin">√Çge min</label>
        <input id="ageMin" type="number" min="0" placeholder="ex: 18" />
      </div>

      <div>
        <label for="ageMax">√Çge max</label>
        <input id="ageMax" type="number" min="0" placeholder="ex: 49" />
      </div>

      <div>
        <label for="minPts">Points min</label>
        <input id="minPts" type="number" min="0" placeholder="ex: 100" />
      </div>

      <div>
        <label for="sortBy">Tri</label>
        <select id="sortBy">
          <option value="points_desc">Points ‚Üì</option>
          <option value="points_asc">Points ‚Üë</option>
          <option value="name_asc">Nom A‚ÜíZ</option>
        </select>
      </div>

      <div>
        <button class="btn primary" id="btnReset" type="button">R√©initialiser</button>
      </div>

      <div class="hintRow">
        <div>Affichage : <strong id="countShown">0</strong> riders</div>
        <div>Astuce : ajoute <code>sexe</code>/<code>age</code>/<code>nationality</code> dans l‚Äôimport r√©sultats.</div>
      </div>
    </div>

    <div class="sourceBox" id="sourceBox">
      <div>Mode donn√©es : <b id="sourceLabel">‚Äî</b></div>
      <div id="sourceHint">‚Äî</div>
    </div>

    <div class="twoCols">
      <section class="panel">
        <div class="panelHead">
          <h3>üë® Hommes</h3>
          <span class="pill"><span class="dot"></span><span id="countM">0</span></span>
        </div>
        <div class="panelBody">
          <table>
            <thead>
              <tr>
                <th style="width:56px;">#</th>
                <th>Rider</th>
                <th style="width:150px;">Cat / √Çge</th>
                <th style="width:120px;">Nation</th>
                <th style="width:110px;">Points</th>
              </tr>
            </thead>
            <tbody id="tbodyM"></tbody>
          </table>
          <div id="emptyM" class="empty" style="display:none;">Aucun rider homme avec ces filtres.</div>
        </div>
      </section>

      <section class="panel">
        <div class="panelHead">
          <h3>üë© Femmes</h3>
          <span class="pill"><span class="dot"></span><span id="countF">0</span></span>
        </div>
        <div class="panelBody">
          <table>
            <thead>
              <tr>
                <th style="width:56px;">#</th>
                <th>Rider</th>
                <th style="width:150px;">Cat / √Çge</th>
                <th style="width:120px;">Nation</th>
                <th style="width:110px;">Points</th>
              </tr>
            </thead>
            <tbody id="tbodyF"></tbody>
          </table>
          <div id="emptyF" class="empty" style="display:none;">Aucune rider femme avec ces filtres.</div>
        </div>
      </section>
    </div>

  </div>
</main>

<!-- deps locales (fallback localStorage) -->
<script src="js/data.js"></script>
<script src="js/storage.js"></script>

<!-- LOGIQUE HYBRIDE (Supabase -> sinon localStorage) -->
<script type="module">
(function(){
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const num = (x)=>{ const n = Number(String(x??"").replace(",", ".").trim()); return Number.isFinite(n) ? n : null; };

  function setSource(kind, hint){
    $("pillSource").textContent = kind || "‚Äî";
    $("sourceLabel").textContent = kind || "‚Äî";
    $("sourceHint").textContent = hint || "‚Äî";
    const dot = $("pillSource")?.closest(".pill")?.querySelector(".dot");
    if (dot){
      dot.classList.remove("ok","warn","err");
      dot.classList.add(kind === "Supabase" ? "ok" : "warn");
    }
  }

  // -------------------------
  // Normalization helpers
  // -------------------------
  function pick(obj, keys){
    for (const k of keys){
      if (obj && obj[k] != null && String(obj[k]).trim() !== "") return obj[k];
    }
    return null;
  }
  function normSex(v){
    const s = String(v||"").trim().toLowerCase();
    if (!s) return null;
    if (["m","h","homme","male","masculin"].includes(s)) return "M";
    if (["f","femme","female","feminin","f√©minin"].includes(s)) return "F";
    return null;
  }
  function normDisc(v){
    const s = String(v||"").trim();
    return s || "";
  }
  function isEbike(v){
    if (v == null) return null;
    const s = String(v).trim().toLowerCase();
    if (s === "1" || s === "true" || s === "yes") return true;
    if (s === "0" || s === "false" || s === "no") return false;
    return null;
  }

  // -------------------------
  // Tabs / modes
  // -------------------------
  const MODES = [
    { key:"general", label:"G√©n√©ral", disc:null, ebike:null },
    { key:"xc_m", label:"XC musculaire", disc:"XC", ebike:false },
    { key:"xc_e", label:"XC assistance √©lectrique", disc:"XC", ebike:true },
    { key:"dh", label:"DH", disc:"DH", ebike:null },
    { key:"enduro", label:"Enduro", disc:"Enduro", ebike:null },
    { key:"gravel", label:"Gravel", disc:"Gravel", ebike:null },
  ];
  let ACTIVE_MODE = "general";

  function buildTabs(enabled=true){
    const root = $("tabs");
    root.innerHTML = "";
    for (const m of MODES){
      const b = document.createElement("button");
      b.type = "button";
      b.className = `tab ${m.key === ACTIVE_MODE ? "active" : ""}`;
      b.textContent = m.label;
      b.disabled = !enabled && m.key !== "general";
      b.title = (!enabled && m.key !== "general") ? "Vue discipline indisponible (donn√©es Supabase agr√©g√©es)" : "";
      b.addEventListener("click", ()=>{
        ACTIVE_MODE = m.key;
        buildTabs(enabled);
        renderAll();
      });
      root.appendChild(b);
    }
  }

  // -------------------------
  // Data sources
  // -------------------------
  let SOURCE_MODE = "Local";
  let rowsForRanking = [];
  let racesById = new Map();

  function safeJson(key){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; }catch(_){ return null; }
  }
  function listRacesSafe(){
    if (typeof window.listRaces === "function") return window.listRaces();
    if (typeof window.getRaces === "function") return window.getRaces();
    const arr = safeJson("mtb.races.v1");
    return Array.isArray(arr) ? arr : [];
  }
  function listResultsSafe(){
    if (typeof window.listResults === "function") return window.listResults();
    if (typeof window.getResults === "function") return window.getResults();
    const arr = safeJson("mtb.results.v1");
    return Array.isArray(arr) ? arr : [];
  }

  function normalizeLocalRace(r){
    return {
      id: r?.id ?? null,
      disc: normDisc(r?.disc ?? r?.discipline),
      ebike: (r?.ebike ?? r?.isEbike ?? r?.eBike ?? null),
    };
  }

  function normalizeResultRow(r){
    return {
      raceId: r?.raceId ?? r?.race_id ?? r?.eventId ?? null,
      points: num(r?.points ?? r?.score ?? r?.mtbPoints) ?? 0,

      riderId: pick(r, ["riderId","rider_id","athlete_id","id"]) || null,
      riderEmail: (pick(r, ["riderEmail","email","mail","e-mail"]) || "").toString().trim().toLowerCase() || null,
      riderName: (pick(r, ["riderName","name","nom","prenom","pr√©nom","athlete","coureur"]) || "").toString().trim() || null,

      sex: normSex(pick(r, ["sex","gender","sexe"])),
      age: num(pick(r, ["age","√¢ge"])),
      category: (pick(r, ["age_category","ageCat","category","cat","categorie","cat√©gorie"]) || "").toString().trim() || null,
      nationality: (pick(r, ["nationality","nation","country","pays","nat"]) || "").toString().trim() || null,

      disc: normDisc(pick(r, ["disc","discipline"])),
      ebike: (pick(r, ["ebike","isEbike","eBike"]) ?? null),
    };
  }

  async function tryLoadFromSupabase(){
    try{
      const { supabase } = await import("./js/supabaseClient.js");

      // 1) v_public_results (id√©al)
      try{
        const { data, error } = await supabase
          .from("v_public_results")
          .select("*")
          .limit(5000);

        if (error) throw error;

        rowsForRanking = (data || []).map(normalizeResultRow).filter(x => x.riderEmail || x.riderName);
        SOURCE_MODE = "Supabase";
        setSource("Supabase", "Source: v_public_results (tabs discipline actives)");
        return true;
      } catch(_) {
        // 2) v_public_ranking (agr√©g√©)
        const { data, error } = await supabase
          .from("v_public_ranking")
          .select("*")
          .order("score", { ascending: false })
          .limit(5000);

        if (error) throw error;

        rowsForRanking = (data || []).map(r => ({
          raceId: null,
          points: num(r.score ?? r.points) ?? 0,
          riderId: r.rider_id ?? r.id ?? null,
          riderEmail: null,
          riderName: r.name ?? `${r.last_name || ""} ${r.first_name || ""}`.trim() || null,
          sex: normSex(r.sex),
          age: num(r.age_on_year ?? r.age),
          category: (r.age_category ?? r.category ?? null),
          nationality: (r.nationality ?? r.nat ?? null),
          disc: "",
          ebike: null
        })).filter(x => x.riderName);

        SOURCE_MODE = "Supabase";
        setSource("Supabase", "Source: v_public_ranking (agr√©g√© : tabs discipline limit√©es)");
        return true;
      }
    } catch(e){
      return false;
    }
  }

  function loadFromLocal(){
    const races = listRacesSafe().map(normalizeLocalRace);
    racesById = new Map(races.filter(r => r.id).map(r => [r.id, r]));
    const results = listResultsSafe().map(normalizeResultRow).filter(x => x.riderEmail || x.riderName);
    rowsForRanking = results;

    SOURCE_MODE = "Local";
    setSource("Local", "Source: localStorage (mtb.results.v1 + mtb.races.v1)");
  }

  function modeFilter(row){
    const mode = MODES.find(x => x.key === ACTIVE_MODE) || MODES[0];
    if (!mode) return true;
    if (mode.key === "general") return true;

    const disc = row.disc || racesById.get(row.raceId)?.disc || "";
    const eb = isEbike(row.ebike ?? racesById.get(row.raceId)?.ebike);

    if (mode.disc && String(disc||"").toLowerCase() !== String(mode.disc).toLowerCase()) return false;
    if (mode.ebike !== null){
      if (eb === null) return false;
      if (eb !== mode.ebike) return false;
    }
    return true;
  }

  function riderKey(row){
    return row.riderEmail ? `email:${row.riderEmail}` :
           row.riderId ? `id:${row.riderId}` :
           `name:${(row.riderName||"").toLowerCase()}`;
  }

  function aggregateRiders(){
    const map = new Map();

    for (const r of rowsForRanking){
      if (!modeFilter(r)) continue;

      const key = riderKey(r);
      if (!key || key.endsWith(":")) continue;

      if (!map.has(key)){
        map.set(key, {
          key,
          name: r.riderName || (r.riderEmail || "Rider"),
          email: r.riderEmail,
          sex: r.sex || null,
          age: r.age ?? null,
          category: r.category || null,
          nationality: r.nationality || null,
          points: 0,
          rows: 0
        });
      }
      const it = map.get(key);

      it.name = it.name || r.riderName || it.email || "Rider";
      it.sex = it.sex || r.sex || null;
      it.age = (it.age == null && r.age != null) ? r.age : it.age;
      it.category = it.category || r.category || null;
      it.nationality = it.nationality || r.nationality || null;

      it.points += (num(r.points) ?? 0);
      it.rows += 1;
    }

    return Array.from(map.values()).map(x => ({...x, points: Math.round(x.points)}));
  }

  function fillFilterOptions(riders){
    const nats = Array.from(new Set(riders.map(r=> (r.nationality||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    const cats = Array.from(new Set(riders.map(r=> (r.category||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

    const natSel = $("nat");
    const catSel = $("cat");

    const keepNat = natSel.value;
    const keepCat = catSel.value;

    natSel.innerHTML = `<option value="">Toutes</option>` + nats.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("");
    catSel.innerHTML = `<option value="">Toutes</option>` + cats.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");

    if (keepNat) natSel.value = keepNat;
    if (keepCat) catSel.value = keepCat;
  }

  function applyFilters(riders){
    const q = ($("q").value || "").trim().toLowerCase();
    const nat = ($("nat").value || "").trim();
    const cat = ($("cat").value || "").trim();
    const ageMin = num($("ageMin").value);
    const ageMax = num($("ageMax").value);
    const minPts = num($("minPts").value) ?? 0;

    return riders.filter(r=>{
      if (q){
        const txt = `${r.name||""} ${r.email||""} ${r.nationality||""} ${r.category||""}`.toLowerCase();
        if (!txt.includes(q)) return false;
      }
      if (nat && (r.nationality||"") !== nat) return false;
      if (cat && (r.category||"") !== cat) return false;
      if ((r.points ?? 0) < minPts) return false;

      if (ageMin != null){
        if (r.age == null) return false;
        if (r.age < ageMin) return false;
      }
      if (ageMax != null){
        if (r.age == null) return false;
        if (r.age > ageMax) return false;
      }
      return true;
    });
  }

  function sortRiders(arr){
    const s = $("sortBy").value || "points_desc";
    const a = arr.slice();
    a.sort((x,y)=>{
      if (s === "points_desc") return (y.points||0) - (x.points||0);
      if (s === "points_asc") return (x.points||0) - (y.points||0);
      if (s === "name_asc") return String(x.name||"").toLowerCase().localeCompare(String(y.name||"").toLowerCase());
      return 0;
    });
    return a;
  }

  function renderTable(tbodyId, emptyId, list){
    const tb = $(tbodyId);
    const empty = $(emptyId);
    tb.innerHTML = "";

    if (!list.length){
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    list.forEach((r, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank">${idx + 1}</td>
        <td>
          <div class="name">${esc(r.name || "Rider")}</div>
          <div class="small">${r.email ? esc(r.email) : "‚Äî"}</div>
        </td>
        <td>
          <div><b>${esc(r.category || "‚Äî")}</b></div>
          <div class="small">√Çge : ${r.age != null ? esc(String(r.age)) : "‚Äî"}</div>
        </td>
        <td>${esc(r.nationality || "‚Äî")}</td>
        <td class="points">${esc(String(r.points ?? 0))} pts</td>
      `;
      tb.appendChild(tr);
    });
  }

  function renderAll(){
    const mode = MODES.find(x=>x.key===ACTIVE_MODE) || MODES[0];
    $("pillMode").textContent = mode.label;

    $("pillRows").textContent = String(rowsForRanking.length);

    const ridersAgg = aggregateRiders();
    $("pillCount").textContent = String(ridersAgg.length);

    fillFilterOptions(ridersAgg);

    let riders = applyFilters(ridersAgg);
    riders = sortRiders(riders);

    const men = riders.filter(r => r.sex === "M");
    const women = riders.filter(r => r.sex === "F");

    $("countShown").textContent = String(riders.length);
    $("countM").textContent = String(men.length);
    $("countF").textContent = String(women.length);

    renderTable("tbodyM", "emptyM", men);
    renderTable("tbodyF", "emptyF", women);
  }

  $("btnReset").addEventListener("click", ()=>{
    $("q").value = "";
    $("nat").value = "";
    $("cat").value = "";
    $("ageMin").value = "";
    $("ageMax").value = "";
    $("minPts").value = "";
    $("sortBy").value = "points_desc";
    renderAll();
  });

  ["q","nat","cat","ageMin","ageMax","minPts","sortBy"].forEach(id=>{
    $(id).addEventListener("input", renderAll);
    $(id).addEventListener("change", renderAll);
  });

  (async function init(){
    const ok = await tryLoadFromSupabase();
    if (!ok) loadFromLocal();

    const tabsEnabled = !(SOURCE_MODE === "Supabase" && rowsForRanking.every(r => !r.raceId && !r.disc));
    buildTabs(tabsEnabled);

    renderAll();
  })();

})();
</script>

</body>
</html>
