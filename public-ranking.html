<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Classement public â€” MTB Points</title>
  <link rel="stylesheet" href="./css/style.css" />
  <style>
    :root{
      --bg:#f4f4f4;--card:#ffffff;--text:#0f172a;--muted:#667085;--border:#e5e7eb;
      --blue:#2563eb;--blue2:#1d4ed8;--shadow:0 10px 30px rgba(2,6,23,.10);
      --r:22px;--ok:#16a34a;--warn:#ea580c;--err:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}
    .muted{color:var(--muted)}
    header.header{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.90);
      backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    header.header h1{margin:0;font-size:18px;letter-spacing:.2px}
    nav{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    nav a{text-decoration:none;padding:8px 10px;border-radius:10px;color:var(--blue);font-weight:900;font-size:13px}
    nav a:hover{background:#eff6ff}
    nav a.active{background:#eff6ff;color:var(--blue2)}

    .wrap{max-width:1280px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}

    .hero{
      border-radius:22px;padding:18px;border:1px solid var(--border);
      background:
        radial-gradient(900px 260px at 12% 0%, rgba(37,99,235,.14), transparent 60%),
        radial-gradient(700px 240px at 95% 10%, rgba(16,185,129,.10), transparent 60%),
        #fff;
    }
    .heroTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .hero h2{margin:0;font-size:22px;letter-spacing:-.2px}
    .hero p{margin:6px 0 0 0;line-height:1.55;color:#334155}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-weight:900;font-size:12px;white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#94a3b8;display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.err{background:var(--err)}

    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .tab{
      border:1px solid var(--border);background:#fff;border-radius:999px;
      padding:8px 12px;font-weight:1000;font-size:13px;cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .tab:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(2,6,23,.08);border-color:#dbeafe}
    .tab.active{background:#eff6ff;border-color:#bfdbfe;color:var(--blue2)}

    .filters{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.2fr 220px 220px 160px 160px 180px;
      gap:10px;align-items:end;
    }
    @media(max-width:1200px){
      .filters{grid-template-columns: 1fr 1fr; }
      .filters .spanAll{grid-column:1/-1}
    }
    label{display:block;font-weight:1000;font-size:12px;color:#0f172a}
    input,select{
      width:100%;
      padding:10px;margin-top:6px;
      border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:14px;
    }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:1000;color:var(--text);
      text-decoration:none;white-space:nowrap;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      width:100%;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(2,6,23,.08);border-color:#dbeafe}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.primary:hover{background:var(--blue2);border-color:var(--blue2)}
    .btn.ghost{background:#f8fafc}

    .twoCols{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media(max-width:980px){ .twoCols{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
      overflow:hidden;
    }
    .panelHead{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;
      background:#f8fafc;
    }
    .panelHead h3{margin:0;font-size:14px;letter-spacing:-.1px}
    .panelBody{padding:0}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
    }
    thead th{
      position:sticky;top:0;
      background:#fff;
      z-index:1;
      text-align:left;
      font-size:12px;
      color:#475569;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      white-space:nowrap;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:hover td{background:#fbfdff}
    tbody tr:last-child td{border-bottom:0}
    .rank{font-weight:1000}
    .name{font-weight:1000}
    .small{font-size:12px;color:var(--muted)}
    .points{
      font-weight:1000;
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
    }
    .empty{
      padding:14px;
      border-top:1px dashed var(--border);
      color:var(--muted);
    }
    a:focus, button:focus, input:focus, select:focus{
      outline:3px solid rgba(37,99,235,.25);
      outline-offset:2px;
    }
  </style>
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points â€” Classement public</h1>
    <span class="pill"><span class="dot ok"></span><span id="pillCount">0</span> riders</span>
  </div>

  <nav>
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html" class="active">Classement</a>
    <a href="meetings.html">Ã‰vÃ©nements</a>
    <a href="events.html">Ã‰preuves</a>
    <a href="challengemtbpoints.html">Challenge</a>
    <a href="about.html">Ã€ propos</a>
  </nav>
</header>

<main class="wrap">
  <div class="card">
    <section class="hero">
      <div class="heroTop">
        <div style="min-width:280px;flex:1">
          <h2>Classement â€” Hommes / Femmes</h2>
          <p class="muted">
            Le classement cumule les points par rider (dâ€™aprÃ¨s <code>mtb.results.v1</code>).
            Choisis une vue en haut (GÃ©nÃ©ral / discipline) et filtre Ã  gauche.
          </p>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <span class="pill"><span class="dot"></span><span id="pillMode">GÃ©nÃ©ral</span></span>
          <span class="pill"><span class="dot"></span><span id="pillRows">0</span> rÃ©sultats</span>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>
    </section>

    <!-- Filters -->
    <div class="filters">
      <div class="spanAll" style="grid-column:1/2">
        <label for="q">Recherche rider</label>
        <input id="q" type="text" placeholder="Nom, email, nationalitÃ©â€¦" />
      </div>

      <div>
        <label for="nat">NationalitÃ©</label>
        <select id="nat"><option value="">Toutes</option></select>
      </div>

      <div>
        <label for="cat">CatÃ©gorie</label>
        <select id="cat"><option value="">Toutes</option></select>
      </div>

      <div>
        <label for="ageMin">Ã‚ge min</label>
        <input id="ageMin" type="number" min="0" placeholder="ex: 18" />
      </div>

      <div>
        <label for="ageMax">Ã‚ge max</label>
        <input id="ageMax" type="number" min="0" placeholder="ex: 49" />
      </div>

      <div>
        <label for="minPts">Points min</label>
        <input id="minPts" type="number" min="0" placeholder="ex: 100" />
      </div>

      <div>
        <label for="sortBy">Tri</label>
        <select id="sortBy">
          <option value="points_desc">Points â†“</option>
          <option value="points_asc">Points â†‘</option>
          <option value="name_asc">Nom Aâ†’Z</option>
        </select>
      </div>

      <div>
        <button class="btn primary" id="btnReset" type="button">RÃ©initialiser</button>
      </div>

      <div class="spanAll" style="grid-column:1/-1;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:6px;">
        <div class="muted">Affichage : <strong id="countShown">0</strong> riders</div>
        <div class="muted">Astuce : pour enrichir le classement, ajoute <code>sexe</code>/<code>age</code>/<code>nationality</code> dans lâ€™import.</div>
      </div>
    </div>

    <!-- Two columns H/F -->
    <div class="twoCols">
      <section class="panel">
        <div class="panelHead">
          <h3>ðŸ‘¨ Hommes</h3>
          <span class="pill"><span class="dot"></span><span id="countM">0</span></span>
        </div>
        <div class="panelBody">
          <table>
            <thead>
              <tr>
                <th style="width:56px;">#</th>
                <th>Rider</th>
                <th style="width:150px;">Cat / Ã‚ge</th>
                <th style="width:120px;">Nation</th>
                <th style="width:110px;">Points</th>
              </tr>
            </thead>
            <tbody id="tbodyM"></tbody>
          </table>
          <div id="emptyM" class="empty" style="display:none;">Aucun rider homme avec ces filtres.</div>
        </div>
      </section>

      <section class="panel">
        <div class="panelHead">
          <h3>ðŸ‘© Femmes</h3>
          <span class="pill"><span class="dot"></span><span id="countF">0</span></span>
        </div>
        <div class="panelBody">
          <table>
            <thead>
              <tr>
                <th style="width:56px;">#</th>
                <th>Rider</th>
                <th style="width:150px;">Cat / Ã‚ge</th>
                <th style="width:120px;">Nation</th>
                <th style="width:110px;">Points</th>
              </tr>
            </thead>
            <tbody id="tbodyF"></tbody>
          </table>
          <div id="emptyF" class="empty" style="display:none;">Aucune rider femme avec ces filtres.</div>
        </div>
      </section>
    </div>

  </div>
</main>

<script src="js/data.js"></script>
<script src="js/storage.js"></script>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const num = (x)=>{ const n = Number(String(x??"").replace(",", ".").trim()); return Number.isFinite(n) ? n : null; };

  // -------------------------
  // Load local datasets
  // -------------------------
  function safeJson(key){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; }catch(_){ return null; }
  }

  function listRacesSafe(){
    if (typeof window.listRaces === "function") return window.listRaces();
    if (typeof window.getRaces === "function") return window.getRaces();
    const arr = safeJson("mtb.races.v1");
    return Array.isArray(arr) ? arr : [];
  }

  function listMeetingsSafe(){
    if (typeof window.listMeetings === "function") return window.listMeetings();
    if (typeof window.getMeetings === "function") return window.getMeetings();
    const arr = safeJson("mtb.meetings.v1");
    return Array.isArray(arr) ? arr : [];
  }

  function listResultsSafe(){
    if (typeof window.listResults === "function") return window.listResults();
    if (typeof window.getResults === "function") return window.getResults();
    const arr = safeJson("mtb.results.v1");
    return Array.isArray(arr) ? arr : [];
  }

  // -------------------------
  // Normalization helpers
  // -------------------------
  function pick(obj, keys){
    for (const k of keys){
      if (obj && obj[k] != null && String(obj[k]).trim() !== "") return obj[k];
    }
    return null;
  }

  function normSex(v){
    const s = String(v||"").trim().toLowerCase();
    if (!s) return null;
    if (["m","h","homme","male","masculin"].includes(s)) return "M";
    if (["f","femme","female","feminin","fÃ©minin"].includes(s)) return "F";
    return null;
  }

  function normalizeResult(r){
    return {
      id: r?.id ?? null,
      raceId: r?.raceId ?? r?.race_id ?? r?.eventId ?? null,
      points: num(r?.points ?? r?.score ?? r?.mtbPoints) ?? 0,

      riderEmail: (pick(r, ["riderEmail","email","mail","e-mail"]) || "").toString().trim().toLowerCase() || null,
      riderName: (pick(r, ["riderName","name","nom","prenom","prÃ©nom","athlete","coureur"]) || "").toString().trim() || null,

      sex: normSex(pick(r, ["sex","gender","sexe"])),
      age: num(pick(r, ["age","Ã¢ge"])),

      category: (pick(r, ["category","cat","categorie","catÃ©gorie"]) || "").toString().trim() || null,
      nationality: (pick(r, ["nationality","nation","country","pays"]) || "").toString().trim() || null,
    };
  }

  function normalizeRace(r){
    return {
      id: r?.id ?? null,
      name: r?.name ?? r?.title ?? "Ã‰preuve",
      disc: (r?.disc ?? r?.discipline ?? "").toString().trim(),
      ebike: (r?.ebike ?? r?.isEbike ?? r?.eBike ?? null),
      date: r?.date ?? r?.startDate ?? null,
      meetingId: r?.meetingId ?? r?.meeting_id ?? null
    };
  }

  function isEbike(v){
    if (v == null) return null;
    const s = String(v).trim().toLowerCase();
    if (s === "1" || s === "true" || s === "yes") return true;
    if (s === "0" || s === "false" || s === "no") return false;
    return null;
  }

  // -------------------------
  // Tabs / modes
  // -------------------------
  const MODES = [
    { key:"general", label:"GÃ©nÃ©ral", disc:null, ebike:null },
    { key:"xc_m", label:"XC musculaire", disc:"XC", ebike:false },
    { key:"xc_e", label:"XC assistance Ã©lectrique", disc:"XC", ebike:true },
    { key:"dh", label:"DH", disc:"DH", ebike:null },
    { key:"enduro", label:"Enduro", disc:"Enduro", ebike:null },
    { key:"gravel", label:"Gravel", disc:"Gravel", ebike:null },
  ];

  let ACTIVE_MODE = "general";

  function buildTabs(){
    const root = $("tabs");
    root.innerHTML = "";
    for (const m of MODES){
      const b = document.createElement("button");
      b.type = "button";
      b.className = `tab ${m.key === ACTIVE_MODE ? "active" : ""}`;
      b.textContent = m.label;
      b.addEventListener("click", ()=>{
        ACTIVE_MODE = m.key;
        buildTabs();
        renderAll();
      });
      root.appendChild(b);
    }
  }

  // -------------------------
  // Aggregate riders
  // -------------------------
  const races = listRacesSafe().map(normalizeRace);
  const meetings = listMeetingsSafe();
  const results = listResultsSafe().map(normalizeResult).filter(x => x.raceId);

  const racesById = new Map(races.map(r => [r.id, r]));

  $("pillRows").textContent = String(results.length);

  function modeFilter(res){
    const mode = MODES.find(x => x.key === ACTIVE_MODE) || MODES[0];
    if (!mode) return true;

    const race = racesById.get(res.raceId);
    if (!race) return (mode.key === "general"); // si pas de race info, on ne peut pas filtrer discipline => only general

    if (mode.disc && String(race.disc||"").toLowerCase() !== String(mode.disc).toLowerCase()) return false;

    if (mode.ebike !== null){
      const e = isEbike(race.ebike);
      if (e === null) return false;
      if (e !== mode.ebike) return false;
    }
    return true;
  }

  function riderKey(res){
    // prioritÃ© email, sinon nom
    return res.riderEmail ? `email:${res.riderEmail}` : `name:${(res.riderName||"").toLowerCase()}`;
  }

  function aggregateRiders(){
    const map = new Map();

    for (const r of results){
      if (!modeFilter(r)) continue;

      const key = riderKey(r);
      if (!key || key.endsWith(":")) continue;

      if (!map.has(key)){
        map.set(key, {
          key,
          name: r.riderName || (r.riderEmail || "Rider"),
          email: r.riderEmail,
          sex: r.sex || null,
          age: r.age ?? null,
          category: r.category || null,
          nationality: r.nationality || null,
          points: 0,
          rows: 0
        });
      }
      const it = map.get(key);

      // enrichissement â€œbest effortâ€ si certaines lignes manquent
      it.name = it.name || r.riderName || it.email || "Rider";
      it.sex = it.sex || r.sex || null;
      it.age = (it.age == null && r.age != null) ? r.age : it.age;
      it.category = it.category || r.category || null;
      it.nationality = it.nationality || r.nationality || null;

      it.points += (num(r.points) ?? 0);
      it.rows += 1;
    }

    const arr = Array.from(map.values()).map(x => ({
      ...x,
      points: Math.round(x.points)
    }));

    return arr;
  }

  // -------------------------
  // Filters UI
  // -------------------------
  function fillFilterOptions(riders){
    // nationalitÃ©s / catÃ©gories
    const nats = Array.from(new Set(riders.map(r=> (r.nationality||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    const cats = Array.from(new Set(riders.map(r=> (r.category||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

    const natSel = $("nat");
    const catSel = $("cat");

    const keepNat = natSel.value;
    const keepCat = catSel.value;

    natSel.innerHTML = `<option value="">Toutes</option>` + nats.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("");
    catSel.innerHTML = `<option value="">Toutes</option>` + cats.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");

    if (keepNat) natSel.value = keepNat;
    if (keepCat) catSel.value = keepCat;
  }

  function applyFilters(riders){
    const q = ($("q").value || "").trim().toLowerCase();
    const nat = ($("nat").value || "").trim();
    const cat = ($("cat").value || "").trim();
    const ageMin = num($("ageMin").value);
    const ageMax = num($("ageMax").value);
    const minPts = num($("minPts").value) ?? 0;

    return riders.filter(r=>{
      if (q){
        const txt = `${r.name||""} ${r.email||""} ${r.nationality||""} ${r.category||""}`.toLowerCase();
        if (!txt.includes(q)) return false;
      }
      if (nat && (r.nationality||"") !== nat) return false;
      if (cat && (r.category||"") !== cat) return false;
      if ((r.points ?? 0) < minPts) return false;

      if (ageMin != null){
        if (r.age == null) return false;
        if (r.age < ageMin) return false;
      }
      if (ageMax != null){
        if (r.age == null) return false;
        if (r.age > ageMax) return false;
      }
      return true;
    });
  }

  function sortRiders(arr){
    const s = $("sortBy").value || "points_desc";
    const a = arr.slice();
    a.sort((x,y)=>{
      if (s === "points_desc") return (y.points||0) - (x.points||0);
      if (s === "points_asc") return (x.points||0) - (y.points||0);
      if (s === "name_asc") return String(x.name||"").toLowerCase().localeCompare(String(y.name||"").toLowerCase());
      return 0;
    });
    return a;
  }

  // -------------------------
  // Render two tables
  // -------------------------
  function renderTable(tbodyId, emptyId, list){
    const tb = $(tbodyId);
    const empty = $(emptyId);
    tb.innerHTML = "";

    if (!list.length){
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    list.forEach((r, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank">${idx + 1}</td>
        <td>
          <div class="name">${esc(r.name || "Rider")}</div>
          <div class="small">${r.email ? esc(r.email) : "â€”"}</div>
        </td>
        <td>
          <div><b>${esc(r.category || "â€”")}</b></div>
          <div class="small">Ã‚ge : ${r.age != null ? esc(String(r.age)) : "â€”"}</div>
        </td>
        <td>${esc(r.nationality || "â€”")}</td>
        <td class="points">${esc(String(r.points ?? 0))} pts</td>
      `;
      tb.appendChild(tr);
    });
  }

  function renderAll(){
    const mode = MODES.find(x=>x.key===ACTIVE_MODE) || MODES[0];
    $("pillMode").textContent = mode.label;

    const ridersAgg = aggregateRiders();
    $("pillCount").textContent = String(ridersAgg.length);

    // Fill filter options from current dataset
    fillFilterOptions(ridersAgg);

    let riders = applyFilters(ridersAgg);
    riders = sortRiders(riders);

    // Split M/F (si pas de sexe => on ne lâ€™affiche pas ici)
    const men = riders.filter(r => r.sex === "M");
    const women = riders.filter(r => r.sex === "F");

    $("countShown").textContent = String(riders.length);
    $("countM").textContent = String(men.length);
    $("countF").textContent = String(women.length);

    renderTable("tbodyM", "emptyM", men);
    renderTable("tbodyF", "emptyF", women);
  }

  // Reset
  $("btnReset").addEventListener("click", ()=>{
    $("q").value = "";
    $("nat").value = "";
    $("cat").value = "";
    $("ageMin").value = "";
    $("ageMax").value = "";
    $("minPts").value = "";
    $("sortBy").value = "points_desc";
    renderAll();
  });

  ["q","nat","cat","ageMin","ageMax","minPts","sortBy"].forEach(id=>{
    $(id).addEventListener("input", renderAll);
    $(id).addEventListener("change", renderAll);
  });

  buildTabs();
  renderAll();

})();
</script>
</body>
</html>
