<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MTB Points</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    :root{
      --bg:#f4f4f4;--card:#ffffff;--text:#0f172a;--muted:#667085;--border:#e5e7eb;
      --blue:#2563eb;--blue2:#1d4ed8;--shadow:0 10px 30px rgba(2,6,23,.10);
      --r:16px;
      --ok:#16a34a;--warn:#ea580c;--err:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}

    /* Header */
    header.header{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.90);
      backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    header.header h1{margin:0;font-size:18px;letter-spacing:.2px}
    nav{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    nav a{
      text-decoration:none;
      padding:8px 10px;
      border-radius:10px;
      color:var(--blue);
      font-weight:800;
      font-size:13px;
    }
    nav a:hover{background:#eff6ff}
    nav a.active{background:#eff6ff;color:var(--blue2)}
    .lang{display:flex;gap:8px;align-items:center}
    .lang .btn{
      padding:8px 10px;border-radius:10px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:900;font-size:12px;
    }

    /* Layout */
    .wrap{max-width:1100px;margin:26px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:14px;margin-top:14px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }

    /* Hero */
    .hero{
      border-radius:22px;
      padding:22px;
      border:1px solid var(--border);
      background:
        radial-gradient(1000px 260px at 15% 0%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(700px 220px at 95% 10%, rgba(16,185,129,.14), transparent 60%),
        #fff;
      box-shadow:var(--shadow);
    }
    .hero h2{margin:0;font-size:28px;letter-spacing:-.4px}
    .hero p{margin:10px 0 0 0;line-height:1.6;color:#334155}
    .heroActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}

    /* Buttons */
    .btn2{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 14px;border-radius:12px;text-decoration:none;
      border:1px solid var(--border);background:#fff;font-weight:900;color:var(--text);
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .btn2:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(2,6,23,.08);border-color:#dbeafe}
    .btn2.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn2.primary:hover{background:var(--blue2);border-color:var(--blue2)}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-size:12px;font-weight:900;color:#0f172a;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:14px}
    .kpi{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff}
    .kpi .big{font-size:18px;font-weight:900}
    .kpi .sub{font-size:12px;color:var(--muted);margin-top:4px}
    @media(max-width:700px){ .kpis{grid-template-columns:1fr} }

    /* Feature cards */
    .miniCard{border:1px solid var(--border);border-radius:16px;padding:14px;background:#fff}
    .miniCard h3{margin:0 0 6px 0;font-size:16px}
    .miniCard p{margin:0;color:#334155;line-height:1.55}
    .miniCard .muted{margin-top:6px}

    /* List */
    ul.clean{margin:10px 0 0 18px;color:#334155;line-height:1.6}
    .note{margin-top:12px;border:1px solid #fed7aa;background:#fff7ed;color:#9a3412;border-radius:14px;padding:12px}

    /* Footer */
    footer{margin-top:18px;color:var(--muted);font-size:12px}

    /* ============================= */
    /* APER√áUS horizontaux           */
    /* ============================= */
    .previewRow{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .preview{
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      padding:14px;
      box-shadow:0 2px 10px rgba(0,0,0,.05);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .preview:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 26px rgba(2,6,23,.08);
      border-color:#dbeafe;
    }
    .previewTop{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;
    }
    .previewTop h3{margin:0;font-size:16px;letter-spacing:-.2px}
    .previewTop .sub{margin-top:4px;color:#64748b;font-size:12px}
    .previewBadge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-size:12px;font-weight:900;color:#0f172a;
      white-space:nowrap;
    }
    .previewBody{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media(max-width:900px){ .previewBody{grid-template-columns:1fr} }

    .miniTable{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .miniTable .title{
      font-weight:900;font-size:13px;margin:0 0 8px 0;color:#0f172a;
      display:flex;align-items:center;gap:8px;
    }
    .miniList{margin:0;padding:0;list-style:none;display:grid;gap:8px}
    .miniItem{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      border:1px solid #eef2f7;border-radius:12px;padding:10px;
      background:#fff;
    }
    .miniItem .left{display:flex;gap:10px;align-items:center;min-width:0}
    .medal{font-size:16px}
    .name{
      font-weight:900;font-size:13px;color:#0f172a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:320px;
    }
    .rightScore{font-weight:900;font-size:13px;color:#0f172a;white-space:nowrap}
    .mutedSmall{color:#64748b;font-size:12px}
    .eventsGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
    }
    @media(max-width:900px){ .eventsGrid{grid-template-columns:1fr 1fr} }
    @media(max-width:520px){ .eventsGrid{grid-template-columns:1fr} }
    .eventCard{
      border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;
    }
    .eventCard .t{font-weight:900;font-size:13px;margin:0}
    .eventCard .m{margin-top:6px;color:#64748b;font-size:12px;line-height:1.4}
  </style>
</head>
<body>

<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points</h1>
    <span class="chip">Classement VTT multi-courses</span>
  </div>

  <nav>
    <a href="public-ranking.html">Classement</a>
    <a href="public-clubs.html">Clubs</a>
    <a href="meetings.html">√âv√©nements</a>
    <a href="challengemtbpoints.html">Challenge</a>
    <a href="reglement.html">R√®glement</a>
    <a href="methodologie.html">M√©thodologie</a>
    <a href="about.html">√Ä propos</a>
    <a href="contact.html">Contact</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="lang">
    <button class="btn" id="btnFR">FR</button>
    <button class="btn" id="btnEN">EN</button>
  </div>
</header>

<div class="wrap">

  <!-- HERO -->
  <section class="hero">
    <h2>Un classement VTT comparable entre courses</h2>
    <p>
      <strong>MTB Points</strong> transforme chaque √©preuve en un score objectif (physique + technique)
      √† partir de la trace <strong>GPX</strong> et de la cartographie <strong>OSM</strong>, puis attribue des points aux coureurs
      pour construire un classement public sur <strong>24 mois glissants</strong>.
    </p>

    <div class="chips">
      <span class="chip">GPX ‚Üí Distance & D+</span>
      <span class="chip">ScoreTech V2 Hybrid (OSM + bonus cap√©)</span>
      <span class="chip">Badges Challenge</span>
    </div>

    <div class="heroActions">
      <a class="btn2 primary" href="login.html">Je suis organisateur</a>
      <a class="btn2" href="public-ranking.html">Voir le classement</a>
      <a class="btn2" href="public-clubs.html">Voir les clubs</a>
      <a class="btn2" href="challengemtbpoints.html">Voir le challenge</a>
      <a class="btn2" href="contact.html">Nous contacter</a>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="big">24 mois</div>
        <div class="sub">fen√™tre glissante</div>
      </div>
      <div class="kpi">
        <div class="big">Physique + Technique</div>
        <div class="sub">score d‚Äô√©preuve (MRS)</div>
      </div>
      <div class="kpi">
        <div class="big">XC ‚Ä¢ Enduro ‚Ä¢ DH</div>
        <div class="sub">disciplines & cat√©gories</div>
      </div>
    </div>
  </section>

  <!-- APER√áUS -->
  <section class="previewRow" aria-label="Aper√ßus">
    <!-- 1) Classement -->
    <div class="preview" id="previewRanking" role="link" tabindex="0" title="Ouvrir le classement">
      <div class="previewTop">
        <div>
          <h3>Classement mondial ‚Äî Global</h3>
          <div class="sub">Top 3 Hommes / Femmes (aper√ßu)</div>
        </div>
        <span class="previewBadge">‚Üí Voir le classement</span>
      </div>

      <div class="previewBody">
        <div class="miniTable">
          <div class="title">üèÖ Hommes</div>
          <ul class="miniList" id="rankMen">
            <li class="miniItem"><div class="left"><span class="medal">‚Ä¶</span><span class="name">Chargement‚Ä¶</span></div><span class="rightScore">‚Äî</span></li>
          </ul>
        </div>

        <div class="miniTable">
          <div class="title">üèÖ Femmes</div>
          <ul class="miniList" id="rankWomen">
            <li class="miniItem"><div class="left"><span class="medal">‚Ä¶</span><span class="name">Chargement‚Ä¶</span></div><span class="rightScore">‚Äî</span></li>
          </ul>
        </div>
      </div>

      <div class="mutedSmall" id="rankHint" style="margin-top:10px">Source: Supabase</div>
    </div>

    <!-- 2) Challenge -->
    <div class="preview" id="previewChallenge" role="link" tabindex="0" title="Ouvrir le challenge">
      <div class="previewTop">
        <div>
          <h3>Challenge MTB Points</h3>
          <div class="sub">Top 3 (aper√ßu)</div>
        </div>
        <span class="previewBadge">‚Üí Voir le challenge</span>
      </div>

      <div class="previewBody" style="grid-template-columns:1fr;">
        <div class="miniTable">
          <div class="title">üî• Leaders</div>
          <ul class="miniList" id="challengeTop">
            <li class="miniItem"><div class="left"><span class="medal">‚Ä¶</span><span class="name">Chargement‚Ä¶</span></div><span class="rightScore">‚Äî</span></li>
          </ul>
        </div>
      </div>

      <div class="mutedSmall" id="challengeHint" style="margin-top:10px">Source: Supabase</div>
    </div>

    <!-- 3) √âv√©nements √† venir -->
    <div class="preview" id="previewMeetings" role="link" tabindex="0" title="Voir les √©v√©nements">
      <div class="previewTop">
        <div>
          <h3>√âv√©nements √† venir</h3>
          <div class="sub">Les 4 prochains meetings publi√©s</div>
        </div>
        <span class="previewBadge">‚Üí Voir tous les √©v√©nements</span>
      </div>

      <div class="eventsGrid" id="upcomingMeetings">
        <div class="eventCard"><p class="t">Chargement‚Ä¶</p><div class="m">‚Äî</div></div>
        <div class="eventCard"><p class="t">Chargement‚Ä¶</p><div class="m">‚Äî</div></div>
        <div class="eventCard"><p class="t">Chargement‚Ä¶</p><div class="m">‚Äî</div></div>
        <div class="eventCard"><p class="t">Chargement‚Ä¶</p><div class="m">‚Äî</div></div>
      </div>

      <div class="mutedSmall" id="meetingsHint" style="margin-top:10px">Source: Supabase</div>
    </div>

    <!-- 4) NEW: Classement clubs (AJOUT√â juste apr√®s ‚Äú√âv√©nements √† venir‚Äù) -->
    <div class="preview" id="previewClubs" role="link" tabindex="0" title="Voir le classement des clubs">
      <div class="previewTop">
        <div>
          <h3>Classement des clubs</h3>
          <div class="sub">Top 3 clubs (aper√ßu)</div>
        </div>
        <span class="previewBadge">‚Üí Voir le classement clubs</span>
      </div>

      <div class="previewBody" style="grid-template-columns:1fr;">
        <div class="miniTable">
          <div class="title">üèÅ Top Clubs</div>
          <ul class="miniList" id="clubsTop">
            <li class="miniItem"><div class="left"><span class="medal">‚Ä¶</span><span class="name">Chargement‚Ä¶</span></div><span class="rightScore">‚Äî</span></li>
          </ul>
        </div>
      </div>

      <div class="mutedSmall" id="clubsHint" style="margin-top:10px">Source: Supabase</div>
    </div>
  </section>

  <!-- CONTENT -->
  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <h3 style="margin:0;">Qu‚Äôest-ce que les points MTB ?</h3>
      <p class="muted" style="margin:8px 0 0 0;line-height:1.6;color:#334155">
        Les <strong>points MTB</strong> sont un syst√®me de classement pour les √©preuves de VTT.
        L‚Äôobjectif : comparer des performances sur des courses tr√®s diff√©rentes, avec un calcul bas√© sur des crit√®res objectifs :
        <strong>distance</strong>, <strong>d√©nivel√©</strong>, <strong>profil</strong> et <strong>terrain</strong>.
      </p>

      <h4 style="margin:14px 0 6px 0;">Pour les cyclistes</h4>
      <p style="margin:0;color:#334155;line-height:1.6;">
        Cumule des points selon tes r√©sultats. Le classement utilise une <strong>fen√™tre glissante de 24 mois</strong> et propose
        des filtres par <strong>√¢ge</strong>, <strong>sexe</strong> et <strong>discipline</strong>.
      </p>
      <ul class="clean">
        <li>Comparer ton niveau sur des courses diff√©rentes</li>
        <li>Suivre ta progression</li>
        <li>D√©bloquer des badges du <strong>Challenge MTB Points</strong></li>
      </ul>

      <h4 style="margin:14px 0 6px 0;">Pour les organisateurs</h4>
      <p style="margin:0;color:#334155;line-height:1.6;">
        Analyse ton parcours via la trace <strong>GPX</strong> : distance, D+, profil, et ScoreTech V2 (OSM).
        Publie ensuite tes r√©sultats et g√©n√®re une fiche √©preuve.
      </p>

      <div class="note">
        ‚úÖ Nouveau : une page d√©di√©e au <strong>Challenge</strong> avec badges (500 / 750 / 1000 / 2000).
      </div>

      <footer>
        Astuce : commence par cr√©er une √©preuve et importer un fichier GPX. Le ScoreTech V2 est calcul√© c√¥t√© serveur (OSM + cache).
        ‚Ä¢ <a href="contact.html" style="color:#2563eb;font-weight:900;text-decoration:none;">Contact</a>
      </footer>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="miniCard">
        <h3>Espace Organisateur</h3>
        <p>Cr√©er une √©preuve, analyser le GPX, importer les r√©sultats, publier le classement.</p>
        <div style="margin-top:10px">
          <a class="btn2 primary" href="login.html">Acc√©der</a>
        </div>
        <div class="muted" style="margin-top:8px;font-size:12px;">Connexion requise</div>
      </div>

      <div style="height:12px"></div>

      <div class="miniCard">
        <h3>Espace Cycliste</h3>
        <p>Consulter les √©preuves, le classement public, et suivre les badges du challenge.</p>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn2" href="public-ranking.html">Classement</a>
          <a class="btn2" href="public-clubs.html">Clubs</a>
          <a class="btn2" href="challengemtbpoints.html">Challenge</a>
        </div>
        <div class="muted" style="margin-top:8px;font-size:12px;">Acc√®s public</div>
      </div>

      <div style="height:12px"></div>

      <div class="miniCard">
        <h3>Raccourcis</h3>
        <p class="muted" style="margin:0 0 10px 0;">Pages cl√©s du projet</p>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <a class="btn2" href="meetings.html">√âv√©nements</a>
          <a class="btn2" href="public-clubs.html">Clubs</a>
          <a class="btn2" href="reglement.html">R√®glement</a>
          <a class="btn2" href="methodologie.html">M√©thodologie</a>
          <a class="btn2" href="about.html">√Ä propos</a>
          <a class="btn2" href="contact.html">Contact</a>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Chargement des aper√ßus depuis Supabase (+ fallback localStorage pour clubs si besoin) -->
<script type="module">
  import { supabase } from "./js/supabaseClient.js";

  const $ = (id) => document.getElementById(id);

  const medals = ["ü•á","ü•à","ü•â"];
  const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function bindOpen(el, href){
    if (!el) return;
    el.addEventListener("click", () => location.href = href);
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); location.href = href; }
    });
  }

  bindOpen($("previewRanking"), "public-ranking.html");
  bindOpen($("previewChallenge"), "challengemtbpoints.html");
  bindOpen($("previewMeetings"), "meetings.html");
  bindOpen($("previewClubs"), "public-clubs.html");

  function renderTopList(ul, rows, scoreKey="score", nameKey="name"){
    if (!ul) return;
    if (!rows || !rows.length){
      ul.innerHTML = `<li class="miniItem"><div class="left"><span class="medal">‚Äî</span><span class="name">Aucune donn√©e</span></div><span class="rightScore">‚Äî</span></li>`;
      return;
    }
    ul.innerHTML = rows.slice(0,3).map((r,i) => `
      <li class="miniItem">
        <div class="left">
          <span class="medal">${medals[i] || "‚Ä¢"}</span>
          <span class="name">${esc(r[nameKey] || "‚Äî")}</span>
        </div>
        <span class="rightScore">${Number.isFinite(Number(r[scoreKey])) ? Number(r[scoreKey]) : "‚Äî"}</span>
      </li>
    `).join("");
  }

  async function loadRankingPreview(){
    const menUl = $("rankMen");
    const womenUl = $("rankWomen");
    const hint = $("rankHint");

    try{
      const { data, error } = await supabase
        .from("v_public_ranking")
        .select("*")
        .order("score", { ascending: false })
        .limit(300);

      if (error) throw error;

      const rows = (data || []).map(r => ({
        name: r.name ?? `${r.last_name || ""} ${r.first_name || ""}`.trim(),
        sex: r.sex ?? null,
        score: Number(r.score ?? 0)
      }));

      const men = rows.filter(r => r.sex === "M").slice(0,3);
      const women = rows.filter(r => r.sex === "F").slice(0,3);

      renderTopList(menUl, men, "score");
      renderTopList(womenUl, women, "score");

      if (hint) hint.textContent = "Source: Supabase (v_public_ranking)";
    } catch(e){
      console.warn("[index] ranking preview failed", e);
      renderTopList(menUl, [], "score");
      renderTopList(womenUl, [], "score");
      if (hint) hint.textContent = "‚ö†Ô∏è Classement indisponible (vue absente / RLS / config).";
    }
  }

  async function loadChallengePreview(){
    const ul = $("challengeTop");
    const hint = $("challengeHint");

    const tryViews = [
      { view: "v_public_challenge_ranking", scoreKey: "score" },
      { view: "v_public_challenge_ranking", scoreKey: "points" },
      { view: "v_public_ranking", scoreKey: "score" }
    ];

    for (const t of tryViews){
      try{
        const { data, error } = await supabase
          .from(t.view)
          .select("*")
          .order(t.scoreKey, { ascending: false })
          .limit(10);

        if (error) throw error;

        const rows = (data || []).map(r => ({
          name: r.name ?? `${r.last_name || ""} ${r.first_name || ""}`.trim(),
          [t.scoreKey]: Number(r[t.scoreKey] ?? 0)
        }));

        renderTopList(ul, rows, t.scoreKey);
        if (hint) hint.textContent = `Source: Supabase (${t.view})`;
        return;
      } catch(e){
        // continue
      }
    }

    renderTopList(ul, [], "score");
    if (hint) hint.textContent = "‚ö†Ô∏è Challenge indisponible (vue absente / RLS / config).";
  }

  async function loadUpcomingMeetings(){
    const box = $("upcomingMeetings");
    const hint = $("meetingsHint");
    if (!box) return;

    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");
    const iso = `${yyyy}-${mm}-${dd}`;

    try{
      const { data, error } = await supabase
        .from("meetings")
        .select("id,name,date,location,is_published")
        .eq("is_published", true)
        .gte("date", iso)
        .order("date", { ascending: true })
        .limit(4);

      if (error) throw error;

      const meetings = data || [];
      if (!meetings.length){
        box.innerHTML = `<div class="eventCard"><p class="t">Aucun √©v√©nement √† venir</p><div class="m">Publie un meeting pour l‚Äôafficher ici.</div></div>`;
        if (hint) hint.textContent = "Source: Supabase (meetings)";
        return;
      }

      box.innerHTML = meetings.map(m => `
        <div class="eventCard">
          <p class="t">${esc(m.name || "‚Äî")}</p>
          <div class="m">üìÖ ${esc(m.date || "‚Äî")}<br/>üìç ${esc(m.location || "‚Äî")}</div>
        </div>
      `).join("");

      if (hint) hint.textContent = "Source: Supabase (meetings)";
    } catch(e){
      console.warn("[index] meetings preview failed", e);
      box.innerHTML = `<div class="eventCard"><p class="t">√âv√©nements indisponibles</p><div class="m">‚ö†Ô∏è Probl√®me Supabase (RLS/config).</div></div>`;
      if (hint) hint.textContent = "‚ö†Ô∏è √âv√©nements indisponibles (RLS/config).";
    }
  }

  function safeJson(key){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; }catch(_){ return null; }
  }

  async function loadClubsPreview(){
    const ul = $("clubsTop");
    const hint = $("clubsHint");

    function renderEmpty(message){
      if (!ul) return;
      ul.innerHTML = `<li class="miniItem"><div class="left"><span class="medal">‚Äî</span><span class="name">${esc(message)}</span></div><span class="rightScore">‚Äî</span></li>`;
    }

    function normalizeClubName(v){
      const s = String(v || "").trim();
      return s || null;
    }

    function riderKey(r){
      const email = String(r?.riderEmail ?? r?.email ?? "").trim().toLowerCase();
      const id = String(r?.riderId ?? r?.rider_id ?? r?.athlete_id ?? "").trim();
      const name = String(r?.riderName ?? r?.name ?? r?.nom ?? "").trim().toLowerCase();
      return email ? `email:${email}` : (id ? `id:${id}` : (name ? `name:${name}` : null));
    }

    // 1) Tentative Supabase via v_public_results (le mieux)
    try{
      const { data, error } = await supabase
        .from("v_public_results")
        .select("*")
        .limit(10000);

      if (error) throw error;

      const rows = data || [];
      const map = new Map();

      for (const r of rows){
        const club = normalizeClubName(r.club ?? r.team ?? r.equipe ?? r["√©quipe"] ?? r.club_name ?? r.team_name);
        if (!club) continue;

        const pts = Number(r.points ?? r.score ?? r.mtbPoints ?? 0) || 0;
        const key = club.toLowerCase();

        if (!map.has(key)){
          map.set(key, { club, points: 0, riders: new Set() });
        }
        const it = map.get(key);
        it.points += pts;

        const rk = riderKey(r);
        if (rk) it.riders.add(rk);
      }

      const list = Array.from(map.values())
        .map(x => ({ club: x.club, score: Math.round(x.points), riders: x.riders.size }))
        .sort((a,b) => b.score - a.score)
        .slice(0,3);

      if (!list.length){
        renderEmpty("Aucun club (champ club/team manquant dans les r√©sultats)");
        if (hint) hint.textContent = "Source: Supabase (v_public_results) ‚Äî club absent";
        return;
      }

      renderTopList(ul, list, "score", "club");
      if (hint) hint.textContent = "Source: Supabase (v_public_results)";
      return;
    } catch(e){
      // fallback local
    }

    // 2) Fallback localStorage mtb.results.v1
    try{
      const results = safeJson("mtb.results.v1");
      if (!Array.isArray(results) || !results.length){
        renderEmpty("Clubs indisponibles (pas de donn√©es)");
        if (hint) hint.textContent = "Source: localStorage (mtb.results.v1) ‚Äî vide";
        return;
      }

      const map = new Map();
      for (const r of results){
        const club = normalizeClubName(r.club ?? r.team ?? r.equipe ?? r["√©quipe"]);
        if (!club) continue;

        const pts = Number(String(r.points ?? r.score ?? r.mtbPoints ?? 0).replace(",", ".")) || 0;
        const key = club.toLowerCase();

        if (!map.has(key)){
          map.set(key, { club, points: 0, riders: new Set() });
        }
        const it = map.get(key);
        it.points += pts;

        const rk = riderKey(r);
        if (rk) it.riders.add(rk);
      }

      const list = Array.from(map.values())
        .map(x => ({ club: x.club, score: Math.round(x.points), riders: x.riders.size }))
        .sort((a,b) => b.score - a.score)
        .slice(0,3);

      if (!list.length){
        renderEmpty("Aucun club (ajoute le champ club/team dans les r√©sultats)");
        if (hint) hint.textContent = "Source: localStorage ‚Äî club absent";
        return;
      }

      renderTopList(ul, list, "score", "club");
      if (hint) hint.textContent = "Source: localStorage (mtb.results.v1)";
      return;
    } catch(e){
      console.warn("[index] clubs preview failed", e);
      renderEmpty("Clubs indisponibles");
      if (hint) hint.textContent = "‚ö†Ô∏è Clubs indisponibles (RLS/config/donn√©es).";
    }
  }

  await loadRankingPreview();
  await loadChallengePreview();
  await loadUpcomingMeetings();
  await loadClubsPreview();
</script>

</body>
</html>

