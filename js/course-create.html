<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cr√©er une √©preuve ‚Äî MTB Points</title>
  <link rel="stylesheet" href="./css/style.css" />
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points ‚Äî Cr√©er une √©preuve</h1>
    <span class="pill"><span class="dot ok"></span> √âpreuve rattach√©e</span>
  </div>

  <nav class="nav">
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html">√âv√©nements</a>
    <a href="events.html" class="active">√âpreuves</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="headerRight">
    <a class="btn ghost" id="btnBack" href="meetings.html">‚Üê Retour</a>
  </div>
</header>

<main class="wrap">
  <div class="card">

    <!-- HERO -->
    <section class="hero">
      <div class="heroTop">
        <div style="min-width:280px;flex:1">
          <h2>Nouvelle √©preuve</h2>
          <div class="heroMeta">
            Une √©preuve <b>doit</b> appartenir √† un √©v√©nement. La date est pr√©-remplie √† partir de l‚Äô√©v√©nement
            (et born√©e si l‚Äô√©v√©nement dure plusieurs jours).
          </div>
          <div id="meetingHint" class="heroDesc"></div>
        </div>

        <div class="heroActions">
          <span class="pill"><span class="dot"></span> GPX optionnel</span>
          <span class="pill"><span class="dot ok"></span> Meeting obligatoire</span>
        </div>
      </div>
    </section>

    <!-- STATUS (GPX) -->
    <div id="statusBox" class="empty" style="display:none; margin-top:14px;">
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <span class="pill" id="statusPhase"><span class="dot"></span> ‚Äî</span>
        <span id="statusMsg" class="muted">‚Äî</span>
      </div>
      <div class="bar" style="margin-top:10px; display:none;" id="statusBarWrap" aria-label="progress">
        <div id="statusBar"></div>
      </div>
      <div class="muted" style="font-size:12px; margin-top:8px;" id="statusSub"></div>
    </div>

    <!-- FORM -->
    <h3 class="sectionTitle" style="margin-top:18px;">Rattachement & date</h3>

    <div class="filters" style="grid-template-columns: 1.3fr 1fr 1fr; align-items:end;">
      <div class="spanAll" style="grid-column:1/2">
        <label for="meetingId">√âv√©nement *</label>
        <select id="meetingId"></select>
        <div class="muted" style="font-size:12px; margin-top:6px;">
          Une √©preuve ne peut pas exister sans √©v√©nement.
        </div>
      </div>

      <div>
        <label for="date">Date de l‚Äô√©preuve *</label>
        <input id="date" type="date" />
        <div class="muted" style="font-size:12px; margin-top:6px;" id="dateHint">
          La date est pr√©-remplie √† partir de l‚Äô√©v√©nement.
        </div>
      </div>

      <div>
        <label for="time">Heure (optionnel)</label>
        <input id="time" type="time" />
      </div>
    </div>

    <h3 class="sectionTitle" style="margin-top:18px;">Infos √©preuve</h3>

    <div class="filters" style="grid-template-columns: 1.4fr 1fr 1fr 1fr; align-items:end;">
      <div class="spanAll" style="grid-column:1/3">
        <label for="name">Nom de l‚Äô√©preuve *</label>
        <input id="name" type="text" placeholder="Ex: Sp√©ciale 1 ‚Äî Roc Noir / XC 45km / etc." />
      </div>

      <div>
        <label for="disc">Discipline</label>
        <select id="disc">
          <option value="">Auto</option>
          <option value="XC">XC</option>
          <option value="Enduro">Enduro</option>
          <option value="DH">DH</option>
          <option value="Gravel">Gravel</option>
          <option value="Marathon">Marathon</option>
          <option value="Ultra">Ultra</option>
        </select>
      </div>

      <div>
        <label for="ebike">Type v√©lo</label>
        <select id="ebike">
          <option value="0">Musculaire</option>
          <option value="1">Assistance √©lectrique</option>
        </select>
      </div>

      <div>
        <label for="distanceKm">Distance (km)</label>
        <input id="distanceKm" type="number" step="0.1" min="0" placeholder="ex: 42.5" />
      </div>

      <div>
        <label for="dplusM">D+ (m)</label>
        <input id="dplusM" type="number" step="1" min="0" placeholder="ex: 1200" />
      </div>

      <div>
        <label for="participants">Participants</label>
        <input id="participants" type="number" step="1" min="0" placeholder="ex: 250" />
      </div>

      <div class="spanAll" style="grid-column:1/-1">
        <label for="comment">Commentaire</label>
        <input id="comment" type="text" placeholder="Optionnel (infos parcours, m√©t√©o, etc.)" />
      </div>
    </div>

    <h3 class="sectionTitle" style="margin-top:18px;">GPX (optionnel)</h3>

    <div class="filters" style="grid-template-columns: 1.4fr 1fr 1fr; align-items:end;">
      <div class="spanAll" style="grid-column:1/2">
        <label for="gpxFile">Fichier GPX</label>
        <input id="gpxFile" type="file" accept=".gpx,application/gpx+xml,text/xml,application/xml" />
        <div class="muted" style="font-size:12px; margin-top:6px;">
          Si tu importes un GPX : distance/D+ seront pr√©-remplis + ScorePhys calcul√©.
          Le ScoreTech ‚Äúofficiel‚Äù d√©pend d‚Äôun serveur (d√©sactiv√© sur GitHub Pages).
        </div>
      </div>

      <div>
        <button class="btn" id="btnAnalyze" type="button">Analyser GPX</button>
      </div>

      <div>
        <button class="btn ghost" id="btnClearGPX" type="button">Effacer GPX</button>
      </div>
    </div>

    <div class="kpiGrid" style="margin-top:14px;">
      <div class="kpi">
        <div class="kpiLabel">ScorePhys</div>
        <div class="kpiValue"><span id="kpiPhys">‚Äî</span><span class="muted"> /100</span></div>
        <div class="kpiSub" id="kpiPhysSub">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">ScoreTech</div>
        <div class="kpiValue"><span id="kpiTech">‚Äî</span><span class="muted"> /100</span></div>
        <div class="kpiSub" id="kpiTechSub">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">Score Global</div>
        <div class="kpiValue"><span id="kpiGlobal">‚Äî</span><span class="muted"> /100</span></div>
        <div class="kpiSub" id="kpiGlobalSub">‚Äî</div>
      </div>
    </div>

    <div class="hintRow" style="margin-top:14px;">
      <div class="muted">* Champs obligatoires</div>
      <div class="muted" id="saveHint">Astuce : tu peux cr√©er plusieurs √©preuves pour le m√™me √©v√©nement.</div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px;">
      <button class="btn primary" id="btnSave" type="button">Cr√©er l‚Äô√©preuve</button>
      <button class="btn" id="btnSaveAndNew" type="button">Cr√©er + ajouter une autre √©preuve</button>
      <button class="btn ghost" id="btnReset" type="button">R√©initialiser</button>
    </div>

    <!-- ‚úÖ NOUVEAU : bouton apr√®s enregistrement -->
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <a class="btn ok" id="btnViewRace" href="#" style="display:none;">
        üëÅÔ∏è Voir la fiche √©preuve
      </a>
    </div>

    <div id="msg" class="empty" style="display:none; margin-top:14px;"></div>

  </div>
</main>

<!-- deps -->
<script src="js/data.js"></script>
<script src="js/storage.js"></script>
<script src="js/gpx.js"></script>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const params = new URLSearchParams(location.search);

  // -------------------- UI helpers --------------------
  function showMsg(html, ok=true){
    const el = $("msg");
    if (!el) return;
    el.style.display = html ? "block" : "none";
    el.innerHTML = html ? (ok ? `‚úÖ ${html}` : `‚ùå ${html}`) : "";
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function showStatusBox(on){
    const box = $("statusBox");
    if (box) box.style.display = on ? "block" : "none";
  }

  function setStatusUI(phase, message, progress){
    showStatusBox(true);
    const phaseEl = $("statusPhase");
    const msgEl = $("statusMsg");
    const subEl = $("statusSub");
    const barWrap = $("statusBarWrap");
    const bar = $("statusBar");

    const dotClass = phase === "error" ? "err" : (phase === "done" ? "ok" : (phase === "osm" ? "warn" : ""));
    if (phaseEl) phaseEl.innerHTML = `<span class="dot ${dotClass}"></span> ${esc(phase || "‚Äî")}`;
    if (msgEl) msgEl.textContent = message || "‚Äî";

    const hasProgress = typeof progress === "number" && progress >= 0 && progress <= 1;
    if (barWrap) barWrap.style.display = hasProgress ? "block" : "none";
    if (bar && hasProgress) bar.style.width = Math.round(progress * 100) + "%";

    if (subEl){
      if (phase === "gpx") subEl.textContent = "Analyse locale du GPX‚Ä¶";
      else if (phase === "osm") subEl.textContent = "Analyse serveur OSM (peut √©chouer sur GitHub Pages si backend indisponible).";
      else if (phase === "done") subEl.textContent = "Analyse termin√©e.";
      else if (phase === "error") subEl.textContent = "Une erreur est survenue.";
      else subEl.textContent = "";
    }
  }

  // -------------------- storage helpers (meetings/races) --------------------
  function listMeetingsSafe(){
    if (typeof window.loadMeetings === "function") return window.loadMeetings();
    if (typeof window.listMeetings === "function") return window.listMeetings();
    if (typeof window.getMeetings === "function") return window.getMeetings();
    try {
      const raw = localStorage.getItem("mtb.meetings.v1");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch(_){ return []; }
  }

  function findMeetingSafe(id){
    if (!id) return null;
    if (typeof window.findMeeting === "function") return window.findMeeting(id);
    const all = listMeetingsSafe();
    return all.find(m => m && m.id === id) || null;
  }

  function saveMeetingsSafe(arr){
    if (typeof window.saveMeetings === "function") return window.saveMeetings(arr);
    try { localStorage.setItem("mtb.meetings.v1", JSON.stringify(arr || [])); } catch(_){}
  }

  function upsertMeetingSafe(meeting){
    if (!meeting || !meeting.id) return;
    if (typeof window.updateMeeting === "function") return window.updateMeeting(meeting);

    const key = "mtb.meetings.v1";
    let all = [];
    try {
      const raw = localStorage.getItem(key);
      all = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(all)) all = [];
    } catch(_){ all = []; }

    const idx = all.findIndex(m => m && m.id === meeting.id);
    if (idx >= 0) all[idx] = meeting;
    else all.unshift(meeting);

    saveMeetingsSafe(all);
  }

  function listRacesSafe(){
    if (typeof window.loadStoredEvents === "function") return window.loadStoredEvents();
    try {
      const raw = localStorage.getItem("mtb.races.v1");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch(_){ return []; }
  }

  function saveRacesSafe(arr){
    if (typeof window.saveStoredEvents === "function") return window.saveStoredEvents(arr);
    try { localStorage.setItem("mtb.races.v1", JSON.stringify(arr || [])); } catch(_){}
  }

  function upsertRaceSafe(race){
    if (!race || !race.id) return race;
    if (typeof window.addStoredEvent === "function") {
      // ton storage.js peut d√©j√† g√©rer
      window.addStoredEvent(race);
      return race;
    }
    const all = listRacesSafe();
    const idx = all.findIndex(r => r && r.id === race.id);
    if (idx >= 0) all[idx] = race;
    else all.unshift(race);
    saveRacesSafe(all);
    return race;
  }

  function makeIdFromName(name){
    const slug = String(name || "")
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "")
      .slice(0, 60) || "race";
    return `${slug}-${Date.now()}`;
  }

  // -------------------- bouton "Voir la fiche √©preuve" --------------------
  function showViewRaceBtn(raceId){
    const a = $("btnViewRace");
    if (!a || !raceId) return;
    a.href = `race.html?id=${encodeURIComponent(raceId)}`;
    a.style.display = "inline-flex";
  }
  function hideViewRaceBtn(){
    const a = $("btnViewRace");
    if (!a) return;
    a.style.display = "none";
    a.href = "#";
  }

  // -------------------- meeting -> default date + min/max --------------------
  function applyMeetingDefaults(mid){
    const m = findMeetingSafe(mid);
    const hint = $("meetingHint");
    const dateEl = $("date");
    const dateHint = $("dateHint");
    const back = $("btnBack");

    if (!m){
      if (hint) hint.innerHTML = `‚ö†Ô∏è √âv√©nement introuvable. Choisis-en un dans la liste.`;
      if (dateEl){ dateEl.min = ""; dateEl.max = ""; }
      if (dateHint) dateHint.textContent = "La date sera pr√©-remplie √† partir de l‚Äô√©v√©nement.";
      if (back) back.href = "meetings.html";
      return;
    }

    const start = m.date || null;
    const end = m.endDate || null;

    if (hint){
      const range = end ? `${esc(start)} ‚Üí ${esc(end)}` : esc(start || "‚Äî");
      hint.innerHTML = `<b>${esc(m.name)}</b> ‚Ä¢ ${esc(m.location || "Lieu non pr√©cis√©")} ‚Ä¢ Dates: <b>${range}</b>`;
    }

    if (dateEl){
      dateEl.min = start || "";
      dateEl.max = end || "";

      if (!dateEl.value && start) dateEl.value = start;
      if (start && dateEl.value && dateEl.value < start) dateEl.value = start;
      if (end && dateEl.value && dateEl.value > end) dateEl.value = start || end;
    }

    if (dateHint){
      dateHint.textContent = end
        ? "√âv√©nement multi-jours : la date de l‚Äô√©preuve doit √™tre dans la plage."
        : "√âv√©nement 1 jour : date de l‚Äô√©preuve = date de l‚Äô√©v√©nement (par d√©faut).";
    }

    if (back) back.href = `meeting.html?id=${encodeURIComponent(m.id)}`;
  }

  // -------------------- init meeting select --------------------
  function initMeetingSelect(){
    const sel = $("meetingId");
    if (!sel) return;

    const meetings = listMeetingsSafe();
    sel.innerHTML = `<option value="">‚Äî Choisir un √©v√©nement ‚Äî</option>` +
      meetings.map(m => `<option value="${esc(m.id)}">${esc(m.name)}${m.date ? ` (${esc(m.date)})` : ""}</option>`).join("");

    const mid = params.get("meetingId") || params.get("eventGroupId") || "";
    if (mid){
      sel.value = mid;
      applyMeetingDefaults(mid);
    }
  }

  // -------------------- GPX handling --------------------
  let GPX_CACHE = null;

  function setKpi(id, val){
    const el = $(id);
    if (!el) return;
    el.textContent = (val == null || val === "") ? "‚Äî" : String(val);
  }

  function updateScoreUI(gpxRes){
    // gpx.js (frontend) renvoie physScore local + (optionnel) tech serveur
    const phys = gpxRes?.phys?.score ?? gpxRes?.physScore ?? gpxRes?.phys ?? null;
    const tech = gpxRes?.tech?.techScore ?? gpxRes?.techScore ?? null;

    setKpi("kpiPhys", (Number.isFinite(Number(phys)) ? Math.round(Number(phys)) : "‚Äî"));
    setKpi("kpiTech", (Number.isFinite(Number(tech)) ? Math.round(Number(tech)) : "‚Äî"));

    const global =
      (Number.isFinite(Number(phys)) && Number.isFinite(Number(tech)))
        ? Math.round(0.55 * Number(phys) + 0.45 * Number(tech))
        : null;

    setKpi("kpiGlobal", (global == null ? "‚Äî" : global));

    // sub hints
    const ps = $("kpiPhysSub");
    const ts = $("kpiTechSub");
    const gs = $("kpiGlobalSub");
    if (ps) ps.textContent = GPX_CACHE?.hasElevation ? "Phys: effort + pente (GPX)" : "Phys: effort (altitude indisponible)";
    if (ts) ts.textContent = Number.isFinite(Number(tech)) ? "Tech: OSM Hybrid (si serveur dispo)" : "Tech: ‚Äî (serveur indisponible)";
    if (gs) gs.textContent = (global == null) ? "Global: ‚Äî" : "Global: mix Phys/Tech";
  }

  async function analyzeGpxFromInput(){
    const input = $("gpxFile");
    const file = input?.files?.[0];
    if (!file) { showMsg("Choisis un fichier GPX.", false); return; }
    if (typeof window.analyzeGPX !== "function") {
      showMsg("Erreur: analyzeGPX() introuvable. V√©rifie js/gpx.js.", false);
      return;
    }

    hideViewRaceBtn();
    showMsg("", true);

    try{
      const res = await window.analyzeGPX(file, { keepPoints: false });

      // normalize
      const distanceKm = res?.distanceKm ?? res?.stats?.distanceKm ?? null;
      const dplusM = res?.dplusM ?? res?.stats?.dplusM ?? null;
      const hasElevation = (res?.hasElevation ?? res?.stats?.hasElevation) ? true : false;

      if (distanceKm != null) $("distanceKm").value = String(distanceKm);
      if (dplusM != null) $("dplusM").value = String(dplusM);

      GPX_CACHE = {
        fileName: file.name,
        distanceKm,
        dplusM,
        hasElevation,
        raw: res
      };

      updateScoreUI(res);
      showMsg(`GPX analys√© : ${String(distanceKm ?? "‚Äî").replace(".", ",")} km ‚Ä¢ D+ ${dplusM ?? "‚Äî"} m`, true);
    } catch(e){
      GPX_CACHE = null;
      updateScoreUI(null);
      showMsg(e?.message || "Erreur analyse GPX", false);
    }
  }

  function clearGpx(){
    const input = $("gpxFile");
    if (input) input.value = "";
    GPX_CACHE = null;
    $("distanceKm").value = "";
    $("dplusM").value = "";
    setKpi("kpiPhys", "‚Äî"); setKpi("kpiTech", "‚Äî"); setKpi("kpiGlobal", "‚Äî");
    const ps = $("kpiPhysSub"); const ts = $("kpiTechSub"); const gs = $("kpiGlobalSub");
    if (ps) ps.textContent = "‚Äî";
    if (ts) ts.textContent = "‚Äî";
    if (gs) gs.textContent = "‚Äî";
    showStatusBox(false);
    showMsg("GPX effac√©.", true);
  }

  // √âcoute l'UI status √©mise par gpx.js
  window.addEventListener("mtb:status", (e) => {
    const d = e?.detail || {};
    setStatusUI(d.phase || "‚Äî", d.message || "‚Äî", d.progress);
  });

  // -------------------- save logic --------------------
  function getVal(id){ return ($ (id)?.value || "").trim(); }
  function getNum(id){
    const s = getVal(id);
    if (!s) return null;
    const n = Number(String(s).replace(",", "."));
    return Number.isFinite(n) ? n : null;
  }

  function validate(){
    const meetingId = getVal("meetingId");
    const date = getVal("date");
    const name = getVal("name");
    if (!meetingId) return "√âv√©nement obligatoire.";
    if (!date) return "Date obligatoire.";
    if (!name) return "Nom de l‚Äô√©preuve obligatoire.";
    return null;
  }

  function buildRace(){
    const meetingId = getVal("meetingId");
    const name = getVal("name");
    const id = makeIdFromName(name);

    return {
      id,
      meetingId,            // pour ta page meeting/race
      eventGroupId: meetingId, // compat si tu utilises ce champ ailleurs
      date: getVal("date"),
      time: getVal("time") || null,

      name,
      disc: getVal("disc") || null,
      ebike: (getVal("ebike") === "1"),

      distanceKm: getNum("distanceKm"),
      dplusM: getNum("dplusM"),
      participants: getNum("participants"),
      comment: getVal("comment") || null,

      gpx: GPX_CACHE ? {
        fileName: GPX_CACHE.fileName,
        distanceKm: GPX_CACHE.distanceKm,
        dplusM: GPX_CACHE.dplusM,
        hasElevation: GPX_CACHE.hasElevation,
        // tu peux stocker plus tard res.raw si tu veux (profil/carte)
      } : null,

      createdAt: Date.now()
    };
  }

  function attachRaceToMeeting(race){
    const m = findMeetingSafe(race.meetingId);
    if (!m) return;
    m.raceIds = Array.isArray(m.raceIds) ? m.raceIds : [];
    if (!m.raceIds.includes(race.id)) m.raceIds.push(race.id);
    upsertMeetingSafe(m);
  }

  function resetForm(keepMeeting=true){
    const keepMid = keepMeeting ? getVal("meetingId") : "";
    const keepDate = keepMeeting ? getVal("date") : "";

    $("name").value = "";
    $("disc").value = "";
    $("ebike").value = "0";
    $("distanceKm").value = "";
    $("dplusM").value = "";
    $("participants").value = "";
    $("comment").value = "";
    $("time").value = "";

    clearGpx();
    hideViewRaceBtn();
    showMsg("", true);

    if (keepMeeting) {
      $("meetingId").value = keepMid;
      $("date").value = keepDate;
      applyMeetingDefaults(keepMid);
    }
  }

  async function doSave(thenNew){
    hideViewRaceBtn();
    const err = validate();
    if (err){ showMsg(err, false); return; }

    const race = buildRace();
    upsertRaceSafe(race);
    attachRaceToMeeting(race);

    showMsg(`√âpreuve cr√©√©e : <b>${esc(race.name)}</b>`, true);
    showViewRaceBtn(race.id);

    if (thenNew){
      // on garde meeting + date, on pr√©pare pour une autre √©preuve
      setTimeout(() => resetForm(true), 50);
    }
  }

  // -------------------- wire events --------------------
  function wire(){
    initMeetingSelect();

    const sel = $("meetingId");
    if (sel) sel.addEventListener("change", () => applyMeetingDefaults(sel.value));

    const btnAnalyze = $("btnAnalyze");
    if (btnAnalyze) btnAnalyze.addEventListener("click", analyzeGpxFromInput);

    const btnClear = $("btnClearGPX");
    if (btnClear) btnClear.addEventListener("click", clearGpx);

    const btnSave = $("btnSave");
    if (btnSave) btnSave.addEventListener("click", () => doSave(false));

    const btnSaveAndNew = $("btnSaveAndNew");
    if (btnSaveAndNew) btnSaveAndNew.addEventListener("click", () => doSave(true));

    const btnReset = $("btnReset");
    if (btnReset) btnReset.addEventListener("click", () => resetForm(true));

    // meetingId depuis URL -> s√©lection + date born√©e
    const mid = params.get("meetingId") || params.get("eventGroupId");
    if (mid && $("meetingId")){
      $("meetingId").value = mid;
      applyMeetingDefaults(mid);
    }
  }

  wire();
})();
</script>

</body>
</html>
