<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cr√©er une √©preuve ‚Äî MTB Points</title>
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/theme-nature.css">
  <style>
    :root{
      --bg:#f4f4f4;--card:#ffffff;--text:#0f172a;--muted:#667085;--border:#e5e7eb;
      --blue:#2563eb;--blue2:#1d4ed8;--shadow:0 10px 30px rgba(2,6,23,.10);
      --r:16px;
      --ok:#16a34a;--warn:#ea580c;--err:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}

    /* Header (style index) */
    header.header{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.90);
      backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    header.header h1{margin:0;font-size:18px;letter-spacing:.2px}
    nav{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    nav a{
      text-decoration:none;
      padding:8px 10px;
      border-radius:10px;
      color:var(--blue);
      font-weight:800;
      font-size:13px;
    }
    nav a:hover{background:#eff6ff}
    nav a.active{background:#eff6ff;color:var(--blue2)}
    .headerRight{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-size:12px;font-weight:900;color:#0f172a;
      white-space:nowrap;
    }

    /* Layout */
    .wrap{max-width:1100px;margin:26px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .muted{color:var(--muted)}
    .muted2{color:#64748b;font-size:12px}
    .req{color:var(--err);font-weight:900}

    /* Hero (style index) */
    .hero{
      border-radius:22px;
      padding:22px;
      border:1px solid var(--border);
      background:
        radial-gradient(1000px 260px at 15% 0%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(700px 220px at 95% 10%, rgba(16,185,129,.14), transparent 60%),
        #fff;
      box-shadow:var(--shadow);
    }
    .heroTop{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .hero h2{margin:0;font-size:26px;letter-spacing:-.4px}
    .heroMeta{margin-top:10px;line-height:1.6;color:#334155}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* Buttons (style index) */
    .btn2{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 14px;border-radius:12px;text-decoration:none;
      border:1px solid var(--border);background:#fff;font-weight:900;color:var(--text);
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      cursor:pointer;
    }
    .btn2:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(2,6,23,.08);border-color:#dbeafe}
    .btn2.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn2.primary:hover{background:var(--blue2);border-color:var(--blue2)}
    .btn2.ghost{background:#fff}
    .btn2.ok{background:var(--ok);border-color:var(--ok);color:#fff}
    .btn2.warn{background:var(--warn);border-color:var(--warn);color:#fff}
    .btn2:disabled{opacity:.65;cursor:not-allowed;transform:none;box-shadow:none}

    /* Form */
    .sectionTitle{margin:18px 0 10px 0;font-size:14px;font-weight:900;color:#0f172a}
    .filters{display:grid;gap:12px}
    .lbl{display:block;font-weight:900;font-size:12px;margin-bottom:6px}
    .inp{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      outline:none;
      font-size:14px;
    }
    textarea.inp{resize:vertical}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media(max-width:900px){.grid4{grid-template-columns:1fr 1fr}}
    @media(max-width:520px){.grid4{grid-template-columns:1fr}}
    .rowBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}

    /* Status box */
    .statusBox{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background:#fff;
      margin-top:14px;
    }
    .statusRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:999px;background:#94a3b8;display:inline-block}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-size:12px;font-weight:900;color:#0f172a;
    }
    .bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar > div{height:100%;width:0%;background:var(--blue);border-radius:999px;transition:width .25s}

    /* Messages */
    .msg{
      display:none;
      margin-top:14px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:12px;
      line-height:1.55;
    }

    /* Multi-laps grid */
    .ageBox{border:1px solid var(--border);border-radius:16px;padding:12px;background:#fff}
    .ageHead{display:grid;grid-template-columns: 1fr 120px 120px;gap:10px;font-weight:900;color:#0f172a}
    .ageRow{display:grid;grid-template-columns: 1fr 120px 120px;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed #e5e7eb}
    .ageRow:last-child{border-bottom:0}
    .ageRow label{display:flex;gap:10px;align-items:flex-start;cursor:pointer}
    .ageRow input[type="checkbox"]{margin-top:3px}
    .ageRow input[type="number"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px}
    .toggleLine{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px}
  </style>
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points</h1>
    <span class="chip">Cr√©er une √©preuve</span>
  </div>

  <nav>
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="public-clubs.html">Clubs</a>
    <a href="meetings.html">√âv√©nements</a>
    <a href="races.html" class="active">√âpreuves</a>
    <a href="challengemtbpoints.html">Challenge</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="headerRight">
    <a class="btn2 ghost" id="btnBack" href="meetings.html">‚Üê Retour</a>
  </div>
</header>

<main class="wrap">
  <div class="card">

    <section class="hero">
      <div class="heroTop">
        <div style="min-width:280px;flex:1">
          <h2>Nouvelle √©preuve</h2>
          <div class="heroMeta">
            L‚Äô√©preuve est rattach√©e √† un √©v√©nement. La date est pr√©-remplie et born√©e selon la plage de l‚Äô√©v√©nement.
            <br><span class="muted2" id="meetingHint"></span>
          </div>
          <div class="chips">
            <span class="chip">Multi-tours √¢ge/sexe</span>
            <span class="chip">GPX/OSM obligatoire</span>
            <span class="chip">Duplication Musculaire ‚Üî E-bike</span>
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <a class="btn2" href="meeting-create.html">+ Cr√©er un √©v√©nement</a>
        </div>
      </div>
    </section>

    <!-- RATTACHEMENT -->
    <h3 class="sectionTitle">Rattachement & date</h3>
    <div class="filters" style="grid-template-columns: 1.4fr 1fr 1fr; align-items:end;">
      <div>
        <label class="lbl">√âv√©nement <span class="req">*</span></label>
        <select id="meetingId" class="inp"></select>
        <div class="muted2">Les √©preuves cr√©√©es ici seront rattach√©es automatiquement.</div>
      </div>
      <div>
        <label class="lbl">Date de l‚Äô√©preuve <span class="req">*</span></label>
        <input id="date" class="inp" type="date" />
      </div>
      <div>
        <label class="lbl">Heure de d√©part</label>
        <input id="time" class="inp" type="time" />
      </div>
    </div>

    <!-- BLOC 1 : INFORMATIONS -->
    <h3 class="sectionTitle">Bloc 1 ‚Äî Informations</h3>

    <div class="filters" style="grid-template-columns: 1.4fr 1fr 1fr; align-items:end;">
      <div>
        <label class="lbl">Nom de l‚Äô√©preuve <span class="req">*</span></label>
        <input id="name" class="inp" type="text" placeholder="Ex : 20 km / 30 km / XCO Open..." />
      </div>

      <div>
        <label class="lbl">Barri√®re horaire (optionnel)</label>
        <input id="cutoff" class="inp" type="text" placeholder="Ex : 02:30" />
      </div>

      <div>
        <label class="lbl">Cat√©gorie d‚Äô√©preuve</label>
        <select id="level" class="inp">
          <option value="">‚Äî</option>
          <option value="Locale">Locale</option>
          <option value="R√©gionale">R√©gionale</option>
          <option value="Nationale">Nationale</option>
          <option value="Internationale">Internationale</option>
        </select>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <div>
        <label class="lbl">Discipline</label>
        <select id="disc" class="inp">
          <option value="">‚Äî</option>
          <option value="XC">XC</option>
          <option value="Enduro">Enduro</option>
          <option value="DH">DH</option>
          <option value="Marathon">Marathon</option>
          <option value="Ultra">Ultra</option>
          <option value="Gravel">Gravel</option>
        </select>
      </div>
      <div>
        <label class="lbl">Type de v√©lo</label>
        <select id="ebike" class="inp">
          <option value="0">Musculaire</option>
          <option value="1">Assistance √©lectrique</option>
        </select>
        <div class="muted2">Musculaire et E-bike peuvent partager le m√™me parcours (classements s√©par√©s).</div>
      </div>
    </div>

    <div class="grid4" style="margin-top:12px;">
      <div>
        <label class="lbl">Lavage v√©los</label>
        <select id="wash" class="inp">
          <option value="">‚Äî</option>
          <option value="Oui">Oui</option>
          <option value="Non">Non</option>
        </select>
      </div>
      <div>
        <label class="lbl">Assistance m√©canique</label>
        <select id="mechanic" class="inp">
          <option value="">‚Äî</option>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
      <div>
        <label class="lbl">Ravitaillements</label>
        <select id="feeds" class="inp">
          <option value="">‚Äî</option>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
      <div>
        <label class="lbl">Sexe autoris√©</label>
        <select id="sexAllowed" class="inp">
          <option value="all">Mixte</option>
          <option value="M">Hommes</option>
          <option value="F">Femmes</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px;">
      <label class="lbl">Commentaire libre</label>
      <textarea id="comment" class="inp" rows="3" placeholder="Infos, consignes, parcours..."></textarea>
    </div>

    <!-- MULTI-TOURS -->
    <h3 class="sectionTitle">Multi-tours</h3>
    <div class="toggleLine">
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
        <input type="checkbox" id="enableMultiLaps" />
        <span style="font-weight:900">Activer multi-tours par cat√©gorie d‚Äô√¢ge & sexe</span>
      </label>
      <span class="muted2">Coche pour afficher la grille U7‚Ä¶M9.</span>
    </div>

    <div id="multiLapsWrap" style="display:none; margin-top:10px;">
      <div class="ageBox">
        <div class="muted2" style="margin-bottom:10px;">
          Coche les cat√©gories concern√©es et indique le <b>nombre de tours</b> pour Hommes/Femmes.
          (Codes courts : U7, U9, ‚Ä¶, U23, SEN, M1‚Ä¶M9)
        </div>

        <div class="ageHead">
          <div>Cat√©gorie</div>
          <div>H (tours)</div>
          <div>F (tours)</div>
        </div>

        <div id="ageRows"></div>

        <div class="muted2" style="margin-top:10px;">
          Si multi-tours activ√© mais aucune cat√©gorie coch√©e : l‚Äô√©preuve restera ‚Äústandard‚Äù.
        </div>
      </div>
    </div>

    <!-- BLOC 2 : ANALYSE GPX/OSM (OBLIGATOIRE) -->
    <h3 class="sectionTitle">Bloc 2 ‚Äî Analyse GPX / OSM <span class="req">*</span></h3>

    <div class="filters" style="grid-template-columns: 1.6fr 1fr; align-items:end;">
      <div>
        <label class="lbl">Trace GPX <span class="req">*</span></label>

        <input id="gpxFile" class="inp" type="file"
               accept=".gpx,application/gpx+xml"
               style="display:none" />

        <button class="btn2 primary" id="btnPickAnalyze" type="button">üìÇ Choisir un GPX & analyser</button>

        <div class="muted2" style="margin-top:6px;">
          Obligatoire : l‚Äôanalyse d√©marre automatiquement apr√®s s√©lection du GPX.
        </div>
        <div class="muted2" id="pickedFileName" style="margin-top:6px;"></div>
      </div>

      <div>
        <button class="btn2" id="btnClearGPX" type="button">Effacer GPX</button>
      </div>
    </div>

    <div id="statusBox" class="statusBox" style="display:none;">
      <div class="statusRow">
        <span class="pill" id="statusPhase"><span class="dot"></span> ‚Äî</span>
        <span id="statusMsg" class="muted">‚Äî</span>
      </div>
      <div class="bar" style="margin-top:10px; display:none;" id="statusBarWrap" aria-label="progress">
        <div id="statusBar"></div>
      </div>
      <div class="muted2" style="margin-top:8px;" id="statusSub"></div>
    </div>

    <!-- ACTIONS -->
    <div class="rowBtns">
      <button class="btn2 primary" id="btnSave" type="button">Cr√©er l‚Äô√©preuve</button>
      <button class="btn2" id="btnSaveAndDuplicate" type="button">Cr√©er + dupliquer (Musculaire ‚Üî E-bike)</button>
      <button class="btn2" id="btnSaveAndNew" type="button">Cr√©er + ajouter une autre √©preuve</button>
      <button class="btn2" id="btnReset" type="button">R√©initialiser</button>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <a class="btn2 ok" id="btnViewRace" href="#" style="display:none;">üëÅÔ∏è Voir la fiche de l‚Äô√©preuve</a>
      <a class="btn2" id="btnViewRace2" href="#" style="display:none;">üëÅÔ∏è Voir la fiche (duplicata)</a>
    </div>

    <div id="msg" class="msg"></div>

  </div>
</main>

<script src="js/data.js"></script>
<script src="js/storage.js"></script>
<script src="js/gpx.js"></script>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const params = new URLSearchParams(location.search);

  const AGE_CATS = [
    { id:"U7",  label:"U7 (Poussin 7‚Äì8)" },
    { id:"U9",  label:"U9 (Pupille 9‚Äì10)" },
    { id:"U11", label:"U11 (Benjamin 11‚Äì12)" },
    { id:"U13", label:"U13 (Minime 13‚Äì14)" },
    { id:"U15", label:"U15 (Cadet 15‚Äì16)" },
    { id:"U17", label:"U17 (Junior 17‚Äì18)" },
    { id:"U23", label:"U23 (Espoir 19‚Äì22)" },
    { id:"SEN", label:"SEN (Senior/√âlite 19‚Äì34)" },
    { id:"M1",  label:"M1 (35‚Äì39)" },
    { id:"M2",  label:"M2 (40‚Äì44)" },
    { id:"M3",  label:"M3 (45‚Äì49)" },
    { id:"M4",  label:"M4 (50‚Äì54)" },
    { id:"M5",  label:"M5 (55‚Äì59)" },
    { id:"M6",  label:"M6 (60‚Äì64)" },
    { id:"M7",  label:"M7 (65‚Äì69)" },
    { id:"M8",  label:"M8 (70‚Äì74)" },
    { id:"M9",  label:"M9 (75‚Äì79)" }
  ];

  // -------- UI helpers
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function showMsg(html, ok=true){
    const el = $("msg");
    if (!el) return;
    el.style.display = html ? "block" : "none";
    el.innerHTML = html ? (ok ? `‚úÖ ${html}` : `‚ùå ${html}`) : "";
    el.style.borderColor = ok ? "#dbeafe" : "#fee2e2";
  }

  function showStatusBox(on){
    const box = $("statusBox");
    if (box) box.style.display = on ? "block" : "none";
  }

  function setStatus(phase, msg, prog=null, sub=""){
    showStatusBox(true);
    $("statusPhase").innerHTML = `<span class="dot"></span> ${esc(phase || "‚Äî")}`;
    $("statusMsg").textContent = msg || "‚Äî";
    $("statusSub").textContent = sub || "";
    const wrap = $("statusBarWrap");
    const bar = $("statusBar");
    if (prog == null){
      wrap.style.display = "none";
      bar.style.width = "0%";
    } else {
      wrap.style.display = "block";
      bar.style.width = `${Math.max(0, Math.min(100, prog))}%`;
    }
  }

  // -------- meeting helpers (compat storage.js)
  function listMeetingsSafe(){
    if (typeof window.listMeetings === "function") return window.listMeetings();
    try{
      const raw = localStorage.getItem("mtb.meetings.v1");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(_){ return []; }
  }

  function findMeetingSafe(id){
    if (!id) return null;
    if (typeof window.findMeeting === "function") return window.findMeeting(id);
    return listMeetingsSafe().find(m => m && m.id === id) || null;
  }

  function initMeetingSelect(){
    const sel = $("meetingId");
    if (!sel) return;

    const meetings = listMeetingsSafe().slice()
      .sort((a,b)=> String(b?.date||"").localeCompare(String(a?.date||"")));

    sel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` + meetings.map(m => {
      const d = m.date ? ` ‚Ä¢ ${esc(m.date)}` : "";
      return `<option value="${esc(m.id)}">${esc(m.name || "√âv√©nement")}${d}</option>`;
    }).join("");

    const mid = params.get("meetingId");
    if (mid){
      sel.value = mid;
      applyMeetingDefaults(mid);
    } else {
      $("meetingHint").textContent = "S√©lectionne un √©v√©nement.";
    }

    sel.addEventListener("change", ()=> applyMeetingDefaults(sel.value));
  }

  function applyMeetingDefaults(meetingId){
    const meeting = findMeetingSafe(meetingId);
    const hint = $("meetingHint");
    if (!meeting){
      if (hint) hint.textContent = "‚ö†Ô∏è S√©lectionne un √©v√©nement.";
      return;
    }

    const start = meeting.date || "";
    const end = meeting.endDate || "";

    if (hint){
      hint.textContent = end
        ? `üìÖ Plage √©v√©nement : ${start || "‚Äî"} ‚Üí ${end}`
        : `üìÖ Date √©v√©nement : ${start || "‚Äî"}`;
    }

    $("btnBack").href = `meeting.html?id=${encodeURIComponent(meeting.id)}`;

    const dateEl = $("date");
    dateEl.min = start || "";
    dateEl.max = end || start || "";
    if (!dateEl.value && start) dateEl.value = start;
    if (start && dateEl.value && dateEl.value < start) dateEl.value = start;
    if (end && dateEl.value && dateEl.value > end) dateEl.value = start || end;
  }

  // -------- multi-laps toggle
  function initMultiToggle(){
    const chk = $("enableMultiLaps");
    const wrap = $("multiLapsWrap");
    if (!chk || !wrap) return;

    function apply(){
      wrap.style.display = chk.checked ? "block" : "none";
      if (!chk.checked){
        document.querySelectorAll(".catOn").forEach(c => c.checked = false);
        document.querySelectorAll(".lapsM,.lapsF").forEach(inp => { inp.value = ""; inp.disabled = true; });
      }
    }
    chk.addEventListener("change", apply);
    apply();
  }

  function renderAgeRows(){
    const box = $("ageRows");
    if (!box) return;

    box.innerHTML = AGE_CATS.map(cat => `
      <div class="ageRow">
        <div>
          <label>
            <input type="checkbox" data-cat="${esc(cat.id)}" class="catOn" />
            <div>
              <div style="font-weight:900">${esc(cat.id)}</div>
              <div class="muted2">${esc(cat.label)}</div>
            </div>
          </label>
        </div>
        <div><input type="number" min="0" step="1" placeholder="‚Äî" class="lapsM" data-cat="${esc(cat.id)}" disabled></div>
        <div><input type="number" min="0" step="1" placeholder="‚Äî" class="lapsF" data-cat="${esc(cat.id)}" disabled></div>
      </div>
    `).join("");

    box.querySelectorAll(".catOn").forEach(chk => {
      chk.addEventListener("change", () => {
        const id = chk.getAttribute("data-cat");
        const m = box.querySelector(`.lapsM[data-cat="${CSS.escape(id)}"]`);
        const f = box.querySelector(`.lapsF[data-cat="${CSS.escape(id)}"]`);
        const on = chk.checked;
        if (m) { m.disabled = !on; if (!on) m.value = ""; }
        if (f) { f.disabled = !on; if (!on) f.value = ""; }
      });
    });
  }

  function collectLapsByCategorySex(){
    if (!$("enableMultiLaps")?.checked) return null;
    const box = $("ageRows");
    const out = {};
    box.querySelectorAll(".catOn").forEach(chk => {
      if (!chk.checked) return;
      const id = chk.getAttribute("data-cat");
      const m = box.querySelector(`.lapsM[data-cat="${CSS.escape(id)}"]`);
      const f = box.querySelector(`.lapsF[data-cat="${CSS.escape(id)}"]`);
      const mVal = (m && m.value !== "") ? Number(m.value) : null;
      const fVal = (f && f.value !== "") ? Number(f.value) : null;

      out[id] = {
        M: Number.isFinite(mVal) ? mVal : null,
        F: Number.isFinite(fVal) ? fVal : null
      };
    });
    return Object.keys(out).length ? out : {};
  }

  // -------- analysis cache
  let ANALYSIS = null;
  let ANALYZE_BUSY = false;

  function clearGpx(){
    ANALYSIS = null;
    $("gpxFile").value = "";
    $("pickedFileName").textContent = "";
    showStatusBox(false);
    showMsg("");
  }

  function setAnalyzeBusy(on){
    ANALYZE_BUSY = !!on;
    const btn = $("btnPickAnalyze");
    if (!btn) return;

    if (on){
      btn.disabled = true;
      btn.dataset.label = btn.textContent;
      btn.textContent = "‚è≥ Analyse en cours‚Ä¶";
    } else {
      btn.disabled = false;
      btn.textContent = btn.dataset.label || "üìÇ Choisir un GPX & analyser";
    }
  }

  async function analyzeGpx(){
    const f = $("gpxFile")?.files?.[0];
    if (!f){
      showMsg("GPX obligatoire : s√©lectionne un fichier GPX.", false);
      return;
    }

    setAnalyzeBusy(true);
    showMsg("");
    setStatus("Pr√©paration", "Lecture du fichier‚Ä¶", 8, "D√©marrage‚Ä¶");

    const TIMEOUT_MS = 25000;
    const started = Date.now();

    let timeoutHandle = null;
    const timeoutPromise = new Promise((_, rej) => {
      timeoutHandle = setTimeout(() => rej(new Error("timeout")), TIMEOUT_MS);
    });

    const steps = [
      "Lecture GPX‚Ä¶",
      "Calcul distance / D+‚Ä¶",
      "Analyse pentes‚Ä¶",
      "Interrogation OSM‚Ä¶",
      "Fusion segments‚Ä¶",
      "Finalisation‚Ä¶"
    ];
    let si = 0;
    const anim = setInterval(()=> {
      si = (si + 1) % steps.length;
      $("statusSub").textContent = steps[si];
    }, 900);

    let ticker = null;

    try{
      ticker = setInterval(() => {
        const t = Date.now() - started;
        const p = Math.min(92, 10 + Math.round((t / TIMEOUT_MS) * 75));
        setStatus("Analyse", "Calcul en cours‚Ä¶", p, $("statusSub").textContent || "");
      }, 550);

      const work = (async () => {
        if (typeof window.analyzeGpxFile === "function"){
          return await window.analyzeGpxFile(f);
        }
        if (typeof window.analyzeGPX === "function"){
          return await window.analyzeGPX(f, { keepPoints:true });
        }
        const txt = await f.text();
        if (typeof window.analyzeGpxText === "function"){
          return await window.analyzeGpxText(txt);
        }
        return { fileName: f.name };
      })();

      const res = await Promise.race([work, timeoutPromise]);

      ANALYSIS = {
        fileName: f.name,
        analyzedAt: Date.now(),
        distanceKm: (res?.distanceKm ?? res?.stats?.distanceKm ?? null),
        dplusM: (res?.dplusM ?? res?.stats?.dplusM ?? null),
        surfaceEstimate: (res?.surfaceEstimate ?? res?.surface ?? null),
        physScore: (res?.phys?.score ?? res?.physScore ?? null),
        techScore: (res?.tech?.techScore ?? res?.techScore ?? null),
        globalScore: (res?.globalScore ?? null),
        points: (res?.points ?? res?.track ?? null),
        raw: res || null
      };

      setStatus("Termin√©", "Analyse termin√©e.", 100, "Tu peux enregistrer l‚Äô√©preuve.");
      showMsg("Analyse GPX/OSM termin√©e.", true);

    } catch(e){
      ANALYSIS = null;

      if (e?.message === "timeout"){
        setStatus("Timeout", "Analyse trop longue.", null, "R√©essaie (GPX obligatoire).");
        showMsg("Timeout analyse GPX/OSM.", false);
      } else {
        setStatus("Erreur", "Analyse impossible.", null, "V√©rifie le GPX ou le serveur.");
        showMsg("Erreur analyse GPX.", false);
      }
      console.warn(e);

    } finally {
      if (timeoutHandle) clearTimeout(timeoutHandle);
      if (ticker) clearInterval(ticker);
      clearInterval(anim);
      setAnalyzeBusy(false);
    }
  }

  // -------- save race (storage compatible)
  function makeIdFromName(name, salt=0){
    const base = String(name||"").trim().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    return `${base || "race"}-${Date.now() + (salt|0)}`;
  }

  function normalizeDate(s){
    const v = String(s||"").trim();
    return /^\d{4}-\d{2}-\d{2}$/.test(v) ? v : null;
  }

  function upsertRaceSafe(r){
    if (typeof window.upsertRace === "function") return window.upsertRace(r);
    const KEY = "mtb.races.v1";
    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem(KEY)||"[]"); }catch(_){ arr=[]; }
    if (!Array.isArray(arr)) arr = [];
    const i = arr.findIndex(x => x && x.id === r.id);
    if (i >= 0) arr[i] = r; else arr.unshift(r);
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  function attachRaceToMeeting(meetingId, raceId){
    const m = findMeetingSafe(meetingId);
    if (!m) return;
    m.raceIds = Array.isArray(m.raceIds) ? m.raceIds : [];
    if (!m.raceIds.includes(raceId)) m.raceIds.push(raceId);

    if (typeof window.upsertMeeting === "function") return window.upsertMeeting(m);
    const KEY = "mtb.meetings.v1";
    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem(KEY)||"[]"); }catch(_){ arr=[]; }
    if (!Array.isArray(arr)) arr=[];
    const idx = arr.findIndex(x => x && x.id === m.id);
    if (idx >= 0) arr[idx] = m; else arr.unshift(m);
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  function validate(){
    if (ANALYZE_BUSY) return "Analyse en cours : attends la fin.";
    if (!$("meetingId").value) return "√âv√©nement obligatoire.";
    if (!normalizeDate($("date").value)) return "Date d‚Äô√©preuve obligatoire.";
    if (!$("name").value.trim()) return "Nom d‚Äô√©preuve obligatoire.";

    const f = $("gpxFile")?.files?.[0];
    if (!f) return "GPX obligatoire : s√©lectionne un fichier GPX.";
    if (!ANALYSIS) return "Analyse GPX/OSM obligatoire : clique sur ‚ÄúChoisir un GPX & analyser‚Äù.";

    return null;
  }

  function buildRace({ ebikeOverride=null, nameSuffix="", idSalt=0 } = {}){
    const meetingId = $("meetingId").value;
    const meeting = findMeetingSafe(meetingId);
    const lapsByCategorySex = collectLapsByCategorySex();

    const baseName = $("name").value.trim();
    const finalName = (baseName + (nameSuffix ? ` ${nameSuffix}` : "")).trim();

    const ebikeVal = (ebikeOverride === null)
      ? ($("ebike").value === "1")
      : !!ebikeOverride;

    return {
      id: makeIdFromName(finalName, idSalt),
      meetingId,
      meetingName: meeting?.name || null,

      date: normalizeDate($("date").value),
      time: $("time").value || null,

      name: finalName,
      cutoffTime: $("cutoff").value.trim() || null,
      level: $("level").value || null,
      disc: $("disc").value || null,

      ebike: ebikeVal,
      bikeWash: $("wash").value || null,
      mechAssist: $("mechanic").value || null,
      feeds: $("feeds").value || null,
      sexAllowed: $("sexAllowed").value || "all",

      comment: $("comment").value.trim() || null,
      meetingUrl: meeting?.url || null,

      analysis: {
        fileName: ANALYSIS.fileName,
        distanceKm: ANALYSIS.distanceKm ?? null,
        dplusM: ANALYSIS.dplusM ?? null,
        surfaceEstimate: ANALYSIS.surfaceEstimate ?? null,
        physScore: ANALYSIS.physScore ?? null,
        techScore: ANALYSIS.techScore ?? null,
        globalScore: ANALYSIS.globalScore ?? null,
        points: ANALYSIS.points ?? null
      },

      distanceKm: ANALYSIS.distanceKm ?? null,
      dplusM: ANALYSIS.dplusM ?? null,
      surfaceEstimate: ANALYSIS.surfaceEstimate ?? null,
      physScore: ANALYSIS.physScore ?? null,
      techScore: ANALYSIS.techScore ?? null,
      globalScore: ANALYSIS.globalScore ?? null,
      gpx: { fileName: ANALYSIS.fileName, points: ANALYSIS.points ?? null },

      lapsByCategorySex: (lapsByCategorySex && Object.keys(lapsByCategorySex).length) ? lapsByCategorySex : null,

      createdAt: Date.now(),
      isPublished: false
    };
  }

  function afterSaveLinks(race, race2=null){
    if (race){
      $("btnViewRace").href = `race.html?id=${encodeURIComponent(race.id)}`;
      $("btnViewRace").style.display = "inline-flex";
    }
    if (race2){
      $("btnViewRace2").href = `race.html?id=${encodeURIComponent(race2.id)}`;
      $("btnViewRace2").style.display = "inline-flex";
    } else {
      $("btnViewRace2").style.display = "none";
      $("btnViewRace2").href = "#";
    }
  }

  function resetForm(keepMeeting=true){
    const keepMid = keepMeeting ? $("meetingId").value : "";
    const keepDate = keepMeeting ? $("date").value : "";

    ["name","cutoff","time","comment"].forEach(id => $(id).value = "");
    ["level","disc","wash","mechanic","feeds"].forEach(id => $(id).value = "");
    $("ebike").value = "0";
    $("sexAllowed").value = "all";

    $("enableMultiLaps").checked = false;
    $("multiLapsWrap").style.display = "none";
    document.querySelectorAll(".catOn").forEach(chk => chk.checked = false);
    document.querySelectorAll(".lapsM,.lapsF").forEach(inp => { inp.value = ""; inp.disabled = true; });

    clearGpx();

    $("btnViewRace").style.display = "none";
    $("btnViewRace").href = "#";
    $("btnViewRace2").style.display = "none";
    $("btnViewRace2").href = "#";

    showMsg("");
    if (keepMeeting){
      $("meetingId").value = keepMid;
      applyMeetingDefaults(keepMid);
      $("date").value = keepDate;
    }
  }

  function saveSingle(thenNew){
    $("btnViewRace").style.display = "none";
    $("btnViewRace2").style.display = "none";
    showMsg("");

    const err = validate();
    if (err){ showMsg(err, false); return; }

    const race = buildRace();
    upsertRaceSafe(race);
    attachRaceToMeeting(race.meetingId, race.id);

    showMsg(`√âpreuve cr√©√©e : <b>${esc(race.name)}</b>`, true);
    afterSaveLinks(race);

    if (thenNew){
      setTimeout(()=> resetForm(true), 80);
    }
  }

  function saveAndDuplicate(){
    $("btnViewRace").style.display = "none";
    $("btnViewRace2").style.display = "none";
    showMsg("");

    const err = validate();
    if (err){ showMsg(err, false); return; }

    const isEbikeSelected = ($("ebike").value === "1");

    const race1 = buildRace({
      ebikeOverride: isEbikeSelected,
      nameSuffix: "", // on garde le nom tel quel
      idSalt: 0
    });

    const race2 = buildRace({
      ebikeOverride: !isEbikeSelected,
      // suffix clair pour √©viter deux noms identiques
      nameSuffix: isEbikeSelected ? "‚Äî Musculaire" : "‚Äî E-bike",
      idSalt: 7
    });

    upsertRaceSafe(race1);
    attachRaceToMeeting(race1.meetingId, race1.id);

    upsertRaceSafe(race2);
    attachRaceToMeeting(race2.meetingId, race2.id);

    showMsg(
      `Deux √©preuves cr√©√©es : <b>${esc(race1.name)}</b> et <b>${esc(race2.name)}</b> (classements s√©par√©s).`,
      true
    );
    afterSaveLinks(race1, race2);
  }

  // -------- init
  initMeetingSelect();
  renderAgeRows();
  initMultiToggle();

  // Bouton unique : ouvrir fichier + analyse auto
  $("btnPickAnalyze").addEventListener("click", () => {
    showMsg("");
    $("gpxFile").value = ""; // force change event m√™me si m√™me fichier
    $("gpxFile").click();
  });

  $("gpxFile").addEventListener("change", async () => {
    const f = $("gpxFile")?.files?.[0];
    $("pickedFileName").textContent = f ? ("Fichier s√©lectionn√© : " + f.name) : "";
    if (f) await analyzeGpx();
  });

  $("btnClearGPX").addEventListener("click", () => clearGpx());

  $("btnSave").addEventListener("click", ()=> saveSingle(false));
  $("btnSaveAndNew").addEventListener("click", ()=> saveSingle(true));
  $("btnSaveAndDuplicate").addEventListener("click", ()=> saveAndDuplicate());
  $("btnReset").addEventListener("click", ()=> resetForm(true));

})();
</script>

</body>
</html>

