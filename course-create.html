<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cr√©er une √©preuve ‚Äî MTB Points</title>
  <link rel="stylesheet" href="./css/style.css" />
  <style>
    .muted{color:#667085}
    .mini{font-size:12px;color:#667085}
    .box{border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2,.grid3{grid-template-columns:1fr}}
    .statusRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .progressWrap{height:12px;border:1px solid #e5e7eb;background:#f1f5f9;border-radius:999px;overflow:hidden}
    .progressBar{height:12px;width:0%}
    .pillSmall{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid #e5e7eb;background:#f8fafc;color:#0f172a}
    .warnBox{border:1px solid #fed7aa;background:#fff7ed;color:#9a3412;border-radius:12px;padding:10px}
    .okBox{border:1px solid #bbf7d0;background:#f0fdf4;color:#166534;border-radius:12px;padding:10px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .ageTable .head, .ageTable .row{
      display:grid;grid-template-columns:1fr 120px 120px;
      gap:10px;align-items:center;
    }
    .ageTable .head{font-weight:900;color:#0f172a;margin-bottom:8px}
    .ageTable .row{padding:8px 0;border-bottom:1px dashed #e5e7eb}
    .ageTable .row:last-child{border-bottom:0}
    .ageTable label{display:flex;gap:10px;align-items:flex-start;margin:0;cursor:pointer}
    .ageTable input[type="checkbox"]{width:auto;margin-top:3px}
    .ageTable input[type="number"]{width:100%;padding:10px;border-radius:12px;border:1px solid #cbd5e1}
  </style>
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points ‚Äî Cr√©er une √©preuve</h1>
    <span class="pill"><span class="dot ok"></span> √âpreuve rattach√©e</span>
  </div>

  <nav class="nav">
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html">√âv√©nements</a>
    <a href="events.html" class="active">√âpreuves</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="headerRight">
    <a class="btn ghost" id="btnBack" href="meetings.html">‚Üê Retour</a>
  </div>
</header>

<main class="wrap">
  <div class="card">

    <section class="hero">
      <div class="heroTop">
        <div style="min-width:280px;flex:1">
          <h2>Nouvelle √©preuve</h2>
          <div class="heroMeta">
            Bloc 1 : infos ‚Ä¢ Bloc 2 : analyse GPX + OSM (animation + timeout) ‚Ä¢ Puis ‚ÄúCr√©er‚Äù.
          </div>
          <div id="meetingHint" class="heroDesc"></div>
        </div>
        <div class="heroActions">
          <span class="pill"><span class="dot ok"></span> Meeting</span>
          <span class="pill"><span class="dot"></span> Multi-tours</span>
          <span class="pill"><span class="dot"></span> GPX + OSM</span>
        </div>
      </div>
    </section>

    <!-- Bloc 0: rattachement -->
    <h3 class="sectionTitle" style="margin-top:18px;">Rattachement & date</h3>
    <div class="filters" style="grid-template-columns:1.4fr 1fr 1fr;align-items:end;">
      <div>
        <label for="meetingId">√âv√©nement *</label>
        <select id="meetingId"></select>
        <div class="mini">L‚Äô√©preuve sera rattach√©e automatiquement.</div>
      </div>
      <div>
        <label for="date">Date de l‚Äô√©preuve *</label>
        <input id="date" type="date" />
        <div class="mini" id="dateHint">Date born√©e par l‚Äô√©v√©nement.</div>
      </div>
      <div>
        <label for="time">Heure de d√©part</label>
        <input id="time" type="time" />
      </div>
    </div>

    <!-- Bloc 1: informations -->
    <h3 class="sectionTitle" style="margin-top:18px;">Bloc 1 ‚Äî Informations</h3>

    <div class="filters" style="grid-template-columns:1.6fr 1fr 1fr 1fr;align-items:end;">
      <div class="spanAll" style="grid-column:1/3">
        <label for="name">Nom de l‚Äô√©preuve *</label>
        <input id="name" type="text" placeholder="Ex: 20 km / 30 km / Sp√©ciale 1 / etc." />
      </div>

      <div>
        <label for="cutoff">Barri√®re horaire (optionnel)</label>
        <input id="cutoff" type="text" placeholder="Ex: 05:30" />
      </div>

      <div>
        <label for="level">Cat√©gorie d‚Äô√©preuve</label>
        <select id="level">
          <option value="Locale">Locale</option>
          <option value="R√©gionale">R√©gionale</option>
          <option value="Nationale">Nationale</option>
          <option value="Internationale">Internationale</option>
        </select>
      </div>

      <div>
        <label for="disc">Discipline</label>
        <select id="disc">
          <option value="XC">XC</option>
          <option value="Enduro">Enduro</option>
          <option value="DH">DH</option>
          <option value="Marathon">Marathon</option>
          <option value="Ultra">Ultra</option>
          <option value="Gravel">Gravel</option>
        </select>
      </div>

      <div>
        <label for="bikeType">Type de v√©lo</label>
        <select id="bikeType">
          <option value="musculaire">Musculaire</option>
          <option value="ebike">Assistance √©lectrique</option>
        </select>
      </div>

      <div>
        <label for="bikeWash">Lavage des v√©los</label>
        <select id="bikeWash">
          <option value="0">Non</option>
          <option value="1">Oui</option>
        </select>
      </div>

      <div>
        <label for="mechAssist">Assistance m√©canique</label>
        <select id="mechAssist">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>

      <div>
        <label for="aidStations">Ravitaillements</label>
        <select id="aidStations">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>

      <div class="spanAll" style="grid-column:1/-1">
        <label for="comment">Commentaire libre</label>
        <textarea id="comment" rows="3" placeholder="Ex: portage, zones techniques, obstacles, etc."></textarea>
      </div>
    </div>

    <!-- Multi-tours -->
    <div class="box" style="margin-top:14px;">
      <div class="statusRow">
        <div style="font-weight:900;">√âpreuve en plusieurs tours (par sexe + cat√©gories UCI)</div>
        <label class="pillSmall" style="cursor:pointer;">
          <input id="isLaps" type="checkbox" style="width:auto;margin:0 8px 0 0"> Activer
        </label>
      </div>
      <div class="mini" style="margin-top:6px;">
        Si activ√© : tu coches les cat√©gories pr√©sentes et tu mets le nombre de tours pour <b>Hommes</b> et <b>Femmes</b>.
        Codes courts : U7, U9, U11, U13, U15, U17, U23, SEN, M1‚Ä¶M9.
      </div>

      <div id="lapsBox" style="display:none;margin-top:10px;">
        <div class="ageTable">
          <div class="head">
            <div>Cat√©gorie</div><div>Tours H</div><div>Tours F</div>
          </div>
          <div id="ageRows"></div>
        </div>
        <div class="mini" style="margin-top:8px;">
          Interpr√©tation : le GPX est le <b>circuit</b> (1 tour). Distance/D+ finaux d√©pendront des tours.
        </div>
      </div>
    </div>

    <!-- Bloc 2: analyse -->
    <h3 class="sectionTitle" style="margin-top:18px;">Bloc 2 ‚Äî Analyse GPX + OSM</h3>

    <div class="box">
      <div class="grid2">
        <div>
          <label for="gpxFile">Fichier GPX *</label>
          <input id="gpxFile" type="file" accept=".gpx,application/gpx+xml,text/xml,application/xml"/>
          <div class="mini">L‚Äôanalyse calcule automatiquement distance + D+ (et tente une analyse OSM si dispo).</div>
        </div>
        <div class="actions" style="align-items:flex-end">
          <button class="btn" id="btnAnalyze" type="button">Analyser</button>
          <button class="btn ghost" id="btnClear" type="button">Effacer</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="statusRow">
          <span class="pillSmall" id="phasePill"><span class="dot"></span> En attente</span>
          <span class="muted" id="phaseTxt">Aucun fichier analys√©.</span>
        </div>

        <div class="progressWrap" style="margin-top:10px;display:none" id="progWrap">
          <div class="progressBar" id="progBar"></div>
        </div>

        <div class="mini" style="margin-top:8px" id="phaseSub"></div>

        <div class="grid3" style="margin-top:12px;">
          <div class="box" style="margin:0">
            <div class="mini">Distance (auto)</div>
            <div style="font-weight:900;font-size:18px" id="autoDist">‚Äî</div>
          </div>
          <div class="box" style="margin:0">
            <div class="mini">D√©nivel√© + (auto)</div>
            <div style="font-weight:900;font-size:18px" id="autoDplus">‚Äî</div>
          </div>
          <div class="box" style="margin:0">
            <div class="mini">Type de voie (si dispo)</div>
            <div style="font-weight:900;font-size:14px" id="autoSurface">‚Äî</div>
          </div>
        </div>

        <div id="timeoutBox" class="warnBox" style="display:none;margin-top:12px;">
          ‚ö†Ô∏è Analyse OSM trop longue / indisponible. Tu peux quand m√™me cr√©er l‚Äô√©preuve (distance/D+ depuis GPX).
        </div>

        <div id="okBox" class="okBox" style="display:none;margin-top:12px;">
          ‚úÖ Analyse termin√©e.
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="hintRow" style="margin-top:14px;">
      <div class="muted">* Champs obligatoires : √âv√©nement, date, nom, GPX</div>
      <div class="muted" id="saveHint">Tu pourras voir la fiche √©preuve apr√®s cr√©ation.</div>
    </div>

    <div class="actions" style="margin-top:14px;">
      <button class="btn primary" id="btnSave" type="button">Cr√©er l‚Äô√©preuve</button>
      <button class="btn" id="btnSaveAndNew" type="button">Cr√©er + ajouter une autre √©preuve</button>
      <a class="btn ok" id="btnViewRace" href="#" style="display:none;">üëÅÔ∏è Voir la fiche de l‚Äô√©preuve</a>
    </div>

    <div id="msg" class="empty" style="display:none;margin-top:14px;"></div>

  </div>
</main>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const params = new URLSearchParams(location.search);

  // ---------------- Storage (local) ----------------
  const KEY_MEETINGS = "mtb.meetings.v1";
  const KEY_RACES = "mtb.races.v1";

  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function showMsg(html, ok=true){
    const el = $("msg");
    if (!el) return;
    el.style.display = html ? "block" : "none";
    el.innerHTML = html ? (ok ? `‚úÖ ${html}` : `‚ùå ${html}`) : "";
  }

  function loadJSON(key){
    try{ const raw = localStorage.getItem(key); const v = raw ? JSON.parse(raw) : []; return Array.isArray(v) ? v : []; }
    catch(_){ return []; }
  }
  function saveJSON(key, arr){
    try{ localStorage.setItem(key, JSON.stringify(arr || [])); }catch(_){}
  }

  function makeIdFromName(name){
    const slug = String(name || "")
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "")
      .slice(0, 60) || "race";
    return `${slug}-${Date.now()}`;
  }

  function listMeetings(){ return loadJSON(KEY_MEETINGS); }
  function findMeeting(id){ return listMeetings().find(m => m && m.id === id) || null; }

  function upsertRace(race){
    const all = loadJSON(KEY_RACES);
    const i = all.findIndex(r => r && r.id === race.id);
    if (i >= 0) all[i] = race; else all.unshift(race);
    saveJSON(KEY_RACES, all);
  }

  function upsertMeeting(meeting){
    const all = loadJSON(KEY_MEETINGS);
    const i = all.findIndex(m => m && m.id === meeting.id);
    if (i >= 0) all[i] = meeting; else all.unshift(meeting);
    saveJSON(KEY_MEETINGS, all);
  }

  // ---------------- Meeting select + date range ----------------
  function applyMeetingDefaults(mid){
    const m = findMeeting(mid);
    const hint = $("meetingHint");
    const dateEl = $("date");
    const dateHint = $("dateHint");
    const back = $("btnBack");

    if (!m){
      if (hint) hint.innerHTML = `‚ö†Ô∏è √âv√©nement introuvable.`;
      if (dateEl){ dateEl.min=""; dateEl.max=""; }
      if (dateHint) dateHint.textContent = "Date born√©e par l‚Äô√©v√©nement.";
      if (back) back.href = "meetings.html";
      return;
    }

    const start = m.date || "";
    const end = m.endDate || "";

    if (hint){
      const range = end ? `${esc(start)} ‚Üí ${esc(end)}` : esc(start || "‚Äî");
      const loc = m.location ? ` ‚Ä¢ üìç ${esc(m.location)}` : "";
      hint.innerHTML = `<b>${esc(m.name)}</b> ‚Ä¢ üìÖ <b>${range}</b>${loc}`;
    }

    if (dateEl){
      dateEl.min = start || "";
      dateEl.max = end || "";
      if (!dateEl.value && start) dateEl.value = start;
      if (start && dateEl.value && dateEl.value < start) dateEl.value = start;
      if (end && dateEl.value && dateEl.value > end) dateEl.value = start || end;
    }

    if (dateHint){
      dateHint.textContent = end
        ? "√âv√©nement multi-jours : la date de l‚Äô√©preuve doit √™tre dans la plage."
        : "√âv√©nement 1 jour : date de l‚Äô√©preuve = date de l‚Äô√©v√©nement (par d√©faut).";
    }

    if (back) back.href = `meeting.html?id=${encodeURIComponent(m.id)}`;
  }

  function initMeetings(){
    const sel = $("meetingId");
    const meetings = listMeetings();
    sel.innerHTML = `<option value="">‚Äî Choisir un √©v√©nement ‚Äî</option>` +
      meetings.map(m => `<option value="${esc(m.id)}">${esc(m.name)}${m.date ? ` (${esc(m.date)})` : ""}</option>`).join("");

    const mid = params.get("meetingId") || "";
    if (mid){
      sel.value = mid;
      applyMeetingDefaults(mid);
    }
    sel.addEventListener("change", ()=> applyMeetingDefaults(sel.value));
  }

  // ---------------- UCI age rows (codes courts) ----------------
  const AGE = [
    ["U7","Poussin (7‚Äì8)"],
    ["U9","Pupille (9‚Äì10)"],
    ["U11","Benjamin (11‚Äì12)"],
    ["U13","Minime (13‚Äì14)"],
    ["U15","Cadet (15‚Äì16)"],
    ["U17","Junior (17‚Äì18)"],
    ["U23","Espoir (19‚Äì22)"],
    ["SEN","√âlite/Senior (19‚Äì34)"],
    ["M1","Masters 1 (35‚Äì39)"],
    ["M2","Masters 2 (40‚Äì44)"],
    ["M3","Masters 3 (45‚Äì49)"],
    ["M4","Masters 4 (50‚Äì54)"],
    ["M5","Masters 5 (55‚Äì59)"],
    ["M6","Masters 6 (60‚Äì64)"],
    ["M7","Masters 7 (65‚Äì69)"],
    ["M8","Masters 8 (70‚Äì74)"],
    ["M9","Masters 9 (75‚Äì79)"],
  ];

  function renderAgeRows(){
    const root = $("ageRows");
    root.innerHTML = AGE.map(([code,label])=>`
      <div class="row">
        <label><input type="checkbox" class="ageChk" value="${code}"> <b>${code}</b> ‚Äî <span class="mini">${esc(label)}</span></label>
        <input type="number" min="1" step="1" value="1" class="lapsInp" data-age="${code}" data-sex="M">
        <input type="number" min="1" step="1" value="1" class="lapsInp" data-age="${code}" data-sex="F">
      </div>
    `).join("");
  }

  $("isLaps").addEventListener("change", ()=>{
    $("lapsBox").style.display = $("isLaps").checked ? "block" : "none";
  });

  function collectLapsConfig(){
    if (!$("isLaps").checked) return null;
    const selected = Array.from(document.querySelectorAll(".ageChk")).filter(c=>c.checked).map(c=>c.value);
    const rules = Array.from(document.querySelectorAll(".lapsInp")).map(inp=>({
      age: inp.getAttribute("data-age"),
      sex: inp.getAttribute("data-sex"),
      laps: Math.max(1, Number(inp.value)||1)
    }));
    return { mode:"by_age_sex", selected, rules };
  }

  // ---------------- Analysis (GPX + OSM) ----------------
  let ANALYSIS = null;

  function setPhase(kind, text, sub, progress, isOk=false, isErr=false){
    const pill = $("phasePill");
    const txt = $("phaseTxt");
    const subEl = $("phaseSub");
    const wrap = $("progWrap");
    const bar = $("progBar");

    pill.innerHTML = `<span class="dot ${isErr ? "err" : (isOk ? "ok" : "")}"></span> ${esc(kind)}`;
    txt.textContent = text || "";
    subEl.textContent = sub || "";

    const hasProg = typeof progress === "number";
    wrap.style.display = hasProg ? "block" : "none";
    if (hasProg) bar.style.width = Math.max(0, Math.min(100, Math.round(progress*100))) + "%";
  }

  function fmt1(n){ return (n==null) ? "‚Äî" : (Math.round(n*10)/10).toString().replace(".", ","); }

  function surfaceText(s){
    if (!s) return "‚Äî";
    const road = Math.round(s.roadPct ?? 0);
    const track = Math.round(s.trackPct ?? 0);
    const single = Math.round(s.singlePct ?? 0);
    return `Route ~${road}% ‚Ä¢ Piste ~${track}% ‚Ä¢ Single ~${single}%`;
  }

  function setAutoFields(res){
    const dist = res?.distanceKm ?? null;
    const dplus = res?.dplusM ?? null;
    $("autoDist").textContent = dist==null ? "‚Äî" : `${fmt1(dist)} km`;
    $("autoDplus").textContent = dplus==null ? "‚Äî" : `${Math.round(dplus)} m`;
    $("autoSurface").textContent = surfaceText(res?.surfaceEstimate || res?.surface || null);
  }

  function startAnimation(){
    const frames = [
      "Lecture GPX‚Ä¶",
      "Calcul distance & D+‚Ä¶",
      "Analyse pentes‚Ä¶",
      "Interrogation OSM‚Ä¶",
      "Fusion des segments‚Ä¶",
      "Finalisation‚Ä¶"
    ];
    let i = 0;
    return setInterval(()=>{
      i = (i+1) % frames.length;
      $("phaseSub").textContent = frames[i];
    }, 900);
  }

  async function analyze(){
    $("timeoutBox").style.display = "none";
    $("okBox").style.display = "none";
    ANALYSIS = null;
    setAutoFields(null);
    showMsg("");

    const file = $("gpxFile").files?.[0];
    if (!file){ showMsg("Choisis un fichier GPX.", false); return; }

    // Timeout global (OSM peut bloquer)
    const TIMEOUT_MS = 25000;
    let timedOut = false;

    setPhase("Analyse", "D√©marrage‚Ä¶", "Pr√©paration‚Ä¶", 0.05);
    const anim = startAnimation();

    const timeoutPromise = new Promise((_, rej)=>{
      setTimeout(()=>{
        timedOut = true;
        rej(new Error("timeout"));
      }, TIMEOUT_MS);
    });

    // Si ton gpx.js expose analyzeGPX(file, opts) et dispatch mtb:status, on l'utilise.
    const runPromise = (async ()=>{
      if (typeof window.analyzeGPX !== "function"){
        throw new Error("analyzeGPX() introuvable. V√©rifie ton js/gpx.js.");
      }
      // opts libres: ton gpx.js peut ignorer
      const res = await window.analyzeGPX(file, { keepPoints:true });
      return res;
    })();

    try{
      const res = await Promise.race([runPromise, timeoutPromise]);
      clearInterval(anim);

      ANALYSIS = {
        fileName: file.name,
        analyzedAt: Date.now(),
        raw: res,
        distanceKm: res?.distanceKm ?? res?.stats?.distanceKm ?? null,
        dplusM: res?.dplusM ?? res?.stats?.dplusM ?? null,
        hasElevation: !!(res?.hasElevation ?? res?.stats?.hasElevation),
        physScore: res?.phys?.score ?? res?.physScore ?? null,
        techScore: res?.tech?.techScore ?? res?.techScore ?? null,
        globalScore: (Number.isFinite(Number(res?.phys?.score ?? res?.physScore)) && Number.isFinite(Number(res?.tech?.techScore ?? res?.techScore)))
          ? Math.round(0.55*Number(res?.phys?.score ?? res?.physScore) + 0.45*Number(res?.tech?.techScore ?? res?.techScore))
          : null,
        surfaceEstimate: res?.surfaceEstimate ?? null,
        // points pour race.html (profil/carte) si dispo
        points: res?.points ?? res?.track ?? res?.raw?.points ?? null
      };

      setAutoFields(ANALYSIS);
      setPhase("Termin√©", "Analyse termin√©e.", "OK", 1, true, false);
      $("okBox").style.display = "block";
    }catch(e){
      clearInterval(anim);

      if (timedOut || e?.message === "timeout"){
        setPhase("Timeout", "Analyse OSM trop longue.", "Tu peux cr√©er l‚Äô√©preuve avec distance/D+ GPX.", 0.85, false, true);
        $("timeoutBox").style.display = "block";

        // On attend quand m√™me le GPX ‚Äúlocal‚Äù si possible
        try{
          const res = await runPromise; // si finalement √ßa r√©pond
          ANALYSIS = {
            fileName: file.name,
            analyzedAt: Date.now(),
            raw: res,
            distanceKm: res?.distanceKm ?? res?.stats?.distanceKm ?? null,
            dplusM: res?.dplusM ?? res?.stats?.dplusM ?? null,
            hasElevation: !!(res?.hasElevation ?? res?.stats?.hasElevation),
            physScore: res?.phys?.score ?? res?.physScore ?? null,
            techScore: res?.tech?.techScore ?? res?.techScore ?? null,
            globalScore: null,
            surfaceEstimate: res?.surfaceEstimate ?? null,
            points: res?.points ?? res?.track ?? res?.raw?.points ?? null
          };
          setAutoFields(ANALYSIS);
        }catch(_){}
        return;
      }

      setPhase("Erreur", "√âchec analyse", (e?.message || "Erreur"), null, false, true);
      showMsg(e?.message || "Erreur analyse", false);
      ANALYSIS = null;
      setAutoFields(null);
    }
  }

  $("btnAnalyze").addEventListener("click", analyze);

  $("btnClear").addEventListener("click", ()=>{
    $("gpxFile").value = "";
    ANALYSIS = null;
    setAutoFields(null);
    $("timeoutBox").style.display = "none";
    $("okBox").style.display = "none";
    setPhase("En attente", "Aucun fichier analys√©.", "", null, false, false);
    showMsg("");
  });

  // Si ton gpx.js envoie des events de statut, on les affiche aussi (bonus)
  window.addEventListener("mtb:status", (e)=>{
    const d = e?.detail || {};
    if (!d.phase) return;
    const phase = String(d.phase);
    const msg = d.message || "";
    const prog = (typeof d.progress === "number") ? d.progress : null;
    const isErr = phase === "error";
    const isOk = phase === "done";
    setPhase(phase, msg, $("phaseSub").textContent, prog, isOk, isErr);
  });

  // ---------------- Save ----------------
  function val(id){ return String($(id).value || "").trim(); }

  function validate(){
    if (!val("meetingId")) return "√âv√©nement obligatoire.";
    if (!val("date")) return "Date obligatoire.";
    if (!val("name")) return "Nom obligatoire.";
    if (!ANALYSIS) return "Analyse GPX obligatoire (au minimum distance/D+).";
    return null;
  }

  function buildRace(){
    const meetingId = val("meetingId");
    const meeting = findMeeting(meetingId);

    return {
      id: makeIdFromName(val("name")),
      meetingId,
      date: val("date"),
      time: val("time") || null,

      name: val("name"),
      cutoffTime: val("cutoff") || null,
      level: val("level") || null,
      disc: val("disc") || null,

      bikeType: val("bikeType"), // musculaire | ebike
      ebike: (val("bikeType") === "ebike"),

      bikeWash: (val("bikeWash") === "1"),
      mechStations: Number(val("mechAssist") || 0),
      aidStations: Number(val("aidStations") || 0),

      comment: val("comment") || null,

      // event url inherited (useful on race.html)
      meetingUrl: meeting?.url || null,

      // computed
      distanceKm: ANALYSIS.distanceKm ?? null,
      dplusM: ANALYSIS.dplusM ?? null,
      physScore: ANALYSIS.physScore ?? null,
      techScore: ANALYSIS.techScore ?? null,
      globalScore: ANALYSIS.globalScore ?? null,
      surfaceEstimate: ANALYSIS.surfaceEstimate ?? null,

      gpx: {
        fileName: ANALYSIS.fileName,
        hasElevation: ANALYSIS.hasElevation,
        // pour race.html (profil/carte)
        points: ANALYSIS.points || null
      },

      lapsConfig: collectLapsConfig(), // null ou {mode,selected,rules}
      createdAt: Date.now()
    };
  }

  function attachRaceToMeeting(race){
    const m = findMeeting(race.meetingId);
    if (!m) return;
    m.raceIds = Array.isArray(m.raceIds) ? m.raceIds : [];
    if (!m.raceIds.includes(race.id)) m.raceIds.push(race.id);
    upsertMeeting(m);
  }

  function showViewBtn(raceId){
    const a = $("btnViewRace");
    a.href = `race.html?id=${encodeURIComponent(raceId)}`;
    a.style.display = "inline-flex";
  }
  function hideViewBtn(){
    const a = $("btnViewRace");
    a.style.display = "none";
    a.href = "#";
  }

  function resetForm(keepMeeting=true){
    const keepMid = keepMeeting ? val("meetingId") : "";
    const keepDate = keepMeeting ? val("date") : "";

    ["name","cutoff","time","comment"].forEach(id=> $(id).value = "");
    $("level").value = "Locale";
    $("disc").value = "XC";
    $("bikeType").value = "musculaire";
    $("bikeWash").value = "0";
    $("mechAssist").value = "0";
    $("aidStations").value = "0";

    $("isLaps").checked = false;
    $("lapsBox").style.display = "none";
    document.querySelectorAll(".ageChk").forEach(c=> c.checked = false);
    document.querySelectorAll(".lapsInp").forEach(i=> i.value = "1");

    $("gpxFile").value = "";
    ANALYSIS = null;
    setAutoFields(null);
    $("timeoutBox").style.display = "none";
    $("okBox").style.display = "none";
    setPhase("En attente", "Aucun fichier analys√©.", "", null);
    hideViewBtn();
    showMsg("");

    if (keepMeeting){
      $("meetingId").value = keepMid;
      $("date").value = keepDate;
      applyMeetingDefaults(keepMid);
    }
  }

  function doSave(thenNew){
    hideViewBtn();
    const err = validate();
    if (err){ showMsg(err, false); return; }

    const race = buildRace();
    upsertRace(race);
    attachRaceToMeeting(race);

    showMsg(`√âpreuve cr√©√©e : <b>${esc(race.name)}</b>`, true);
    showViewBtn(race.id);

    if (thenNew){
      setTimeout(()=> resetForm(true), 60);
    }
  }

  $("btnSave").addEventListener("click", ()=> doSave(false));
  $("btnSaveAndNew").addEventListener("click", ()=> doSave(true));

  // Init
  initMeetings();
  renderAgeRows();

  // defaults
  setPhase("En attente", "Aucun fichier analys√©.", "", null);

})();
</script>

<!-- Si tu as d√©j√† gpx.js dans ton projet, garde-le : -->
<script src="./js/gpx.js"></script>
</body>
</html>
