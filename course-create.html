<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cr√©er une √©preuve ‚Äî MTB Points</title>
  <link rel="stylesheet" href="./css/style.css" />
  <style>
    .muted2{color:#64748b;font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .rowBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .msg{display:none;margin-top:14px}

    .ageBox{border:1px solid #e5e7eb;border-radius:16px;padding:12px;background:#fff}
    .ageHead{display:grid;grid-template-columns: 1fr 120px 120px;gap:10px;font-weight:900;color:#0f172a}
    .ageRow{display:grid;grid-template-columns: 1fr 120px 120px;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed #e5e7eb}
    .ageRow:last-child{border-bottom:0}
    .ageRow label{display:flex;gap:10px;align-items:flex-start;cursor:pointer}
    .ageRow input[type="checkbox"]{margin-top:3px}
    .ageRow input[type="number"]{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:12px}
    .bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar > div{height:100%;width:0%;background:#2563eb;border-radius:999px;transition:width .25s}
    .statusRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  </style>
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points ‚Äî Cr√©er une √©preuve</h1>
    <span class="pill"><span class="dot ok"></span> Rattach√©e √† un √©v√©nement</span>
  </div>

  <nav class="nav">
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html">√âv√©nements</a>
    <a href="races.html" class="active">√âpreuves</a>
    <a href="challengemtbpoints.html">Challenge</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="headerRight">
    <a class="btn ghost" id="btnBack" href="meetings.html">‚Üê Retour</a>
  </div>
</header>

<main class="wrap">
  <div class="card">

    <section class="hero">
      <div class="heroTop">
        <div style="min-width:280px;flex:1">
          <h2>Nouvelle √©preuve</h2>
          <div class="heroMeta">
            Une √©preuve est rattach√©e √† un √©v√©nement. La date est pr√©-remplie depuis l‚Äô√©v√©nement si possible.
          </div>
          <div class="heroDesc muted2" id="meetingHint"></div>
        </div>
        <div class="heroActions">
          <span class="pill"><span class="dot ok"></span> Multi-tours √¢ge/sexe</span>
          <span class="pill"><span class="dot"></span> Analyse GPX/OSM</span>
        </div>
      </div>
    </section>

    <!-- RATTACHEMENT -->
    <h3 class="sectionTitle" style="margin-top:18px;">Rattachement & date</h3>
    <div class="filters" style="grid-template-columns: 1.4fr 1fr 1fr; align-items:end;">
      <div>
        <label class="lbl">√âv√©nement <span class="req">*</span></label>
        <select id="meetingId" class="inp"></select>
        <div class="muted2">Les √©preuves cr√©√©es ici seront rattach√©es automatiquement.</div>
      </div>
      <div>
        <label class="lbl">Date de l‚Äô√©preuve <span class="req">*</span></label>
        <input id="date" class="inp" type="date" />
      </div>
      <div>
        <label class="lbl">Heure de d√©part</label>
        <input id="time" class="inp" type="time" />
      </div>
    </div>

    <!-- BLOC 1 : INFORMATIONS -->
    <h3 class="sectionTitle" style="margin-top:18px;">Bloc 1 ‚Äî Informations</h3>

    <div class="filters" style="grid-template-columns: 1.4fr 1fr 1fr; align-items:end;">
      <div>
        <label class="lbl">Nom de l‚Äô√©preuve <span class="req">*</span></label>
        <input id="name" class="inp" type="text" placeholder="Ex : 20 km / 30 km / XCO Open..." />
      </div>

      <div>
        <label class="lbl">Barri√®re horaire (optionnel)</label>
        <input id="cutoff" class="inp" type="text" placeholder="Ex : 02:30" />
      </div>

      <div>
        <label class="lbl">Cat√©gorie d‚Äô√©preuve</label>
        <select id="level" class="inp">
          <option value="">‚Äî</option>
          <option value="Locale">Locale</option>
          <option value="R√©gionale">R√©gionale</option>
          <option value="Nationale">Nationale</option>
          <option value="Internationale">Internationale</option>
        </select>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <div>
        <label class="lbl">Discipline</label>
        <select id="disc" class="inp">
          <option value="">‚Äî</option>
          <option value="XC">XC</option>
          <option value="Enduro">Enduro</option>
          <option value="DH">DH</option>
          <option value="Marathon">Marathon</option>
          <option value="Ultra">Ultra</option>
          <option value="Gravel">Gravel</option>
        </select>
      </div>
      <div>
        <label class="lbl">Type de v√©lo</label>
        <select id="ebike" class="inp">
          <option value="0">Musculaire</option>
          <option value="1">Assistance √©lectrique</option>
        </select>
      </div>
    </div>

    <div class="filters" style="grid-template-columns: 1fr 1fr 1fr 1fr; align-items:end; margin-top:12px;">
      <div>
        <label class="lbl">Lavage v√©los</label>
        <select id="wash" class="inp">
          <option value="">‚Äî</option>
          <option value="Oui">Oui</option>
          <option value="Non">Non</option>
        </select>
      </div>
      <div>
        <label class="lbl">Assistance m√©canique</label>
        <select id="mechanic" class="inp">
          <option value="">‚Äî</option>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
      <div>
        <label class="lbl">Ravitaillements</label>
        <select id="feeds" class="inp">
          <option value="">‚Äî</option>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
      <div>
        <label class="lbl">Sexe autoris√©</label>
        <select id="sexAllowed" class="inp">
          <option value="all">Mixte</option>
          <option value="M">Hommes</option>
          <option value="F">Femmes</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px;">
      <label class="lbl">Commentaire libre</label>
      <textarea id="comment" class="inp" rows="3" placeholder="Infos, consignes, parcours..."></textarea>
    </div>

    <!-- MULTI-TOURS -->
    <h3 class="sectionTitle" style="margin-top:18px;">Multi-tours par √¢ge & sexe (optionnel)</h3>
    <div class="ageBox">
      <div class="muted2" style="margin-bottom:10px;">
        Coche les cat√©gories concern√©es et indique le <b>nombre de tours</b> pour Hommes/Femmes.
        (Codes courts : U7, U9, ‚Ä¶, U23, SEN, M1‚Ä¶M9)
      </div>

      <div class="ageHead">
        <div>Cat√©gorie</div>
        <div>H (tours)</div>
        <div>F (tours)</div>
      </div>

      <div id="ageRows"></div>

      <div class="muted2" style="margin-top:10px;">
        Si tu ne coches rien : l‚Äô√©preuve est consid√©r√©e comme une seule distance ‚Äústandard‚Äù.
      </div>
    </div>

    <!-- BLOC 2 : ANALYSE GPX/OSM -->
    <h3 class="sectionTitle" style="margin-top:18px;">Bloc 2 ‚Äî Analyse GPX / OSM</h3>

    <div class="filters" style="grid-template-columns: 1.4fr 1fr 1fr; align-items:end;">
      <div>
        <label class="lbl">Trace GPX (optionnel)</label>
        <input id="gpxFile" class="inp" type="file" accept=".gpx,application/gpx+xml" />
        <div class="muted2">Si tu ajoutes un GPX : distance + D+ seront calcul√©s automatiquement.</div>
      </div>
      <div>
        <button class="btn" id="btnAnalyze" type="button">‚ö° Lancer l‚Äôanalyse</button>
      </div>
      <div>
        <button class="btn ghost" id="btnClearGPX" type="button">Effacer GPX</button>
      </div>
    </div>

    <div id="statusBox" class="empty" style="display:none; margin-top:14px;">
      <div class="statusRow">
        <span class="pill" id="statusPhase"><span class="dot"></span> ‚Äî</span>
        <span id="statusMsg" class="muted">‚Äî</span>
      </div>
      <div class="bar" style="margin-top:10px; display:none;" id="statusBarWrap" aria-label="progress">
        <div id="statusBar"></div>
      </div>
      <div class="muted2" style="margin-top:8px;" id="statusSub"></div>
    </div>

    <!-- ACTIONS -->
    <div class="rowBtns">
      <button class="btn primary" id="btnSave" type="button">Cr√©er l‚Äô√©preuve</button>
      <button class="btn" id="btnSaveAndNew" type="button">Cr√©er + ajouter une autre √©preuve</button>
      <button class="btn ghost" id="btnReset" type="button">R√©initialiser</button>
      <a class="btn ghost" href="meeting-create.html">Cr√©er l‚Äô√©v√©nement</a>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <a class="btn ok" id="btnViewRace" href="#" style="display:none;">üëÅÔ∏è Voir la fiche de l‚Äô√©preuve</a>
      <a class="btn ghost" href="meeting-create.html">Cr√©er l‚Äô√©v√©nement et ajouter une √©preuve</a>
    </div>

    <div id="msg" class="empty msg"></div>

  </div>
</main>

<script src="js/data.js"></script>
<script src="js/storage.js"></script>
<script src="js/gpx.js"></script>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const params = new URLSearchParams(location.search);

  const AGE_CATS = [
    { id:"U7",  label:"U7 (Poussin 7‚Äì8)" },
    { id:"U9",  label:"U9 (Pupille 9‚Äì10)" },
    { id:"U11", label:"U11 (Benjamin 11‚Äì12)" },
    { id:"U13", label:"U13 (Minime 13‚Äì14)" },
    { id:"U15", label:"U15 (Cadet 15‚Äì16)" },
    { id:"U17", label:"U17 (Junior 17‚Äì18)" },
    { id:"U23", label:"U23 (Espoir 19‚Äì22)" },
    { id:"SEN", label:"SEN (Senior/√âlite 19‚Äì34)" },
    { id:"M1",  label:"M1 (35‚Äì39)" },
    { id:"M2",  label:"M2 (40‚Äì44)" },
    { id:"M3",  label:"M3 (45‚Äì49)" },
    { id:"M4",  label:"M4 (50‚Äì54)" },
    { id:"M5",  label:"M5 (55‚Äì59)" },
    { id:"M6",  label:"M6 (60‚Äì64)" },
    { id:"M7",  label:"M7 (65‚Äì69)" },
    { id:"M8",  label:"M8 (70‚Äì74)" },
    { id:"M9",  label:"M9 (75‚Äì79)" }
  ];

  // -------- UI helpers
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function showMsg(html, ok=true){
    const el = $("msg");
    if (!el) return;
    el.style.display = html ? "block" : "none";
    el.innerHTML = html ? (ok ? `‚úÖ ${html}` : `‚ùå ${html}`) : "";
  }

  function showStatusBox(on){
    const box = $("statusBox");
    if (box) box.style.display = on ? "block" : "none";
  }
  function setStatus(phase, msg, prog=null, sub=""){
    showStatusBox(true);
    $("statusPhase").innerHTML = `<span class="dot"></span> ${esc(phase || "‚Äî")}`;
    $("statusMsg").textContent = msg || "‚Äî";
    $("statusSub").textContent = sub || "";
    const wrap = $("statusBarWrap");
    const bar = $("statusBar");
    if (prog == null){
      wrap.style.display = "none";
      bar.style.width = "0%";
    } else {
      wrap.style.display = "block";
      bar.style.width = `${Math.max(0, Math.min(100, prog))}%`;
    }
  }

  // -------- meeting helpers (compat storage.js)
  function listMeetingsSafe(){
    if (typeof window.listMeetings === "function") return window.listMeetings();
    try{
      const raw = localStorage.getItem("mtb.meetings.v1");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(_){ return []; }
  }
  function findMeetingSafe(id){
    if (!id) return null;
    if (typeof window.findMeeting === "function") return window.findMeeting(id);
    return listMeetingsSafe().find(m => m && m.id === id) || null;
  }

  function initMeetingSelect(){
    const sel = $("meetingId");
    if (!sel) return;

    const meetings = listMeetingsSafe().slice()
      .sort((a,b)=> String(b?.date||"").localeCompare(String(a?.date||"")));

    sel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` + meetings.map(m => {
      const d = m.date ? ` ‚Ä¢ ${esc(m.date)}` : "";
      return `<option value="${esc(m.id)}">${esc(m.name || "√âv√©nement")}${d}</option>`;
    }).join("");

    const mid = params.get("meetingId");
    if (mid){
      sel.value = mid;
      applyMeetingDefaults(mid);
    } else {
      $("meetingHint").textContent = "S√©lectionne un √©v√©nement.";
    }

    sel.addEventListener("change", ()=> applyMeetingDefaults(sel.value));
  }

  function applyMeetingDefaults(meetingId){
    const meeting = findMeetingSafe(meetingId);
    const hint = $("meetingHint");
    if (!meeting){
      if (hint) hint.textContent = "‚ö†Ô∏è S√©lectionne un √©v√©nement.";
      return;
    }

    const start = meeting.date || "";
    const end = meeting.endDate || "";

    if (hint){
      hint.textContent = end
        ? `üìÖ Plage √©v√©nement : ${start || "‚Äî"} ‚Üí ${end}`
        : `üìÖ Date √©v√©nement : ${start || "‚Äî"}`;
    }

    // back button
    $("btnBack").href = `meeting.html?id=${encodeURIComponent(meeting.id)}`;

    // date par d√©faut + bornage
    const dateEl = $("date");
    dateEl.min = start || "";
    dateEl.max = end || start || "";
    if (!dateEl.value && start) dateEl.value = start;
    if (start && dateEl.value && dateEl.value < start) dateEl.value = start;
    if (end && dateEl.value && dateEl.value > end) dateEl.value = start || end;
  }

  // -------- age rows (laps)
  function renderAgeRows(){
    const box = $("ageRows");
    box.innerHTML = AGE_CATS.map(cat => `
      <div class="ageRow">
        <div>
          <label>
            <input type="checkbox" data-cat="${esc(cat.id)}" class="catOn" />
            <div>
              <div style="font-weight:900">${esc(cat.id)}</div>
              <div class="muted2">${esc(cat.label)}</div>
            </div>
          </label>
        </div>
        <div><input type="number" min="0" step="1" placeholder="‚Äî" class="lapsM" data-cat="${esc(cat.id)}" disabled></div>
        <div><input type="number" min="0" step="1" placeholder="‚Äî" class="lapsF" data-cat="${esc(cat.id)}" disabled></div>
      </div>
    `).join("");

    box.querySelectorAll(".catOn").forEach(chk => {
      chk.addEventListener("change", () => {
        const id = chk.getAttribute("data-cat");
        const m = box.querySelector(`.lapsM[data-cat="${CSS.escape(id)}"]`);
        const f = box.querySelector(`.lapsF[data-cat="${CSS.escape(id)}"]`);
        const on = chk.checked;
        if (m) { m.disabled = !on; if (!on) m.value = ""; }
        if (f) { f.disabled = !on; if (!on) f.value = ""; }
      });
    });
  }

  function collectLapsByCategorySex(){
    const box = $("ageRows");
    const out = {};
    box.querySelectorAll(".catOn").forEach(chk => {
      if (!chk.checked) return;
      const id = chk.getAttribute("data-cat");
      const m = box.querySelector(`.lapsM[data-cat="${CSS.escape(id)}"]`);
      const f = box.querySelector(`.lapsF[data-cat="${CSS.escape(id)}"]`);
      const mVal = (m && m.value !== "") ? Number(m.value) : null;
      const fVal = (f && f.value !== "") ? Number(f.value) : null;

      out[id] = {
        M: Number.isFinite(mVal) ? mVal : null,
        F: Number.isFinite(fVal) ? fVal : null
      };
    });
    return Object.keys(out).length ? out : null;
  }

  // -------- analysis cache
  let ANALYSIS = null;

  function clearGpx(){
    ANALYSIS = null;
    $("gpxFile").value = "";
    showStatusBox(false);
    showMsg("");
  }

  async function analyzeGpx(){
    const f = $("gpxFile")?.files?.[0];
    if (!f){
      showMsg("Ajoute un fichier GPX puis lance l‚Äôanalyse.", false);
      return;
    }

    const TIMEOUT_MS = 25000;
    const started = Date.now();

    setStatus("Pr√©paration", "Lecture du fichier‚Ä¶", 8, "D√©marrage‚Ä¶");

    let timeoutHandle = null;
    const timeoutPromise = new Promise((_, rej) => {
      timeoutHandle = setTimeout(() => rej(new Error("timeout")), TIMEOUT_MS);
    });

    // petite animation
    const steps = [
      "Lecture GPX‚Ä¶",
      "Calcul distance / D+‚Ä¶",
      "Analyse pentes‚Ä¶",
      "Interrogation OSM‚Ä¶",
      "Fusion segments‚Ä¶",
      "Finalisation‚Ä¶"
    ];
    let si = 0;
    const anim = setInterval(()=>{
      si = (si+1) % steps.length;
      $("statusSub").textContent = steps[si];
    }, 900);

    try{
      const ticker = setInterval(() => {
        const t = Date.now() - started;
        const p = Math.min(92, 10 + Math.round((t / TIMEOUT_MS) * 75));
        setStatus("Analyse", "Calcul en cours‚Ä¶", p, $("statusSub").textContent || "");
      }, 550);

      const work = (async () => {
        // priorit√©: functions si tu les as dans gpx.js
        if (typeof window.analyzeGpxFile === "function"){
          return await window.analyzeGpxFile(f);
        }
        // sinon: si ton gpx.js expose analyzeGPX(file, opts)
        if (typeof window.analyzeGPX === "function"){
          return await window.analyzeGPX(f, { keepPoints:true });
        }
        // fallback: texte
        const txt = await f.text();
        if (typeof window.analyzeGpxText === "function"){
          return await window.analyzeGpxText(txt);
        }
        return { fileName: f.name };
      })();

      const res = await Promise.race([work, timeoutPromise]);
      clearTimeout(timeoutHandle);
      clearInterval(ticker);
      clearInterval(anim);

      ANALYSIS = {
        fileName: f.name,
        analyzedAt: Date.now(),
        distanceKm: (res?.distanceKm ?? res?.stats?.distanceKm ?? null),
        dplusM: (res?.dplusM ?? res?.stats?.dplusM ?? null),
        surfaceEstimate: (res?.surfaceEstimate ?? res?.surface ?? null),
        physScore: (res?.phys?.score ?? res?.physScore ?? null),
        techScore: (res?.tech?.techScore ?? res?.techScore ?? null),
        globalScore: (res?.globalScore ?? null),
        points: (res?.points ?? res?.track ?? null),
        raw: res || null
      };

      setStatus("Termin√©", "Analyse termin√©e.", 100, "Tu peux enregistrer l‚Äô√©preuve.");
      showMsg("Analyse GPX/OSM termin√©e.", true);
    }catch(e){
      clearTimeout(timeoutHandle);
      clearInterval(anim);

      if (e?.message === "timeout"){
        setStatus("Timeout", "Analyse trop longue.", null, "Tu peux r√©essayer (ou enregistrer sans GPX).");
        showMsg("Timeout analyse GPX/OSM.", false);
      } else {
        setStatus("Erreur", "Analyse impossible.", null, "V√©rifie le GPX ou le serveur.");
        showMsg("Erreur analyse GPX.", false);
      }
      console.warn(e);
      ANALYSIS = null;
    }
  }

  // -------- save race (storage compatible)
  function makeIdFromName(name){
    const base = String(name||"").trim().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    return `${base || "race"}-${Date.now()}`;
  }
  function normalizeDate(s){
    const v = String(s||"").trim();
    return /^\d{4}-\d{2}-\d{2}$/.test(v) ? v : null;
  }

  function upsertRaceSafe(r){
    if (typeof window.upsertRace === "function") return window.upsertRace(r);
    const KEY = "mtb.races.v1";
    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem(KEY)||"[]"); }catch(_){ arr=[]; }
    if (!Array.isArray(arr)) arr = [];
    const i = arr.findIndex(x => x && x.id === r.id);
    if (i >= 0) arr[i] = r; else arr.unshift(r);
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  function attachRaceToMeeting(meetingId, raceId){
    const m = findMeetingSafe(meetingId);
    if (!m) return;
    m.raceIds = Array.isArray(m.raceIds) ? m.raceIds : [];
    if (!m.raceIds.includes(raceId)) m.raceIds.push(raceId);

    if (typeof window.upsertMeeting === "function") return window.upsertMeeting(m);
    const KEY = "mtb.meetings.v1";
    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem(KEY)||"[]"); }catch(_){ arr=[]; }
    if (!Array.isArray(arr)) arr=[];
    const idx = arr.findIndex(x => x && x.id === m.id);
    if (idx >= 0) arr[idx] = m; else arr.unshift(m);
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  function validate(){
    if (!$("meetingId").value) return "√âv√©nement obligatoire.";
    if (!normalizeDate($("date").value)) return "Date d‚Äô√©preuve obligatoire.";
    if (!$("name").value.trim()) return "Nom d‚Äô√©preuve obligatoire.";
    return null;
  }

  function buildRace(){
    const meetingId = $("meetingId").value;
    const meeting = findMeetingSafe(meetingId);

    const lapsByCategorySex = collectLapsByCategorySex();

    return {
      id: makeIdFromName($("name").value.trim()),
      meetingId,
      meetingName: meeting?.name || null,

      date: normalizeDate($("date").value),
      time: $("time").value || null,

      name: $("name").value.trim(),
      cutoffTime: $("cutoff").value.trim() || null,
      level: $("level").value || null,
      disc: $("disc").value || null,

      ebike: $("ebike").value === "1",
      bikeWash: $("wash").value || null,      // Oui/Non/ null
      mechAssist: $("mechanic").value || null, // "0"/"1"/"2"/null
      feeds: $("feeds").value || null,         // "0"/"1"/"2"/null
      sexAllowed: $("sexAllowed").value || "all",

      comment: $("comment").value.trim() || null,

      // meeting URL (utile sur race.html)
      meetingUrl: meeting?.url || null,

      // analyse (si faite) ‚Äî stock√©e pour la fiche √©preuve
      analysis: ANALYSIS ? {
        fileName: ANALYSIS.fileName,
        distanceKm: ANALYSIS.distanceKm ?? null,
        dplusM: ANALYSIS.dplusM ?? null,
        surfaceEstimate: ANALYSIS.surfaceEstimate ?? null,
        physScore: ANALYSIS.physScore ?? null,
        techScore: ANALYSIS.techScore ?? null,
        globalScore: ANALYSIS.globalScore ?? null,
        points: ANALYSIS.points ?? null
      } : null,

      // champs directs utilis√©s par race.html
      distanceKm: ANALYSIS?.distanceKm ?? null,
      dplusM: ANALYSIS?.dplusM ?? null,
      surfaceEstimate: ANALYSIS?.surfaceEstimate ?? null,
      physScore: ANALYSIS?.physScore ?? null,
      techScore: ANALYSIS?.techScore ?? null,
      globalScore: ANALYSIS?.globalScore ?? null,
      gpx: ANALYSIS ? { fileName: ANALYSIS.fileName, points: ANALYSIS.points ?? null } : null,

      lapsByCategorySex, // { U15:{M:4,F:3}, M3:{M:5,F:4} } ou null

      createdAt: Date.now(),
      isPublished: false
    };
  }

  function afterSave(race){
    $("btnViewRace").href = `race.html?id=${encodeURIComponent(race.id)}`;
    $("btnViewRace").style.display = "inline-flex";
  }

  function resetForm(keepMeeting=true){
    const keepMid = keepMeeting ? $("meetingId").value : "";
    const keepDate = keepMeeting ? $("date").value : "";

    ["name","cutoff","time","comment"].forEach(id => $(id).value = "");
    ["level","disc","wash","mechanic","feeds"].forEach(id => $(id).value = "");
    $("ebike").value = "0";
    $("sexAllowed").value = "all";

    // laps
    document.querySelectorAll(".catOn").forEach(chk => chk.checked = false);
    document.querySelectorAll(".lapsM,.lapsF").forEach(inp => { inp.value = ""; inp.disabled = true; });

    // gpx
    clearGpx();

    $("btnViewRace").style.display = "none";
    $("btnViewRace").href = "#";

    showMsg("");
    if (keepMeeting){
      $("meetingId").value = keepMid;
      applyMeetingDefaults(keepMid);
      $("date").value = keepDate;
    }
  }

  function save(thenNew){
    $("btnViewRace").style.display = "none";
    showMsg("");

    const err = validate();
    if (err){ showMsg(err, false); return; }

    const race = buildRace();
    upsertRaceSafe(race);
    attachRaceToMeeting(race.meetingId, race.id);

    showMsg(`√âpreuve cr√©√©e : <b>${esc(race.name)}</b>`, true);
    afterSave(race);

    if (thenNew){
      setTimeout(()=> resetForm(true), 80);
    }
  }

  // -------- init
  initMeetingSelect();
  renderAgeRows();

  // events
  $("btnAnalyze").addEventListener("click", analyzeGpx);
  $("btnClearGPX").addEventListener("click", clearGpx);

  $("btnSave").addEventListener("click", ()=> save(false));
  $("btnSaveAndNew").addEventListener("click", ()=> save(true));
  $("btnReset").addEventListener("click", ()=> resetForm(true));

})();
</script>

</body>
</html>
