<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Événement — MTB Points</title>
  <link rel="stylesheet" href="css/style.css" />

  <style>
    :root{
      --bg:#f4f4f4;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#667085;
      --muted2:#64748b;
      --border:#e5e7eb;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --ok:#16a34a;
      --warn:#ea580c;
      --err:#dc2626;
      --shadow:0 10px 30px rgba(2,6,23,.10);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}

    /* Header */
    header.header{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.90);
      backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    header.header h1{margin:0;font-size:18px;letter-spacing:.2px}
    nav{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    nav a{
      text-decoration:none;
      padding:8px 10px;border-radius:10px;
      color:var(--blue);
      font-weight:800;font-size:13px;
    }
    nav a:hover{background:#eff6ff}
    nav a.active{background:#eff6ff;color:var(--blue2)}
    .lang{display:flex;gap:8px;align-items:center}
    .lang .btn{
      padding:8px 10px;border-radius:10px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:900;font-size:12px;
    }

    /* Layout */
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:18px;
      box-shadow:var(--shadow);
    }

    /* Hero */
    .hero{
      border-radius:22px;
      padding:18px;
      border:1px solid var(--border);
      background:
        radial-gradient(900px 260px at 12% 0%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(700px 240px at 95% 10%, rgba(16,185,129,.12), transparent 60%),
        #fff;
    }
    .heroTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .hero h2{margin:0;font-size:24px;letter-spacing:-.25px}
    .hero .meta{margin-top:8px;color:#334155;line-height:1.55}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;font-size:12px;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#94a3b8;display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.err{background:var(--err)}
    .desc{
      margin-top:10px;
      color:var(--muted2);
      font-size:13px;
      line-height:1.6;
    }

    /* Grid KPIs */
    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      margin-top:14px;
    }
    @media(max-width:900px){.kpiGrid{grid-template-columns:1fr}}
    .kpi{
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    .kpi .label{color:var(--muted);font-size:12px;font-weight:900;letter-spacing:.02em;text-transform:uppercase}
    .kpi .value{margin-top:6px;font-size:26px;font-weight:1000;letter-spacing:-.4px}
    .kpi .sub{margin-top:4px;color:var(--muted);font-size:12px}
    .bar{
      margin-top:10px;height:10px;border-radius:999px;background:#f1f5f9;border:1px solid var(--border);overflow:hidden;
    }
    .bar > div{height:100%;width:0%}
    /* no fixed colors requirement here; we keep neutral via gradient-like shading */
    .bar > div{background:linear-gradient(90deg,#93c5fd,#22c55e)}

    /* Sections */
    h3.section{margin:16px 0 10px 0;font-size:16px;letter-spacing:-.15px}
    .muted{color:var(--muted)}
    label{display:block;font-weight:900;font-size:12px;color:#0f172a}
    input,select{
      width:100%;
      padding:10px;
      margin-top:6px;
      border:1px solid #cbd5e1;
      border-radius:12px;
      background:#fff;
    }
    input::placeholder{color:#94a3b8}

    .filters{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr 180px;
      gap:10px;
      align-items:end;
    }
    @media(max-width:1050px){
      .filters{grid-template-columns:1fr 1fr; }
      .filters .spanAll{grid-column:1/-1}
    }

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:900;color:var(--text);
      text-decoration:none;
      transition:transform .12s ease, box-shadow .12s ease;
      width:100%;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(2,6,23,.08)}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.primary:hover{background:var(--blue2);border-color:var(--blue2)}

    .hintRow{
      margin-top:10px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }

    /* Mini chart */
    #miniChart{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
      overflow:auto;
    }
    .spark{
      height:90px;
      display:flex;gap:4px;align-items:flex-end;
      min-width:420px;
    }
    .spark .b{
      flex:1;
      min-width:6px;
      border-radius:8px;
      border:1px solid rgba(2,6,23,.08);
      background:linear-gradient(180deg, rgba(37,99,235,.25), rgba(37,99,235,.08));
    }
    .sparkMeta{margin-top:8px;color:var(--muted);font-size:12px}

    /* List races */
    .list{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
      margin-top:10px;
    }
    @media(max-width:900px){.list{grid-template-columns:1fr}}
    .item{
      display:block;
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      background:#fff;
      text-decoration:none;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .item:hover{
      transform:translateY(-2px);
      box-shadow:0 16px 28px rgba(2,6,23,.10);
      border-color:#dbeafe;
    }
    .topline{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap}
    .title{font-weight:1000;font-size:16px;letter-spacing:-.2px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:#f1f5f9;border:1px solid var(--border);
      font-weight:900;font-size:12px;color:#0f172a;
      white-space:nowrap;
    }
    .metaLine{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.5}
    .miniRow{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    .miniPill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);background:#fff;font-weight:900;font-size:12px;
    }
    .empty{
      margin-top:10px;
      border:1px dashed var(--border);
      border-radius:18px;
      padding:14px;
      color:var(--muted);
      background:#fff;
    }

    /* Accessibility focus */
    a:focus, button:focus, input:focus, select:focus{
      outline:3px solid rgba(37,99,235,.25);
      outline-offset:2px;
    }
  </style>
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points — Événement</h1>
    <span class="pill"><span class="dot"></span><span id="countPill">0</span> épreuve(s)</span>
  </div>

  <nav>
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html" class="active">Événements</a>
    <a href="challengemtbpoints.html">Challenge</a>
    <a href="reglement.html">Règlement</a>
    <a href="methodologie.html">Méthodologie</a>
    <a href="about.html">À propos</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="lang">
    <button class="btn" id="btnFR" type="button">FR</button>
    <button class="btn" id="btnEN" type="button">EN</button>
  </div>
</header>

<main class="wrap">
  <div class="card">

    <!-- HERO -->
    <section class="hero">
      <div class="heroTop">
        <div style="min-width:260px;flex:1">
          <h2 id="mName">—</h2>
          <div class="meta" id="mMeta">—</div>
          <div class="desc" id="mComment"></div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start">
          <span class="pill"><span class="dot ok"></span> Résumé auto</span>
          <span class="pill"><span class="dot"></span> Filtres</span>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <h3 class="section">Résumé global</h3>
    <div class="kpiGrid">
      <div class="kpi">
        <div class="label">Épreuves (filtrées)</div>
        <div class="value" id="kpiCount">—</div>
        <div class="sub" id="kpiRange">—</div>
      </div>

      <div class="kpi">
        <div class="label">Difficulté moyenne</div>
        <div class="value"><span id="kpiGlobal">—</span><span class="muted"> /100</span></div>
        <div class="sub">≈ <strong id="kpiGlobal5">—</strong> / 5</div>
        <div class="bar" aria-label="barre difficulté">
          <div id="kpiGlobalBar"></div>
        </div>
      </div>

      <div class="kpi">
        <div class="label">Épreuve la plus difficile</div>
        <div class="value" style="font-size:16px;line-height:1.2;">
          <a id="kpiHardestLink" href="#" style="text-decoration:none;color:var(--blue);font-weight:1000;">—</a>
        </div>
        <div class="sub" id="kpiHardestScore">—</div>
      </div>

      <div class="kpi">
        <div class="label">Moyenne Physique</div>
        <div class="value"><span id="kpiPhys">—</span><span class="muted"> /100</span></div>
        <div class="sub">ScorePhys moyen</div>
      </div>

      <div class="kpi">
        <div class="label">Moyenne Technique</div>
        <div class="value"><span id="kpiTech">—</span><span class="muted"> /100</span></div>
        <div class="sub">ScoreTech moyen</div>
      </div>

      <div class="kpi">
        <div class="label">Participants (total)</div>
        <div class="value" id="kpiParticipants">—</div>
        <div class="sub">Somme des participants renseignés</div>
      </div>
    </div>

    <!-- FILTERS -->
    <h3 class="section" style="margin-top:18px;">Filtres & tri</h3>
    <div class="filters">
      <div class="spanAll" style="grid-column:1/3">
        <label for="q">Recherche</label>
        <input id="q" type="text" placeholder="Nom, lieu..." />
      </div>

      <div>
        <label for="fDisc">Discipline</label>
        <select id="fDisc">
          <option value="">Toutes</option>
          <option value="XC">XC</option>
          <option value="Enduro">Enduro</option>
          <option value="DH">DH</option>
          <option value="Gravel">Gravel</option>
          <option value="Marathon">Marathon</option>
          <option value="Ultra">Ultra</option>
        </select>
      </div>

      <div>
        <label for="fEbike">Type vélo</label>
        <select id="fEbike">
          <option value="">Tous</option>
          <option value="0">Musculaire</option>
          <option value="1">Assistance électrique</option>
        </select>
      </div>

      <div>
        <label for="minGlobal">Difficulté min (Global ≥ <span id="minGlobalVal">0</span>)</label>
        <input id="minGlobal" type="range" min="0" max="100" value="0" />
      </div>

      <div>
        <label for="sortBy">Tri</label>
        <select id="sortBy">
          <option value="global_desc">Difficulté (Global) ↓</option>
          <option value="global_asc">Difficulté (Global) ↑</option>
          <option value="date_desc">Plus récentes</option>
          <option value="date_asc">Plus anciennes</option>
          <option value="distance_desc">Distance ↓</option>
          <option value="name_asc">Nom A→Z</option>
        </select>
      </div>

      <div>
        <button id="clearBtn" class="btn primary" type="button">Réinitialiser</button>
      </div>

      <div class="hintRow" style="grid-column:1/-1;">
        <div>Résultats : <strong id="countFiltered">0</strong></div>
        <div class="muted">Astuce : clique sur une épreuve pour ouvrir la fiche.</div>
      </div>
    </div>

    <!-- CHART -->
    <h3 class="section" style="margin-top:18px;">Graph rapide (Global)</h3>
    <div id="miniChart" class="muted">
      <div class="spark" id="spark"></div>
      <div class="sparkMeta" id="sparkMeta">—</div>
    </div>

    <!-- LIST -->
    <h3 class="section" style="margin-top:18px;">Épreuves disponibles</h3>
    <div id="races" class="list"></div>
    <div id="emptyBox" class="empty" style="display:none;">Aucune épreuve ne correspond aux filtres.</div>

  </div>
</main>

<script src="js/data.js"></script>
<script src="js/storage.js"></script>
<script src="js/meeting.js"></script>

<script>
/*
  Ce script est "UI only" :
  - Il ne remplace pas la logique de meeting.js, mais améliore l’UI (range label + sparkline).
  - meeting.js doit déjà remplir/mettre à jour :
    mName, mMeta, mComment, kpiCount, kpiRange, kpiGlobal, kpiGlobal5, kpiGlobalBar,
    kpiHardestLink, kpiHardestScore, kpiPhys, kpiTech, kpiParticipants,
    countFiltered, races, etc.
  - Si ton meeting.js ne fait pas tout ça, ce script n’empêche rien : il ajoute juste la couche visuelle.
*/

(function(){
  const $ = (id)=>document.getElementById(id);

  // range label live
  const rg = $("minGlobal");
  const rgVal = $("minGlobalVal");
  if (rg && rgVal) {
    const sync = ()=> rgVal.textContent = String(rg.value || 0);
    rg.addEventListener("input", sync);
    sync();
  }

  // observe list changes and build a tiny bar chart from visible items (best-effort)
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
  function toNum(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }

  function tryExtractGlobalScores(){
    // best-effort: look for "Global" like patterns inside items text
    const list = $("races");
    if (!list) return [];
    const items = Array.from(list.querySelectorAll(".item, a, .race, .row")).slice(0, 32);
    const out = [];
    for (const el of items) {
      const t = (el.textContent || "").replace(/\s+/g," ").trim();
      // try to capture "... 78/100" or "Global 78" etc.
      let m = t.match(/(\b\d{1,3})\s*\/\s*100\b/);
      if (!m) m = t.match(/\bglobal\b[^0-9]*([0-9]{1,3})\b/i);
      if (m) {
        const v = clamp(Number(m[1]), 0, 100);
        out.push(v);
      }
    }
    return out;
  }

  function renderSpark(scores){
    const spark = $("spark");
    const meta = $("sparkMeta");
    if (!spark || !meta) return;

    spark.innerHTML = "";
    if (!scores.length) {
      meta.textContent = "Graph indisponible (pas assez d’infos).";
      return;
    }

    const max = Math.max(...scores, 1);
    const min = Math.min(...scores, 0);
    const avg = Math.round(scores.reduce((s,x)=>s+x,0)/scores.length);

    for (const v of scores) {
      const b = document.createElement("div");
      b.className = "b";
      b.style.height = (12 + (v / max) * 78) + "px";
      b.title = v + "/100";
      spark.appendChild(b);
    }
    meta.textContent = `Échantillon: ${scores.length} • min ${min}/100 • moy ${avg}/100 • max ${max}/100`;
  }

  // Observe DOM changes in races list to update spark (meeting.js likely renders async)
  const races = $("races");
  if (races && window.MutationObserver) {
    const obs = new MutationObserver(() => {
      renderSpark(tryExtractGlobalScores());
      const countEl = $("countFiltered");
      const pillEl = $("countPill");
      if (countEl && pillEl) pillEl.textContent = (countEl.textContent || "0").trim();
    });
    obs.observe(races, { childList:true, subtree:true });
  }

  // First paint
  renderSpark(tryExtractGlobalScores());
})();
</script>

</body>
</html>


