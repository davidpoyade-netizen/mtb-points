<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√âv√©nement ‚Äî MTB Points</title>
  <link rel="stylesheet" href="./css/style.css" />
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points ‚Äî √âv√©nement</h1>
    <span class="pill" id="pillCount"><span class="dot"></span> <span id="pillCountTxt">0</span> √©preuve(s)</span>
  </div>

  <nav class="nav">
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html" class="active">√âv√©nements</a>
    <a href="events.html">√âpreuves</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="headerRight" style="display:flex;gap:8px;flex-wrap:wrap;">
    <a class="btn ghost" href="meetings.html">‚Üê Retour</a>
    <a class="btn primary" id="btnCreateRaceTop" href="#" style="display:none;">+ Cr√©er une √©preuve</a>
  </div>
</header>

<main class="wrap">
  <div class="card">

    <!-- HERO -->
    <section class="hero">
      <div class="heroTop">
        <div style="min-width:280px;flex:1">
          <h2 id="mName">‚Äî</h2>
          <div class="heroMeta" id="mMeta">‚Äî</div>
          <div class="heroDesc" id="mComment" style="display:none;"></div>
          <div id="alertBox" class="empty" style="display:none; margin-top:12px;"></div>
        </div>

        <div class="heroActions" style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start">
          <span class="pill"><span class="dot ok"></span> √âv√©nement</span>
          <span class="pill"><span class="dot"></span> √âpreuves rattach√©es</span>
          <a class="btn primary" id="btnCreateRaceHero" href="#" style="display:none;">+ Cr√©er une √©preuve</a>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <h3 class="sectionTitle" style="margin-top:18px;">R√©sum√©</h3>
    <div class="kpiGrid">
      <div class="kpi">
        <div class="kpiLabel">√âpreuves (filtr√©es)</div>
        <div class="kpiValue" id="kpiCount">‚Äî</div>
        <div class="kpiSub" id="kpiRange">‚Äî</div>
      </div>

      <div class="kpi">
        <div class="kpiLabel">Difficult√© moyenne</div>
        <div class="kpiValue"><span id="kpiGlobal">‚Äî</span><span class="muted"> /100</span></div>
        <div class="kpiSub" id="kpiGlobalSub">‚Äî</div>
      </div>

      <div class="kpi">
        <div class="kpiLabel">Moyenne Physique</div>
        <div class="kpiValue"><span id="kpiPhys">‚Äî</span><span class="muted"> /100</span></div>
        <div class="kpiSub">ScorePhys moyen</div>
      </div>

      <div class="kpi">
        <div class="kpiLabel">Moyenne Technique</div>
        <div class="kpiValue"><span id="kpiTech">‚Äî</span><span class="muted"> /100</span></div>
        <div class="kpiSub">TechScore (si dispo)</div>
      </div>

      <div class="kpi">
        <div class="kpiLabel">Participants (total)</div>
        <div class="kpiValue" id="kpiParticipants">‚Äî</div>
        <div class="kpiSub">Somme des participants</div>
      </div>

      <div class="kpi">
        <div class="kpiLabel">√âpreuve la plus difficile</div>
        <div class="kpiValue" style="font-size:16px;line-height:1.2;">
          <a id="kpiHardestLink" href="#" style="text-decoration:none;">‚Äî</a>
        </div>
        <div class="kpiSub" id="kpiHardestScore">‚Äî</div>
      </div>
    </div>

    <!-- FILTERS -->
    <h3 class="sectionTitle" style="margin-top:18px;">Filtres & tri</h3>
    <div class="filters" style="grid-template-columns: 1.4fr 1fr 1fr 1fr 1fr 180px;">
      <div class="spanAll" style="grid-column:1/3">
        <label for="q">Recherche</label>
        <input id="q" type="text" placeholder="Nom, commentaire‚Ä¶" />
      </div>

      <div>
        <label for="fDisc">Discipline</label>
        <select id="fDisc">
          <option value="">Toutes</option>
          <option value="XC">XC</option>
          <option value="Enduro">Enduro</option>
          <option value="DH">DH</option>
          <option value="Gravel">Gravel</option>
          <option value="Marathon">Marathon</option>
          <option value="Ultra">Ultra</option>
        </select>
      </div>

      <div>
        <label for="fEbike">Type v√©lo</label>
        <select id="fEbike">
          <option value="">Tous</option>
          <option value="0">Musculaire</option>
          <option value="1">Assistance √©lectrique</option>
        </select>
      </div>

      <div>
        <label for="minGlobal">Difficult√© min (‚â• <span id="minGlobalVal">0</span>)</label>
        <input id="minGlobal" type="range" min="0" max="100" value="0" />
      </div>

      <div>
        <label for="sortBy">Tri</label>
        <select id="sortBy">
          <option value="date_desc">Plus r√©centes</option>
          <option value="date_asc">Plus anciennes</option>
          <option value="global_desc">Difficult√© ‚Üì</option>
          <option value="global_asc">Difficult√© ‚Üë</option>
          <option value="distance_desc">Distance ‚Üì</option>
          <option value="name_asc">Nom A‚ÜíZ</option>
        </select>
      </div>

      <div>
        <button class="btn primary" id="btnResetFilters" type="button">R√©initialiser</button>
      </div>

      <div class="hintRow" style="grid-column:1/-1;">
        <div>R√©sultats : <strong id="countFiltered">0</strong></div>
        <div class="muted">Astuce : clique sur une √©preuve pour ouvrir la fiche.</div>
      </div>
    </div>

    <!-- LIST -->
    <h3 class="sectionTitle" style="margin-top:18px;">√âpreuves de l‚Äô√©v√©nement</h3>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <a class="btn primary" id="btnCreateRaceBottom" href="#" style="display:none;">+ Cr√©er une √©preuve</a>
      <a class="btn" href="events.html">Voir toutes les √©preuves</a>
    </div>

    <div id="races" class="list" style="margin-top:12px;"></div>
    <div id="emptyBox" class="empty" style="display:none;">Aucune √©preuve ne correspond aux filtres.</div>

  </div>
</main>

<script src="js/data.js"></script>
<script src="js/storage.js"></script>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const params = new URLSearchParams(location.search);

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function num(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }
  function fmt(n){ return (n == null) ? "‚Äî" : String(n); }
  function fmt1(n){ return (n == null) ? "‚Äî" : String(Math.round(n * 10)/10); }

  function setAlert(html){
    const box = $("alertBox");
    if (!box) return;
    box.style.display = html ? "block" : "none";
    box.innerHTML = html || "";
  }

  // ---- Storage adapters (prefer storage.js; fallback localStorage keys used in earlier pages)
  function listMeetingsSafe(){
    if (typeof window.listMeetings === "function") return window.listMeetings();
    if (typeof window.getMeetings === "function") return window.getMeetings();
    try {
      const raw = localStorage.getItem("mtb.meetings.v1");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch(_){ return []; }
  }
  function findMeetingSafe(id){
    if (!id) return null;
    if (typeof window.findMeeting === "function") return window.findMeeting(id);
    return listMeetingsSafe().find(m => m && m.id === id) || null;
  }
  function listRacesSafe(){
    if (typeof window.listRaces === "function") return window.listRaces();
    if (typeof window.getRaces === "function") return window.getRaces();
    try {
      const raw = localStorage.getItem("mtb.races.v1");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch(_){ return []; }
  }

  // ---- meeting id
  const meetingId = params.get("id");
  if (!meetingId){
    setAlert(`‚ùå ID d‚Äô√©v√©nement manquant. Retourne √† la liste des √©v√©nements : <a href="meetings.html">meetings.html</a>`);
    return;
  }

  const meeting = findMeetingSafe(meetingId);
  if (!meeting){
    setAlert(`‚ùå √âv√©nement introuvable (id: <code>${esc(meetingId)}</code>).`);
    return;
  }

  // ---- render meeting header
  $("mName").textContent = meeting.name || "√âv√©nement";
  const start = meeting.date || "‚Äî";
  const end = meeting.endDate || null;
  const range = end ? `${start} ‚Üí ${end}` : start;

  const metaBits = [];
  metaBits.push(`üìÖ ${range}`);
  if (meeting.location) metaBits.push(`üìç ${meeting.location}`);
  $("mMeta").textContent = metaBits.join(" ‚Ä¢ ") || "‚Äî";

  if (meeting.comment){
    $("mComment").style.display = "block";
    $("mComment").textContent = meeting.comment;
  }

  // ---- create race buttons
  const createUrl = `course-create.html?meetingId=${encodeURIComponent(meetingId)}`;
  ["btnCreateRaceTop","btnCreateRaceHero","btnCreateRaceBottom"].forEach(id=>{
    const el = $(id);
    if (!el) return;
    el.href = createUrl;
    el.style.display = "inline-flex";
  });

  // ---- collect races belonging to meeting
  const allRaces = listRacesSafe();

  // prefer meeting.raceIds, fallback to meetingId field
  const ids = Array.isArray(meeting.raceIds) ? meeting.raceIds : [];
  const raceById = new Map(allRaces.filter(r=>r && r.id).map(r=>[r.id, r]));

  let meetingRaces = [];
  if (ids.length){
    meetingRaces = ids.map(id => raceById.get(id)).filter(Boolean);
  } else {
    meetingRaces = allRaces.filter(r => r && (r.meetingId === meetingId || r.eventGroupId === meetingId));
  }

  // ---- filters
  const qEl = $("q");
  const discEl = $("fDisc");
  const ebikeEl = $("fEbike");
  const minGEl = $("minGlobal");
  const minGVal = $("minGlobalVal");
  const sortEl = $("sortBy");

  function getRaceGlobal(r){
    // accept several fields
    const g = num(r.globalScore);
    if (g != null) return g;
    const mrs = num(r.mrs);
    if (mrs != null) return mrs;
    return null;
  }
  function getRacePhys(r){
    const p = num(r.physScore);
    return p != null ? p : null;
  }
  function getRaceTech(r){
    const t = (r.techV2 && typeof r.techV2.techScoreV2 === "number") ? num(r.techV2.techScoreV2) : null;
    return t != null ? t : num(r.techScore);
  }

  function applyFilters(){
    const q = (qEl.value || "").trim().toLowerCase();
    const fDisc = (discEl.value || "").trim();
    const fEbike = (ebikeEl.value || "").trim(); // "", "0", "1"
    const minG = Number(minGEl.value || 0);

    let out = meetingRaces.slice();

    if (q){
      out = out.filter(r=>{
        const s = `${r.name||""} ${r.comment||""} ${r.disc||""}`.toLowerCase();
        return s.includes(q);
      });
    }

    if (fDisc){
      out = out.filter(r => String(r.disc || "").toLowerCase() === fDisc.toLowerCase());
    }

    if (fEbike !== ""){
      const want = (fEbike === "1");
      out = out.filter(r => Boolean(r.ebike) === want);
    }

    out = out.filter(r=>{
      const g = getRaceGlobal(r);
      if (g == null) return true; // si pas de global, on ne filtre pas (ou mets false si tu veux strict)
      return g >= minG;
    });

    // sort
    const sortBy = sortEl.value || "date_desc";
    out.sort((a,b)=>{
      const da = (a.date || "");
      const db = (b.date || "");
      const ga = getRaceGlobal(a) ?? -1;
      const gb = getRaceGlobal(b) ?? -1;
      const distA = num(a.distanceKm) ?? -1;
      const distB = num(b.distanceKm) ?? -1;
      const na = (a.name || "").toLowerCase();
      const nb = (b.name || "").toLowerCase();

      if (sortBy === "date_desc") return db.localeCompare(da);
      if (sortBy === "date_asc") return da.localeCompare(db);
      if (sortBy === "global_desc") return (gb - ga);
      if (sortBy === "global_asc") return (ga - gb);
      if (sortBy === "distance_desc") return (distB - distA);
      if (sortBy === "name_asc") return na.localeCompare(nb);
      return 0;
    });

    renderList(out);
    renderKPIs(out);
  }

  function renderKPIs(filtered){
    const count = filtered.length;

    $("kpiCount").textContent = String(count);
    $("countFiltered").textContent = String(count);
    $("pillCountTxt").textContent = String(count);

    // date range inside event
    const dates = filtered.map(r=>r.date).filter(Boolean).sort();
    $("kpiRange").textContent = dates.length ? `üìÖ ${dates[0]} ‚Üí ${dates[dates.length-1]}` : "‚Äî";

    // averages
    const globals = filtered.map(getRaceGlobal).filter(v=>v!=null);
    const phys = filtered.map(getRacePhys).filter(v=>v!=null);
    const tech = filtered.map(getRaceTech).filter(v=>v!=null);
    const parts = filtered.map(r=>num(r.participants)).filter(v=>v!=null);

    const avg = (arr)=> arr.length ? (arr.reduce((s,x)=>s+x,0)/arr.length) : null;
    const sum = (arr)=> arr.length ? arr.reduce((s,x)=>s+x,0) : null;

    const gAvg = avg(globals);
    const pAvg = avg(phys);
    const tAvg = avg(tech);
    const pSum = sum(parts);

    $("kpiGlobal").textContent = gAvg == null ? "‚Äî" : String(Math.round(gAvg));
    $("kpiGlobalSub").textContent = globals.length ? `${globals.length} √©preuve(s) avec score global` : "‚Äî";

    $("kpiPhys").textContent = pAvg == null ? "‚Äî" : String(Math.round(pAvg));
    $("kpiTech").textContent = tAvg == null ? "‚Äî" : String(Math.round(tAvg));
    $("kpiParticipants").textContent = pSum == null ? "‚Äî" : String(Math.round(pSum));

    // hardest
    let hardest = null;
    for (const r of filtered){
      const g = getRaceGlobal(r);
      if (g == null) continue;
      if (!hardest || g > hardest.g) hardest = { r, g };
    }
    const link = $("kpiHardestLink");
    const sub = $("kpiHardestScore");
    if (!hardest){
      link.textContent = "‚Äî";
      link.href = "#";
      sub.textContent = "‚Äî";
    } else {
      link.textContent = hardest.r.name || "√âpreuve";
      link.href = `event.html?id=${encodeURIComponent(hardest.r.id)}`;
      sub.textContent = `Global: ${Math.round(hardest.g)}/100 ‚Ä¢ ${hardest.r.date || ""}`;
    }
  }

  function renderList(list){
    const root = $("races");
    const empty = $("emptyBox");
    root.innerHTML = "";

    if (!list.length){
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    for (const r of list){
      const g = getRaceGlobal(r);
      const p = getRacePhys(r);
      const t = getRaceTech(r);

      const dist = (num(r.distanceKm) != null) ? `${fmt1(num(r.distanceKm))} km` : "‚Äî km";
      const dplus = (num(r.dplusM) != null) ? `D+ ${Math.round(num(r.dplusM))} m` : "D+ ‚Äî";
      const date = r.date || "‚Äî";
      const disc = r.disc || "‚Äî";
      const eb = r.ebike ? "E-bike" : "Musculaire";

      const a = document.createElement("a");
      a.className = "item";
      a.href = `event.html?id=${encodeURIComponent(r.id)}`;

      a.innerHTML = `
        <div class="topline">
          <div class="title">${esc(r.name || "√âpreuve")}</div>
          <div class="badge">${esc(date)}</div>
        </div>
        <div class="metaLine">${esc(disc)} ‚Ä¢ ${esc(eb)} ‚Ä¢ ${esc(dist)} ‚Ä¢ ${esc(dplus)}</div>
        <div class="miniRow">
          <span class="miniPill">Global: <b>${g == null ? "‚Äî" : Math.round(g)}</b></span>
          <span class="miniPill">Phys: <b>${p == null ? "‚Äî" : Math.round(p)}</b></span>
          <span class="miniPill">Tech: <b>${t == null ? "‚Äî" : Math.round(t)}</b></span>
        </div>
      `;
      root.appendChild(a);
    }
  }

  // ---- wire
  const syncMin = ()=> { if (minGVal) minGVal.textContent = String(minGEl.value || 0); };
  minGEl.addEventListener("input", ()=>{ syncMin(); applyFilters(); });
  [qEl, discEl, ebikeEl, sortEl].forEach(el => el.addEventListener("input", applyFilters));
  $("btnResetFilters").addEventListener("click", ()=>{
    qEl.value = "";
    discEl.value = "";
    ebikeEl.value = "";
    minGEl.value = 0;
    sortEl.value = "date_desc";
    syncMin();
    applyFilters();
  });

  syncMin();
  applyFilters();

})();
</script>

</body>
</html>
