<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Événement — MTB Points</title>
  <link rel="stylesheet" href="./css/style.css" />
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points — Événement</h1>
    <span class="pill"><span class="dot"></span><span id="countPill">0</span> épreuve(s)</span>
  </div>

  <nav class="nav">
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html" class="active">Événements</a>
    <a href="challengemtbpoints.html">Challenge</a>
    <a href="reglement.html">Règlement</a>
    <a href="methodologie.html">Méthodologie</a>
    <a href="about.html">À propos</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="headerRight">
    <button class="btn ghost" id="btnFR" type="button">FR</button>
    <button class="btn ghost" id="btnEN" type="button">EN</button>
  </div>
</header>

<main class="wrap">
  <div class="card">

    <!-- HERO -->
    <section class="hero">
      <div class="heroTop">
        <div style="min-width:260px;flex:1">
          <h2 id="mName">—</h2>
          <div class="heroMeta" id="mMeta">—</div>
          <div class="heroDesc" id="mComment"></div>
        </div>

        <div class="heroActions">
          <!-- ✅ bouton demandé -->
          <a id="btnCreateRace" class="btn primary" href="#">+ Créer une épreuve</a>

          <span class="pill"><span class="dot ok"></span> Résumé auto</span>
          <span class="pill"><span class="dot"></span> Filtres</span>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <h3 class="sectionTitle">Résumé global</h3>
    <div class="kpiGrid">
      <div class="kpi">
        <div class="kpiLabel">Épreuves (filtrées)</div>
        <div class="kpiValue" id="kpiCount">—</div>
        <div class="kpiSub" id="kpiRange">—</div>
      </div>

      <div class="kpi">
        <div class="kpiLabel">Difficulté moyenne</div>
        <div class="kpiValue"><span id="kpiGlobal">—</span><span class="muted"> /100</span></div>
        <div class="kpiSub">≈ <strong id="kpiGlobal5">—</strong> / 5</div>
        <div class="bar" aria-label="barre difficulté">
          <div id="kpiGlobalBar"></div>
        </div>
      </div>

      <div class="kpi">
        <div class="kpiLabel">Épreuve la plus difficile</div>
        <div class="kpiValue" style="font-size:16px;line-height:1.2;">
          <a id="kpiHardestLink" href="#" style="text-decoration:none;color:var(--blue);font-weight:1000;">—</a>
        </div>
        <div class="kpiSub" id="kpiHardestScore">—</div>
      </div>

      <div class="kpi">
        <div class="kpiLabel">Moyenne Physique</div>
        <div class="kpiValue"><span id="kpiPhys">—</span><span class="muted"> /100</span></div>
        <div class="kpiSub">ScorePhys moyen</div>
      </div>

      <div class="kpi">
        <div class="kpiLabel">Moyenne Technique</div>
        <div class="kpiValue"><span id="kpiTech">—</span><span class="muted"> /100</span></div>
        <div class="kpiSub">ScoreTech moyen</div>
      </div>

      <div class="kpi">
        <div class="kpiLabel">Participants (total)</div>
        <div class="kpiValue" id="kpiParticipants">—</div>
        <div class="kpiSub">Somme des participants renseignés</div>
      </div>
    </div>

    <!-- FILTERS -->
    <h3 class="sectionTitle" style="margin-top:18px;">Filtres & tri</h3>
    <div class="filters">
      <div class="spanAll" style="grid-column:1/3">
        <label for="q">Recherche</label>
        <input id="q" type="text" placeholder="Nom, lieu..." />
      </div>

      <div>
        <label for="fDisc">Discipline</label>
        <select id="fDisc">
          <option value="">Toutes</option>
          <option value="XC">XC</option>
          <option value="Enduro">Enduro</option>
          <option value="DH">DH</option>
          <option value="Gravel">Gravel</option>
          <option value="Marathon">Marathon</option>
          <option value="Ultra">Ultra</option>
        </select>
      </div>

      <div>
        <label for="fEbike">Type vélo</label>
        <select id="fEbike">
          <option value="">Tous</option>
          <option value="0">Musculaire</option>
          <option value="1">Assistance électrique</option>
        </select>
      </div>

      <div>
        <label for="minGlobal">Difficulté min (Global ≥ <span id="minGlobalVal">0</span>)</label>
        <input id="minGlobal" type="range" min="0" max="100" value="0" />
      </div>

      <div>
        <label for="sortBy">Tri</label>
        <select id="sortBy">
          <option value="global_desc">Difficulté (Global) ↓</option>
          <option value="global_asc">Difficulté (Global) ↑</option>
          <option value="date_desc">Plus récentes</option>
          <option value="date_asc">Plus anciennes</option>
          <option value="distance_desc">Distance ↓</option>
          <option value="name_asc">Nom A→Z</option>
        </select>
      </div>

      <div>
        <button id="clearBtn" class="btn primary" type="button">Réinitialiser</button>
      </div>

      <div class="hintRow" style="grid-column:1/-1;">
        <div>Résultats : <strong id="countFiltered">0</strong></div>
        <div class="muted">Astuce : clique sur une épreuve pour ouvrir la fiche.</div>
      </div>
    </div>

    <!-- CHART -->
    <h3 class="sectionTitle" style="margin-top:18px;">Graph rapide (Global)</h3>
    <div id="miniChart" class="miniChart muted">
      <div class="spark" id="spark"></div>
      <div class="sparkMeta" id="sparkMeta">—</div>
    </div>

    <!-- LIST -->
    <h3 class="sectionTitle" style="margin-top:18px;">Épreuves disponibles</h3>
    <div id="races" class="list"></div>
    <div id="emptyBox" class="empty" style="display:none;">Aucune épreuve ne correspond aux filtres.</div>

  </div>
</main>

<script src="js/data.js"></script>
<script src="js/storage.js"></script>
<script src="js/meeting.js"></script>

<script>
/*
  UI only:
  - met à jour l'affichage du range
  - construit un mini chart à partir des items visibles
  - met à jour la pastille countPill
  - ajoute le lien du bouton "+ Créer une épreuve" -> course.html?meetingId=...
*/
(function(){
  const $ = (id)=>document.getElementById(id);

  // ✅ bouton "+ Créer une épreuve"
  (function initCreateRaceBtn(){
    const btn = $("btnCreateRace");
    if (!btn) return;
    const meetingId = new URLSearchParams(location.search).get("id");
    if (!meetingId) { btn.style.display = "none"; return; }
    btn.href = `course.html?meetingId=${encodeURIComponent(meetingId)}`;
  })();

  // range label live
  const rg = $("minGlobal");
  const rgVal = $("minGlobalVal");
  if (rg && rgVal) {
    const sync = ()=> rgVal.textContent = String(rg.value || 0);
    rg.addEventListener("input", sync);
    sync();
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  function tryExtractGlobalScores(){
    const list = $("races");
    if (!list) return [];
    const items = Array.from(list.querySelectorAll(".item, a, .race, .row")).slice(0, 32);
    const out = [];
    for (const el of items) {
      const t = (el.textContent || "").replace(/\s+/g," ").trim();
      let m = t.match(/(\b\d{1,3})\s*\/\s*100\b/);
      if (!m) m = t.match(/\bglobal\b[^0-9]*([0-9]{1,3})\b/i);
      if (m) out.push(clamp(Number(m[1]), 0, 100));
    }
    return out;
  }

  function renderSpark(scores){
    const spark = $("spark");
    const meta = $("sparkMeta");
    if (!spark || !meta) return;

    spark.innerHTML = "";
    if (!scores.length) {
      meta.textContent = "Graph indisponible (pas assez d’infos).";
      return;
    }

    const max = Math.max(...scores, 1);
    const min = Math.min(...scores, 0);
    const avg = Math.round(scores.reduce((s,x)=>s+x,0)/scores.length);

    for (const v of scores) {
      const b = document.createElement("div");
      b.className = "b";
      b.style.height = (12 + (v / max) * 78) + "px";
      b.title = v + "/100";
      spark.appendChild(b);
    }
    meta.textContent = `Échantillon: ${scores.length} • min ${min}/100 • moy ${avg}/100 • max ${max}/100`;
  }

  const races = $("races");
  if (races && window.MutationObserver) {
    const obs = new MutationObserver(() => {
      renderSpark(tryExtractGlobalScores());
      const countEl = $("countFiltered");
      const pillEl = $("countPill");
      if (countEl && pillEl) pillEl.textContent = (countEl.textContent || "0").trim();
    });
    obs.observe(races, { childList:true, subtree:true });
  }

  renderSpark(tryExtractGlobalScores());
})();
</script>

</body>
</html>
