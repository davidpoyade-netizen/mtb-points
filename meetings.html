<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√âv√©nements ‚Äî MTB Points</title>
  <link rel="stylesheet" href="./css/style.css" />
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points ‚Äî √âv√©nements</h1>
    <span class="pill"><span class="dot"></span> <span id="countMeetings">0</span> √©v√©nement(s)</span>
  </div>

  <nav class="nav">
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html" class="active">√âv√©nements</a>
    <a href="events.html">√âpreuves</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="headerRight" style="display:flex;gap:8px;flex-wrap:wrap;">
    <a class="btn primary" href="meeting-create.html">+ Cr√©er un √©v√©nement</a>
  </div>
</header>

<main class="wrap">
  <div class="card">

    <section class="hero">
      <div class="heroTop">
        <div style="min-width:280px;flex:1">
          <h2>G√©rer tes √©v√©nements</h2>
          <div class="heroMeta">
            Cr√©e un √©v√©nement, puis ajoute des √©preuves rattach√©es (obligatoire).
            Les √©v√©nements multi-jours sont support√©s.
          </div>
          <div class="heroDesc" id="hintBox" style="display:none;"></div>
        </div>
        <div class="heroActions">
          <span class="pill"><span class="dot ok"></span> Multi-jours</span>
          <span class="pill"><span class="dot"></span> Races rattach√©es</span>
        </div>
      </div>
    </section>

    <h3 class="sectionTitle" style="margin-top:18px;">Filtres & tri</h3>

    <div class="filters" style="grid-template-columns: 1.6fr 1fr 1fr 1fr 180px; align-items:end;">
      <div class="spanAll" style="grid-column:1/2">
        <label for="q">Recherche</label>
        <input id="q" type="text" placeholder="Nom, lieu, commentaire‚Ä¶" />
      </div>

      <div>
        <label for="fromDate">√Ä partir du</label>
        <input id="fromDate" type="date" />
      </div>

      <div>
        <label for="toDate">Jusqu‚Äôau</label>
        <input id="toDate" type="date" />
      </div>

      <div>
        <label for="sortBy">Tri</label>
        <select id="sortBy">
          <option value="date_desc">Plus r√©cents</option>
          <option value="date_asc">Plus anciens</option>
          <option value="name_asc">Nom A‚ÜíZ</option>
          <option value="races_desc">√âpreuves ‚Üì</option>
        </select>
      </div>

      <div>
        <button class="btn primary" id="btnReset" type="button">R√©initialiser</button>
      </div>

      <div class="hintRow" style="grid-column:1/-1;">
        <div>R√©sultats : <strong id="countFiltered">0</strong></div>
        <div class="muted">Astuce : cr√©e une √©preuve depuis un √©v√©nement (rattachement auto).</div>
      </div>
    </div>

    <h3 class="sectionTitle" style="margin-top:18px;">Liste des √©v√©nements</h3>

    <div id="meetings" class="list" style="margin-top:12px;"></div>
    <div id="emptyBox" class="empty" style="display:none;">
      Aucun √©v√©nement trouv√©. Clique sur <b>‚Äú+ Cr√©er un √©v√©nement‚Äù</b>.
    </div>

  </div>
</main>

<script src="js/data.js"></script>
<script src="js/storage.js"></script>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function num(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }

  function setHint(html){
    const el = $("hintBox");
    if (!el) return;
    el.style.display = html ? "block" : "none";
    el.innerHTML = html || "";
  }

  // ---- Storage adapters
  function listMeetingsSafe(){
    if (typeof window.listMeetings === "function") return window.listMeetings();
    if (typeof window.getMeetings === "function") return window.getMeetings();
    try {
      const raw = localStorage.getItem("mtb.meetings.v1");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch(_){ return []; }
  }

  function listRacesSafe(){
    if (typeof window.listRaces === "function") return window.listRaces();
    if (typeof window.getRaces === "function") return window.getRaces();
    try {
      const raw = localStorage.getItem("mtb.races.v1");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch(_){ return []; }
  }

  const allMeetings = listMeetingsSafe();
  const allRaces = listRacesSafe();

  // map: meetingId -> count races
  const countByMeeting = new Map();
  for (const r of allRaces){
    if (!r) continue;
    const mid = r.meetingId || r.eventGroupId || null;
    if (!mid) continue;
    countByMeeting.set(mid, (countByMeeting.get(mid) || 0) + 1);
  }

  // Use meeting.raceIds if available as the truth for counts (fallback to race meetingId)
  function meetingRaceCount(m){
    if (!m) return 0;
    const ids = Array.isArray(m.raceIds) ? m.raceIds : [];
    if (ids.length) return ids.length;
    return countByMeeting.get(m.id) || 0;
  }

  // ---- UI + filters
  const qEl = $("q");
  const fromEl = $("fromDate");
  const toEl = $("toDate");
  const sortEl = $("sortBy");

  function inRange(meeting, fromISO, toISO){
    const start = meeting.date || null;
    const end = meeting.endDate || meeting.date || null;

    // if no dates, keep
    if (!start) return true;

    // compare as YYYY-MM-DD lexicographic is OK
    const s = start;
    const e = end || start;

    // if filter range intersects [s,e]
    if (fromISO && e < fromISO) return false;
    if (toISO && s > toISO) return false;
    return true;
  }

  function apply(){
    const q = (qEl.value || "").trim().toLowerCase();
    const fromISO = (fromEl.value || "").trim();
    const toISO = (toEl.value || "").trim();

    let out = allMeetings.slice();

    if (q){
      out = out.filter(m=>{
        const txt = `${m.name||""} ${m.location||""} ${m.comment||""}`.toLowerCase();
        return txt.includes(q);
      });
    }

    out = out.filter(m => inRange(m, fromISO || null, toISO || null));

    const sortBy = sortEl.value || "date_desc";
    out.sort((a,b)=>{
      const ad = a.date || "";
      const bd = b.date || "";
      const an = (a.name || "").toLowerCase();
      const bn = (b.name || "").toLowerCase();
      const ar = meetingRaceCount(a);
      const br = meetingRaceCount(b);

      if (sortBy === "date_desc") return bd.localeCompare(ad);
      if (sortBy === "date_asc") return ad.localeCompare(bd);
      if (sortBy === "name_asc") return an.localeCompare(bn);
      if (sortBy === "races_desc") return br - ar;
      return 0;
    });

    render(out);
  }

  function render(list){
    $("countMeetings").textContent = String(allMeetings.length);
    $("countFiltered").textContent = String(list.length);

    const root = $("meetings");
    const empty = $("emptyBox");
    root.innerHTML = "";

    if (!allMeetings.length){
      setHint("‚ö†Ô∏è Aucun √©v√©nement en m√©moire. Cr√©e ton premier √©v√©nement pour commencer.");
    } else {
      setHint("");
    }

    if (!list.length){
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    for (const m of list){
      const start = m.date || "‚Äî";
      const end = m.endDate || null;
      const range = end ? `${start} ‚Üí ${end}` : start;

      const racesCount = meetingRaceCount(m);

      const viewUrl = `meeting.html?id=${encodeURIComponent(m.id)}`;
      const createRaceUrl = `course-create.html?meetingId=${encodeURIComponent(m.id)}`;

      const el = document.createElement("div");
      el.className = "item";
      el.style.display = "block";

      el.innerHTML = `
        <div class="topline">
          <div class="title">${esc(m.name || "√âv√©nement")}</div>
          <div class="badge">${esc(range)}</div>
        </div>

        <div class="metaLine">
          ${m.location ? `üìç ${esc(m.location)} ‚Ä¢ ` : ""}üèÅ ${esc(String(racesCount))} √©preuve(s)
        </div>

        <div class="miniRow" style="margin-top:10px;">
          <a class="btn" href="${viewUrl}" style="width:auto;">Voir</a>
          <a class="btn primary" href="${createRaceUrl}" style="width:auto;">+ Cr√©er une √©preuve</a>
          <a class="btn ghost" href="events.html" style="width:auto;">Toutes les √©preuves</a>
        </div>

        ${m.comment ? `<div class="muted" style="margin-top:10px; font-size:12px; line-height:1.5;">${esc(m.comment)}</div>` : ""}
      `;

      root.appendChild(el);
    }
  }

  // wire
  [qEl, fromEl, toEl, sortEl].forEach(el => el.addEventListener("input", apply));
  $("btnReset").addEventListener("click", ()=>{
    qEl.value = "";
    fromEl.value = "";
    toEl.value = "";
    sortEl.value = "date_desc";
    apply();
  });

  apply();
})();
</script>

</body>
</html>
