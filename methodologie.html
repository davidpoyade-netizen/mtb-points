<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MTB Points — Méthodologie (Calcul)</title>

  <style>
    :root{
      --bg:#f4f4f4;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#667085;
      --muted2:#64748b;
      --border:#e5e7eb;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --ok:#16a34a;
      --warn:#ea580c;
      --err:#dc2626;
      --shadow:0 10px 30px rgba(2,6,23,.10);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
    }
    a{color:inherit}

    /* Header */
    header.header{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.90);
      backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    header.header h1{margin:0;font-size:18px;letter-spacing:.2px}
    nav{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    nav a{
      text-decoration:none;
      padding:8px 10px;border-radius:10px;
      color:var(--blue);
      font-weight:800;font-size:13px;
    }
    nav a:hover{background:#eff6ff}
    nav a.active{background:#eff6ff;color:var(--blue2)}
    .lang{display:flex;gap:8px;align-items:center}
    .lang .btn{
      padding:8px 10px;border-radius:10px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:900;font-size:12px;
    }

    /* Layout */
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      padding:18px;
      box-shadow:var(--shadow);
      margin:14px 0;
    }

    /* Hero */
    .hero{
      border-radius:22px;
      padding:18px;
      border:1px solid var(--border);
      background:
        radial-gradient(900px 260px at 12% 0%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(700px 240px at 95% 10%, rgba(16,185,129,.12), transparent 60%),
        #fff;
    }
    .heroTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .hero h2{margin:0;font-size:24px;letter-spacing:-.25px}
    .hero .muted{margin-top:8px;line-height:1.55;color:#334155}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;font-size:12px;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#94a3b8;display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.err{background:var(--err)}

    /* Typography */
    h2.section{margin:0 0 10px 0;font-size:18px;letter-spacing:-.15px}
    h3{margin:16px 0 8px 0;font-size:15px}
    p,li{font-size:14px;line-height:1.65}
    ul{padding-left:18px;margin:8px 0}
    .muted{color:var(--muted);font-size:13px}

    /* Code blocks */
    code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    pre{
      margin:10px 0 0 0;
      background:#0b1220;
      color:#e5e7eb;
      padding:14px;
      border-radius:16px;
      overflow:auto;
      border:1px solid #111827;
      box-shadow:0 8px 18px rgba(2,6,23,.20);
    }
    code.inline{
      background:#f1f5f9;border:1px solid var(--border);
      border-radius:10px;padding:2px 8px;font-size:13px;color:#0f172a;
      white-space:nowrap;
    }

    /* Boxes */
    .box{
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      margin:12px 0;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    .callout{background:#f8fafc;border-left:6px solid var(--blue)}
    .warnBox{background:#fff7ed;border-left:6px solid var(--warn)}
    .errBox{background:#fff1f2;border-left:6px solid var(--err)}
    .boxTitle{font-weight:900}
    .box .muted{margin-top:6px}

    /* TOC */
    .tocGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:900px){.tocGrid{grid-template-columns:1fr}}
    .tocLink{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:16px;
      text-decoration:none;
      background:#fff;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .tocLink:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 22px rgba(2,6,23,.10);
      border-color:#dbeafe;
    }
    .tocTitle{font-weight:900}
    .tocHint{color:var(--muted);font-size:12px}

    /* 2 columns */
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:14px;
      align-items:start;
    }
    @media(max-width:980px){.twoCol{grid-template-columns:1fr}}
    .side{position:sticky;top:86px}
    @media(max-width:980px){.side{position:relative;top:auto}}

    .sideCard{
      background:#fff;border:1px solid var(--border);
      border-radius:22px;padding:14px;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    .sideCard h3{margin:0 0 10px 0}
    .sideCard a{
      display:block;
      text-decoration:none;
      color:var(--blue);
      font-weight:800;
      padding:8px 10px;
      border-radius:12px;
    }
    .sideCard a:hover{background:#eff6ff}
    .smallList{margin:6px 0 0 0;padding-left:18px}
    .badgePill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);background:#fff;font-weight:900;font-size:12px;
    }

    footer{
      padding:26px 16px;text-align:center;color:var(--muted);font-size:13px
    }
  </style>
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points — Méthodologie</h1>
    <span class="pill"><span class="dot ok"></span> OFFICIEL</span>
    <span class="pill"><span class="dot warn"></span> Hybrid</span>
    <span class="pill"><span class="dot"></span> OSM + GPX</span>
  </div>

  <nav>
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html">Événements</a>
    <a href="challengemtbpoints.html">Challenge</a>
    <a href="reglement.html">Règlement</a>
    <a href="methodologie.html" class="active">Méthodologie</a>
    <a href="about.html">À propos</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="lang">
    <button class="btn" id="btnFR" type="button">FR</button>
    <button class="btn" id="btnEN" type="button">EN</button>
  </div>
</header>

<main class="wrap">
  <section class="card hero">
    <div class="heroTop">
      <div style="min-width:260px;flex:1">
        <h2>Calculs & formules — version publique</h2>
        <div class="muted">
          Cette page décrit les formules de calcul (MRS, ScorePhys, ScoreTech V2 Hybrid).
          Pour l’éligibilité, import, contrôle et litiges : voir
          <a href="reglement.html" style="color:var(--blue);font-weight:900;text-decoration:none">Règlement</a>.
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start">
        <span class="badgePill"><span class="dot ok"></span> ScoreTech V2</span>
        <span class="badgePill"><span class="dot"></span> P75 robuste</span>
      </div>
    </div>

    <div class="box callout" style="margin-top:14px;">
      <div class="boxTitle">Mode officiel (unique)</div>
      <div class="muted" style="margin-top:6px;">
        <b>Hybrid obligatoire</b> : <b>OSM = socle audit-able</b> + <b>bonus GPX capé</b> (pente/virages/sinuosité, filtrage anti-bruit).
      </div>
    </div>
  </section>

  <div class="twoCol">

    <!-- Main -->
    <div>

      <!-- Sommaire -->
      <section class="card">
        <h2 class="section">Sommaire</h2>
        <div class="tocGrid">
          <a class="tocLink" href="#mrs"><span class="tocTitle">1. Score Épreuve (MRS)</span><span class="tocHint">55/45</span></a>
          <a class="tocLink" href="#phys"><span class="tocTitle">2. Score physique</span><span class="tocHint">GPX</span></a>
          <a class="tocLink" href="#tech"><span class="tocTitle">3. ScoreTech V2 — Hybrid</span><span class="tocHint">OSM + bonus</span></a>
          <a class="tocLink" href="#quality"><span class="tocTitle">4. Qualité des données</span><span class="tocHint">coverage</span></a>
          <a class="tocLink" href="#params"><span class="tocTitle">5. Paramètres</span><span class="tocHint">calibration</span></a>
        </div>
      </section>

      <!-- MRS -->
      <section class="card" id="mrs">
        <h2 class="section">1. Score Épreuve (MRS)</h2>
        <p>Le score global de difficulté d’une épreuve (MRS) combine le score physique et le score technique.</p>
        <pre><code>MRS = round(0.55 × ScorePhys + 0.45 × ScoreTech)</code></pre>
        <p class="muted">MRS est borné sur 0–100.</p>
      </section>

      <!-- Phys -->
      <section class="card" id="phys">
        <h2 class="section">2. Score physique (ScorePhys)</h2>

        <h3>2.1 Données d’entrée (GPX)</h3>
        <ul>
          <li><b>D</b> : distance totale (km)</li>
          <li><b>H⁺</b> : dénivelé positif total (m)</li>
          <li><b>IPB</b> : indice de pénibilité (distribution des pentes)</li>
        </ul>

        <h3>2.2 Calcul</h3>
        <pre><code>EffortBase = sqrt(D) + (H⁺ / 1000)

EffortNorm = clamp(EffortBase / 10, 0, 1)
IPB_norm   = clamp(IPB / 120, 0, 1)

ScorePhys  = round(100 × clamp(0.70×EffortNorm + 0.30×IPB_norm, 0, 1))</code></pre>
        <div class="box callout">
          <div class="boxTitle">Pourquoi ces termes ?</div>
          <div class="muted">
            <b>sqrt(D)</b> évite que la distance domine trop fort à haut kilométrage, et <b>H⁺</b> ajoute l’effort de montée.
            IPB capte la “sévérité” des pentes (longues/raides).
          </div>
        </div>
      </section>

      <!-- Tech -->
      <section class="card" id="tech">
        <h2 class="section">3. Score technique OFFICIEL (ScoreTech V2 — Hybrid obligatoire)</h2>

        <div class="box callout">
          <div class="boxTitle">Règle</div>
          <div class="muted" style="margin-top:6px;">
            ScoreTech V2 = <b>socle OSM</b> (terrain/surface/difficulté déclarée) +
            <b>bonus GPX capé</b> (pente + virages + sinuosité), avec filtrage anti-bruit.
          </div>
        </div>

        <h3>3.1 Socle OSM : TerrainScore (0..1)</h3>
        <p>
          On échantillonne la trace tous les <span class="pill"><span class="dot"></span> ~120 m</span>.
          Pour chaque point, on récupère les tags OSM :
          <span class="pill"><span class="dot"></span> mtb:scale</span>
          <span class="pill"><span class="dot"></span> smoothness</span>
          <span class="pill"><span class="dot"></span> highway</span>
          <span class="pill"><span class="dot"></span> surface</span>
          <span class="pill"><span class="dot"></span> tracktype</span>
          <span class="pill"><span class="dot"></span> sac_scale</span>.
        </p>

        <p><b>Conversion tags → TerrainScore (0..1)</b></p>
        <pre><code>Priorité
1) mtb:scale : TerrainScore = clamp(scale/5, 0, 1)
2) smoothness (excellent/good/intermediate/bad/very_bad..)
3) highway + tracktype + surface (règles)
   route/asphalt -> 0.0
   track grade1  -> 0.2
   track grade2  -> 0.35
   track grade3  -> 0.5
   path          -> 0.6
   rock/stone..  -> +0.2 (cap 1.0)</code></pre>

        <p><b>Agrégation</b> : percentile 75 pondéré par la distance représentée par chaque échantillon.</p>
        <pre><code>TerrainScore_OSM = weightedPercentile(TerrainScore_samples,
                                      weights=sample_distance,
                                      p=0.75)</code></pre>

        <h3>3.2 Bonus GPX (capé) : GPXTech (0..1)</h3>
        <p>
          On découpe la trace en segments d’environ <span class="pill"><span class="dot"></span> 200 m</span>.
          Sur chaque segment, on calcule :
        </p>
        <ul>
          <li><b>SinuNorm</b> : sinuosité normalisée</li>
          <li><b>TurnNorm</b> : pilotage (somme des changements de cap / km)</li>
          <li><b>SlopeTech</b> : pente technique (proportion de pentes fortes + percentile 90)</li>
        </ul>

        <div class="box warnBox">
          <div class="boxTitle">Anti-bruit (obligatoire)</div>
          <div class="muted">On ignore les pas GPS trop courts/longs et les spikes altimétriques.</div>
          <pre><code>Filtrage GPX
- ignorer si d < 3 m   (jitter)
- ignorer si d > 80 m  (trous)
- ignorer si |Δele| > 25 m sur un pas
- ignorer si |grade| > 45%</code></pre>
        </div>

        <p><b>SlopeTech (0..1)</b></p>
        <pre><code>p10  = proportion(|grade| ≥ 0.10)
p16  = proportion(|grade| ≥ 0.16)
gP90 = percentile90(|grade|)

SlopeTech = clamp(0.55*p10 + 0.45*p16
                  + 0.55*clamp((gP90-0.08)/0.22,0,1), 0, 1)</code></pre>

        <p><b>TurnNorm (0..1)</b></p>
        <pre><code>turnPerKm = sum(|Δbearing|) / km
TurnNorm  = clamp((turnPerKm - 120) / 500, 0, 1)</code></pre>

        <p><b>SinuNorm (0..1)</b></p>
        <pre><code>Sinuosity = dist_reelle / dist_oiseau
SinuNorm  = clamp((Sinuosity - 1.0) / 0.30, 0, 1)</code></pre>

        <p><b>GPXTech par segment (0..1)</b></p>
        <pre><code>GPXTech_seg = clamp(0.45*SlopeTech + 0.35*TurnNorm + 0.20*SinuNorm, 0, 1)</code></pre>

        <p><b>Agrégation</b> : percentile 75 pondéré par la longueur de segment.</p>
        <pre><code>GPXTech = weightedPercentile(GPXTech_seg,
                             weights=seg_length,
                             p=0.75)</code></pre>

        <h3>3.3 Fusion officielle : OSM socle + bonus GPX capé</h3>
        <p>Le bonus GPX est <b>capé</b> pour éviter qu’un GPX bruité sur-gonfle le score.</p>
        <pre><code>Base      = 0.80 * TerrainScore_OSM
Bonus     = min(0.20 * GPXTech, BONUS_CAP)

Tech01    = clamp(Base + Bonus, 0, 1)
ScoreTech = round(100 * Tech01)

BONUS_CAP = 0.15   (soit +15 points max sur 100)</code></pre>
      </section>

      <!-- Quality -->
      <section class="card" id="quality">
        <h2 class="section">4. Qualité des données & cas non calculables</h2>

        <div class="box errBox">
          <div class="boxTitle">OSM est obligatoire</div>
          <div class="muted">
            Si la couverture OSM est insuffisante, ScoreTech n’est pas calculable automatiquement.
          </div>
        </div>

        <pre><code>coverage = matched_samples / total_samples

Si coverage < 0.30
=> ScoreTech = non calculable (à valider / compléter)</code></pre>

        <p class="muted">
          Ce comportement évite d’attribuer un ScoreTech arbitraire lorsque les tags OSM sont absents ou incohérents.
        </p>
      </section>

      <!-- Params -->
      <section class="card" id="params">
        <h2 class="section">5. Paramètres & calibration</h2>
        <ul>
          <li><b>OSM sampling</b> : 120 m (plus fin si besoin, mais attention au coût Overpass).</li>
          <li><b>Segment GPX</b> : 200 m (tech-sensitive).</li>
          <li><b>Percentile</b> : P75 (robuste : valorise les sections déterminantes sans être dominé par les portions faciles).</li>
          <li><b>Cap bonus</b> : 0.15 (= +15/100 max). Ajustable après calibration terrain.</li>
          <li><b>Pondération</b> : OSM 80% / GPX 20% (équilibre “audit” + “réalité VTT”).</li>
        </ul>

        <pre><code>Rappel
MRS = round(0.55 × ScorePhys + 0.45 × ScoreTech)</code></pre>

        <div class="box callout">
          <div class="boxTitle">Conseil pratique</div>
          <div class="muted">
            Quand tu modifies un paramètre (sampling, segments, seuils), fais-le <b>une seule fois</b> et recalibre sur un set
            de courses connues (XC vs Enduro vs DH) pour vérifier la cohérence des distributions.
          </div>
        </div>
      </section>

    </div>

    <!-- Side -->
    <aside class="side">
      <div class="sideCard">
        <h3>Accès rapide</h3>
        <a href="#mrs">MRS</a>
        <a href="#phys">ScorePhys</a>
        <a href="#tech">ScoreTech V2 Hybrid</a>
        <a href="#quality">Qualité / Coverage</a>
        <a href="#params">Paramètres</a>
      </div>

      <div class="sideCard" style="margin-top:12px;">
        <h3>Raccourcis</h3>
        <ul class="smallList">
          <li><a href="reglement.html" style="color:var(--blue);font-weight:900;text-decoration:none">Règlement</a> : éligibilité, import, litiges</li>
          <li><a href="challengemtbpoints.html" style="color:var(--blue);font-weight:900;text-decoration:none">Challenge</a> : badges & Hall of Fame</li>
        </ul>
      </div>
    </aside>

  </div>
</main>

<footer>
  MTB Points — Méthodologie • Dernière mise à jour : <span id="lastUpdate">—</span>
</footer>

<script>
  document.getElementById("lastUpdate").textContent = new Date().toLocaleDateString("fr-FR");
</script>
</body>
</html>

