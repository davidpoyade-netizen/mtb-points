<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MTB Points — Méthodologie (Calcul)</title>
  <style>
    :root{
      --bg:#f4f4f4;--card:#ffffff;--text:#0f172a;--muted:#64748b;
      --border:#e5e7eb;--blue:#2563eb;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    header{background:#0b1220;color:#fff;padding:16px 18px;}
    header h1{margin:0;font-size:18px;}
    nav{margin-top:10px;font-size:14px;opacity:.95}
    nav a{color:#cbd5e1;text-decoration:none;margin-right:12px}
    nav a:hover{color:#fff;text-decoration:underline}
    .wrap{max-width:980px;margin:18px auto;padding:0 14px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin:14px 0;box-shadow:0 1px 2px rgba(0,0,0,.04);}
    h2{margin:0 0 10px 0;font-size:18px}
    h3{margin:18px 0 8px 0;font-size:15px}
    p,li{line-height:1.55;color:var(--text)}
    .muted{color:var(--muted)}
    code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    pre{background:#0b1220;color:#e5e7eb;padding:12px;border-radius:12px;overflow:auto;border:1px solid #111827}
    .toc a{color:var(--blue);text-decoration:none}
    .toc a:hover{text-decoration:underline}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted);margin-right:6px}
    .note{border-left:4px solid var(--blue);padding:10px 12px;background:#eff6ff;border-radius:10px}
    .warn{border-left:4px solid #ef4444;padding:10px 12px;background:#fff1f2;border-radius:10px}
  </style>
</head>
<body>
<header>
  <h1>MTB Points — Méthodologie (Calcul)</h1>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="classement.html">Classement</a>
    <a href="evenements.html">Événements</a>
    <a href="reglement.html">Règlement</a>
    <a href="methodologie.html"><strong>Méthodologie</strong></a>
    <a href="apropos.html">À propos</a>
    <a href="login.html">Connexion</a>
  </nav>
</header>

<div class="wrap">

  <div class="card">
    <div class="tag">OFFICIEL</div>
    <div class="tag">Hybrid</div>
    <div class="tag">OSM + GPX</div>
    <p class="muted">Cette page décrit les formules de calcul. Pour l’éligibilité, import, contrôle, litiges : voir <a href="reglement.html">Règlement</a>.</p>

    <h2>Sommaire</h2>
    <ul class="toc">
      <li><a href="#mrs">1. Score Épreuve (MRS)</a></li>
      <li><a href="#phys">2. Score physique (ScorePhys)</a></li>
      <li><a href="#tech">3. Score technique OFFICIEL (ScoreTech V2 — Hybrid obligatoire)</a></li>
      <li><a href="#quality">4. Qualité des données & cas non calculables</a></li>
      <li><a href="#params">5. Paramètres & calibration</a></li>
    </ul>
  </div>

  <div class="card" id="mrs">
    <h2>1. Score Épreuve (MRS)</h2>
    <p>Le score global de difficulté d’une épreuve (MRS) combine le score physique et le score technique.</p>
    <pre><code>MRS = round(0.55 × ScorePhys + 0.45 × ScoreTech)</code></pre>
    <p class="muted">MRS est borné sur 0–100.</p>
  </div>

  <div class="card" id="phys">
    <h2>2. Score physique (ScorePhys)</h2>

    <h3>2.1 Données d’entrée (GPX)</h3>
    <ul>
      <li><strong>D</strong> : distance totale (km)</li>
      <li><strong>H⁺</strong> : dénivelé positif total (m)</li>
      <li><strong>IPB</strong> : indice de pénibilité (distribution des pentes)</li>
    </ul>

    <h3>2.2 Calcul</h3>
    <pre><code>EffortBase = sqrt(D) + (H⁺ / 1000)

EffortNorm = clamp(EffortBase / 10, 0, 1)
IPB_norm   = clamp(IPB / 120, 0, 1)

ScorePhys = round(100 × clamp(0.70×EffortNorm + 0.30×IPB_norm, 0, 1))</code></pre>
    <p class="muted">Les constantes (10, 120) sont calibrables.</p>
  </div>

  <div class="card" id="tech">
    <h2>3. Score technique OFFICIEL (ScoreTech V2 — Hybrid obligatoire)</h2>

    <div class="note">
      <strong>Mode officiel unique :</strong> ScoreTech V2 est <strong>hybride obligatoire</strong> :<br>
      <strong>OSM = socle</strong> (terrain/surface/difficulté déclarée) + <strong>bonus GPX capé</strong> (pente + virages + sinuosité).<br>
      Objectif : un score à la fois <strong>audit-able</strong> (OSM) et <strong>réaliste VTT</strong> (bonus GPX), sans être sensible au bruit.
    </div>

    <h3>3.1 Socle OSM : TerrainScore (0..1)</h3>
    <p>On échantillonne la trace tous les <code>~120 m</code>. Pour chaque point, on récupère les tags OpenStreetMap (<code>mtb:scale</code>, <code>smoothness</code>, <code>highway</code>, <code>surface</code>, <code>tracktype</code>, <code>sac_scale</code>).</p>

    <p><strong>Conversion tags → TerrainScore (0..1)</strong></p>
    <pre><code>Priorité
1) mtb:scale : TerrainScore = clamp(scale/5, 0, 1)
2) smoothness (excellent/good/intermediate/bad/very_bad..)
3) highway + tracktype + surface (règles)
   route/asphalt -> 0.0
   track grade1  -> 0.2
   track grade2  -> 0.35
   track grade3  -> 0.5
   path          -> 0.6
   rock/stone..  -> +0.2 (cap 1.0)</code></pre>

    <p><strong>Agrégation</strong> : percentile 75 pondéré par la distance représentée par chaque échantillon.</p>
    <pre><code>TerrainScore_OSM = weightedPercentile(TerrainScore_samples, weights=sample_distance, p=0.75)</code></pre>

    <h3>3.2 Bonus GPX (capé) : GPXTech (0..1)</h3>
    <p>On découpe la trace en segments d’environ <code>200 m</code>. Sur chaque segment, on calcule :</p>
    <ul>
      <li><strong>SinuNorm</strong> : sinuosité normalisée</li>
      <li><strong>TurnNorm</strong> : pilotage (somme des changements de cap / km)</li>
      <li><strong>SlopeTech</strong> : pente technique (proportion de pentes fortes + percentile 90)</li>
    </ul>

    <p><strong>Anti-bruit (obligatoire)</strong> : on ignore les pas GPS trop courts/longs et les spikes altimétriques.</p>
    <pre><code>Filtrage GPX
- ignorer si d &lt; 3 m (jitter) ou d &gt; 80 m (trous)
- ignorer si |Δele| &gt; 25 m sur un pas
- ignorer si |grade| &gt; 45%</code></pre>

    <p><strong>SlopeTech (0..1)</strong></p>
    <pre><code>p10  = proportion(|grade| ≥ 0.10)
p16  = proportion(|grade| ≥ 0.16)
gP90 = percentile90(|grade|)

SlopeTech = clamp(0.55*p10 + 0.45*p16 + 0.55*clamp((gP90-0.08)/0.22,0,1), 0, 1)</code></pre>

    <p><strong>TurnNorm (0..1)</strong></p>
    <pre><code>turnPerKm = sum(|Δbearing|) / km
TurnNorm  = clamp((turnPerKm - 120) / 500, 0, 1)</code></pre>

    <p><strong>SinuNorm (0..1)</strong></p>
    <pre><code>Sinuosity = dist_reelle / dist_oiseau
SinuNorm  = clamp((Sinuosity - 1.0) / 0.30, 0, 1)</code></pre>

    <p><strong>GPXTech par segment (0..1)</strong></p>
    <pre><code>GPXTech_seg = clamp(0.45*SlopeTech + 0.35*TurnNorm + 0.20*SinuNorm, 0, 1)</code></pre>

    <p><strong>Agrégation</strong> : percentile 75 pondéré par la longueur de segment.</p>
    <pre><code>GPXTech = weightedPercentile(GPXTech_seg, weights=seg_length, p=0.75)</code></pre>

    <h3>3.3 Fusion officielle : OSM socle + bonus GPX capé</h3>
    <p>Le bonus GPX est <strong>capé</strong> pour éviter qu’un GPX bruité sur-gonfle le score.</p>
    <pre><code>Base     = 0.80 * TerrainScore_OSM
Bonus    = min(0.20 * GPXTech, BONUS_CAP)

Tech01   = clamp(Base + Bonus, 0, 1)
ScoreTech = round(100 * Tech01)

où BONUS_CAP = 0.15 (soit +15 points max sur 100)</code></pre>
  </div>

  <div class="card" id="quality">
    <h2>4. Qualité des données & cas non calculables</h2>

    <div class="warn">
      <strong>OSM est obligatoire :</strong> si la couverture OSM est insuffisante, ScoreTech n’est pas calculable automatiquement.
    </div>

    <pre><code>coverage = matched_samples / total_samples

Si coverage &lt; 0.30
=> ScoreTech = non calculable (à valider / compléter)</code></pre>

    <p class="muted">Ce comportement évite d’attribuer un ScoreTech arbitraire lorsque les tags OSM sont absents ou incohérents.</p>
  </div>

  <div class="card" id="params">
    <h2>5. Paramètres & calibration</h2>
    <ul>
      <li><strong>OSM sampling</strong> : 120 m (plus fin si besoin, mais attention au coût Overpass).</li>
      <li><strong>Segment GPX</strong> : 200 m (tech-sensitive).</li>
      <li><strong>Percentile</strong> : P75 (robuste : valorise les sections déterminantes sans être dominé par les portions faciles).</li>
      <li><strong>Cap bonus</strong> : 0.15 (= +15/100 max). Ajustable après calibration terrain.</li>
      <li><strong>Pondération</strong> : OSM 80% / GPX 20% (équilibre “audit” + “réalité VTT”).</li>
    </ul>

    <pre><code>Rappel
MRS = round(0.55 × ScorePhys + 0.45 × ScoreTech)</code></pre>
  </div>

</div>
</body>
</html>

