<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Créer une épreuve</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;margin:0}
    header{background:#fff;padding:14px 16px;box-shadow:0 1px 8px rgba(0,0,0,.06);display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
    nav a{margin-right:10px;text-decoration:none;color:#2563eb}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:12px}
    label{display:block;margin-top:10px;font-weight:700}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;border:1px solid #cbd5e1;border-radius:10px;box-sizing:border-box}
    textarea{resize:vertical}
    .muted{color:#667085}
    .box{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;margin-top:12px}
    .btn{margin-top:14px;padding:12px 16px;border-radius:10px;border:0;background:#2563eb;color:#fff;cursor:pointer;font-weight:800}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > div{flex:1;min-width:160px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-weight:700;font-size:12px}
    .warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa;padding:10px;border-radius:10px;margin-top:10px}

    /* Age rows with laps inputs */
    .age-group .age-row{display:grid;grid-template-columns: 1fr 120px 120px;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed #e5e7eb}
    .age-group .age-row:last-child{border-bottom:0}
    .age-group .head{display:grid;grid-template-columns: 1fr 120px 120px;gap:10px;font-weight:800;color:#0f172a;margin-bottom:6px}
    .age-group label{display:flex;align-items:flex-start;gap:10px;font-weight:400;margin:0;cursor:pointer}
    .age-group input[type="checkbox"]{margin-top:3px;width:auto}
    .age-group input[type="number"]{width:100%;padding:8px;margin:0;border-radius:10px}
    .age-group .small{font-size:12px;color:#667085;margin-top:-2px}

    /* ---- MTB Points: Status (GPX/OSM) ---- */
    .mtb-status{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;
    }
    .mtb-status-msg{font-size:14px;color:#0f172a;font-weight:800}
    .mtb-status-sub{font-size:12px;color:#667085;margin-top:2px}
    .mtb-spinner{
      width:18px;height:18px;border-radius:999px;
      border:2px solid rgba(100,116,139,.35);
      border-top-color:rgba(37,99,235,.95);
      animation:mtbSpin .9s linear infinite;
    }
    @keyframes mtbSpin{to{transform:rotate(360deg)}}
    .mtb-progress{height:6px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .mtb-progress > div{height:100%;width:0%;background:rgba(37,99,235,.95);transition:width .2s ease}
    .mtb-badge{
      font-size:12px;padding:2px 8px;border-radius:999px;
      border:1px solid #e5e7eb;color:#667085;font-weight:800;
      white-space:nowrap;
    }
    .mtb-badge.ok{color:#166534;border-color:#86efac;background:#dcfce7}
    .mtb-badge.err{color:#991b1b;border-color:#fecaca;background:#fee2e2}
    .mtb-badge.phase{color:#0f172a;background:#f1f5f9}

    @media(max-width:900px){
      .grid{grid-template-columns:1fr}
      .age-group .age-row,.age-group .head{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>

<header>
  <h1>MTB Points — Épreuves</h1>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html">Événements</a>
    <a href="reglement.html">Règlement</a>
    <a href="methodologie.html" class="active">Méthodologie (calcul)</a>
    <a href="about.html">À propos</a>
    <a href="login.html">Connexion</a>
  </nav>
  <div class="muted">Création d’une nouvelle épreuve (GPX obligatoire)</div>
</header>

<div class="wrap">
  <div class="card">
    <h2 style="margin:0;">Créer une épreuve</h2>
    <p class="muted" style="margin-top:6px;">
      Distance, D+, score physique (local) et ScoreTech V2 Hybrid officiel (serveur OSM) sont calculés automatiquement.
    </p>

    <div class="grid">
      <!-- LEFT -->
      <div>
        <label>Nom *</label>
        <input id="name" type="text" placeholder="Ex : Les 6 collines — 40 km" />

        <label>Date *</label>
        <input id="date" type="date" />

        <label>Discipline (optionnel)</label>
        <select id="disc">
          <option value="">— (auto-détection)</option>
          <option value="XC">XC</option>
          <option value="Enduro">Enduro</option>
          <option value="DH">DH</option>
          <option value="Gravel">Gravel</option>
          <option value="Marathon">Marathon</option>
          <option value="Ultra">Ultra</option>
        </select>
        <div class="muted" id="discHint" style="margin-top:6px;"></div>

        <label>Niveau *</label>
        <select id="level">
          <option value="Local">Locale</option>
          <option value="Régional">Régionale</option>
          <option value="National">Nationale</option>
          <option value="International">Internationale</option>
        </select>

        <label>Événement (optionnel)</label>
        <select id="meetingId">
          <option value="">Aucun (épreuve seule)</option>
        </select>
        <div class="muted" id="meetingHint" style="margin-top:6px;"></div>

        <label>Type vélo</label>
        <select id="ebike">
          <option value="0">Musculaire</option>
          <option value="1">Assistance électrique</option>
        </select>

        <label>Trace GPX *</label>
        <input id="gpxFile" type="file" accept=".gpx" />

        <div class="box">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
            <div style="font-weight:900;">Analyse GPX / OSM</div>
            <span class="pill" id="gpxPill">En attente</span>
          </div>

          <div class="muted" id="gpxStatus" style="margin-top:6px;">Aucun fichier chargé.</div>

          <!-- Statut animé (piloté par js/gpx.js via l'event mtb:status) -->
          <div id="mtbStatus" class="mtb-status" style="display:none;margin-top:10px;">
            <div class="mtb-spinner" id="mtbSpinner"></div>
            <div style="flex:1;min-width:180px">
              <div class="mtb-status-msg" id="mtbStatusMsg">Analyse…</div>
              <div class="mtb-status-sub" id="mtbStatusPhase">—</div>
              <div class="mtb-progress" id="mtbProgWrap" style="display:none;margin-top:8px;">
                <div id="mtbProgBar"></div>
              </div>
            </div>
            <span class="mtb-badge phase" id="mtbBadge">…</span>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="box" style="margin:0;">
              <div class="muted">Distance (auto)</div>
              <div style="font-weight:900;font-size:18px;" id="autoDistance">—</div>
            </div>
            <div class="box" style="margin:0;">
              <div class="muted">D+ (auto)</div>
              <div style="font-weight:900;font-size:18px;" id="autoDplus">—</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="box" style="margin:0;">
              <div class="muted">Score physique (local)</div>
              <div style="font-weight:900;font-size:18px;" id="autoPhys">—</div>
              <div class="muted" id="autoPhysInfo"></div>
            </div>
            <div class="box" style="margin:0;">
              <div class="muted">Score technique V2 (officiel)</div>
              <div style="font-weight:900;font-size:18px;" id="autoTech">—</div>
              <div class="muted" id="autoTechInfo"></div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="box" style="margin:0;">
              <div class="muted">Discipline détectée</div>
              <div style="font-weight:900;font-size:18px;" id="autoDisc">—</div>
              <div class="muted" id="autoDiscInfo"></div>
            </div>
            <div class="box" style="margin:0;">
              <div class="muted">Terrain OSM (P75)</div>
              <div style="font-weight:900;font-size:18px;" id="autoTerrain">—</div>
              <div class="muted" id="autoTerrainInfo"></div>
            </div>
          </div>

          <div class="warn" id="elevWarn" style="display:none;">
            ⚠️ Altitude non exploitable dans ce GPX → D+ et certaines métriques peuvent être dégradées.
            (Si possible, exporte un GPX avec altitude depuis Garmin/Strava/Komoot.)
          </div>
        </div>

        <div class="row">
          <div>
            <label>Lieu de départ</label>
            <input id="startPlace" type="text" placeholder="Ex : Base nature de Fréjus" />
          </div>
          <div>
            <label>Lieu d’arrivée</label>
            <input id="finishPlace" type="text" placeholder="Ex : Base nature de Fréjus" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Heure de départ</label>
            <input id="startTime" type="time" />
          </div>
          <div>
            <label>Barrière horaire</label>
            <input id="cutoffTime" type="text" placeholder="Ex : 05:30" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ravitaillements</label>
            <input id="aidStations" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label>Stands assistance mécanique</label>
            <input id="mechStations" type="number" min="0" step="1" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Nombre de participants</label>
            <input id="participantsCount" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label>Lavage des vélos</label>
            <select id="bikeWash">
              <option value="0">Non</option>
              <option value="1">Oui</option>
            </select>
          </div>
        </div>

        <label>Commentaire libre (portage/obstacles…)</label>
        <textarea id="comment" rows="4" placeholder="Ex : portage court ~150 m, 2 passages trialisants, zones glissantes selon météo..."></textarea>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="box age-group">
          <h3 style="margin:0 0 8px 0;">Catégories d’âge (UCI) + nombre de tours</h3>
          <div class="muted" style="margin-top:0;">
            Coche les catégories présentes. Définis les tours Hommes/Femmes (par défaut 1).
          </div>

          <div class="head">
            <div>Catégorie</div>
            <div class="small">Tours H</div>
            <div class="small">Tours F</div>
          </div>

          <!-- U7 -->
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="U7"> U7 (5–6 ans)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U7" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U7" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="U9"> U9 (7–8 ans)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U9" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U9" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="U11"> U11 (9–10 ans)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U11" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U11" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="U13"> U13 (11–12 ans)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U13" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U13" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="U15"> U15 (13–14 ans)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U15" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U15" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="U17"> U17 (15–16 ans)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U17" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U17" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="U19"> U19 (17–18 ans)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U19" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U19" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="U23"> U23 (19–22 ans)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U23" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U23" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="U23PLUS"> U23 ans et plus</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U23PLUS" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="U23PLUS" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="SENIOR"> Seniors (&gt; 22 ans)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="SENIOR" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="SENIOR" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="M1"> Masters 1 (30–34 ans)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="M1" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="M1" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="M2"> Masters 2 (35–39 ans)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="M2" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="M2" data-sex="F" />
          </div>
          <div class="age-row">
            <label><input type="checkbox" class="ageCat" value="M3"> Masters 3 (40 ans et +)</label>
            <input class="laps" type="number" min="1" step="1" value="1" data-age="M3" data-sex="M" />
            <input class="laps" type="number" min="1" step="1" value="1" data-age="M3" data-sex="F" />
          </div>
        </div>

        <button id="saveBtn" class="btn" type="button">Enregistrer l’épreuve</button>
        <div class="muted" id="saveInfo" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>
</div>

<script src="js/data.js"></script>
<script src="js/storage.js"></script>
<script src="js/gpx.js"></script>

<script>
  function $(id){ return document.getElementById(id); }
  function val(id){ const el = $(id); return el ? el.value.trim() : ""; }
  function num(id, d=0){ const v = Number(val(id)); return Number.isFinite(v) ? v : d; }
  function setText(id, t){ const el = $(id); if(el) el.textContent = t; }
  function setPill(state){
    const pill = $("gpxPill");
    if(!pill) return;

    if (state === "ok") {
      pill.textContent = "OK";
      pill.style.background = "#dcfce7";
      pill.style.color = "#166534";
    } else if (state === "err") {
      pill.textContent = "Erreur";
      pill.style.background = "#fee2e2";
      pill.style.color = "#991b1b";
    } else {
      pill.textContent = "En attente";
      pill.style.background = "#f1f5f9";
      pill.style.color = "#0f172a";
    }
  }

  // meetings select + preselect from URL
  (function initMeetings(){
    const sel = $("meetingId");
    if (!sel || typeof loadMeetings !== "function") return;

    const meetings = loadMeetings();
    meetings.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = `${m.name} (${m.date || "—"})`;
      sel.appendChild(opt);
    });

    const params = new URLSearchParams(location.search);
    const mid = params.get("meetingId");
    if (mid) {
      sel.value = mid;
      const m = (typeof findMeeting === "function") ? findMeeting(mid) : null;
      if (m) setText("meetingHint", `Épreuve rattachée à l’événement : ${m.name}`);
    }

    sel.addEventListener("change", ()=> {
      const m = (typeof findMeeting === "function") ? findMeeting(sel.value) : null;
      setText("meetingHint", m ? `Épreuve rattachée à l’événement : ${m.name}` : "");
    });
  })();

  // ---- Status UI (écoute les events de js/gpx.js)
  (function initStatusUI(){
    const box = $("mtbStatus");
    const msg = $("mtbStatusMsg");
    const phase = $("mtbStatusPhase");
    const spinner = $("mtbSpinner");
    const progWrap = $("mtbProgWrap");
    const progBar = $("mtbProgBar");
    const badge = $("mtbBadge");

    if (!box) return;

    window.addEventListener("mtb:status", (e) => {
      const d = e.detail || {};
      box.style.display = "flex";

      if (msg) msg.textContent = d.message || "";
      if (phase) phase.textContent = d.phase ? `Phase : ${d.phase}` : "";

      if (spinner) spinner.style.display = (d.spinning === false) ? "none" : "block";

      if (progWrap && progBar && typeof d.progress === "number") {
        progWrap.style.display = "block";
        progBar.style.width = (Math.max(0, Math.min(1, d.progress)) * 100) + "%";
      } else if (progWrap && progBar) {
        progWrap.style.display = "none";
        progBar.style.width = "0%";
      }

      if (badge) {
        badge.className = "mtb-badge phase";
        if (d.phase === "done") { badge.textContent = "OK"; badge.classList.add("ok"); }
        else if (d.phase === "error") { badge.textContent = "ERREUR"; badge.classList.add("err"); }
        else if (d.phase === "osm") { badge.textContent = "OSM"; }
        else if (d.phase === "gpx") { badge.textContent = "GPX"; }
        else { badge.textContent = "…"; }
      }
    });
  })();

  // GPX analysis
  let currentGpx = null;

  function setDashEmpty(){
    setText("autoDistance", "—");
    setText("autoDplus", "—");
    setText("autoPhys", "—");
    setText("autoPhysInfo", "");
    setText("autoTech", "—");
    setText("autoTechInfo", "");
    setText("autoDisc", "—");
    setText("autoDiscInfo", "");
    setText("autoTerrain", "—");
    setText("autoTerrainInfo", "");
  }

  async function handleGpxFile(file){
    if (!file) return;

    setText("gpxStatus", "Lecture et analyse…");
    setPill("wait");
    setDashEmpty();
    if ($("elevWarn")) $("elevWarn").style.display = "none";
    setText("discHint", "");

    try {
      if (typeof analyzeGPX !== "function") throw new Error("analyzeGPX introuvable (vérifie js/gpx.js)");
      currentGpx = await analyzeGPX(file, { keepPoints: true });

      setPill("ok");
      setText("gpxStatus", `OK: ${currentGpx.fileName || file.name}`);

      // Distance / D+
      setText("autoDistance", (currentGpx.distanceKm != null) ? (String(currentGpx.distanceKm).replace(".",",") + " km") : "—");
      setText("autoDplus", (currentGpx.dplusM != null) ? (currentGpx.dplusM + " m") : "—");

      // Phys
      if (currentGpx.phys && typeof currentGpx.phys.score === "number") {
        setText("autoPhys", `${currentGpx.phys.score}/100`);
        setText("autoPhysInfo", `IPB≈${currentGpx.phys.ipbOverall} • Effort=${currentGpx.phys.effort}`);
      }

      // Tech V2 (serveur)
      const t = currentGpx.techV2;
      if (t && typeof t.techScoreV2 === "number") {
        setText("autoTech", `${t.techScoreV2}/100`);

        const cov = (typeof t.coverage === "number") ? Math.round(t.coverage * 100) : null;
        const bonusPts = (typeof t.bonusApplied === "number") ? Math.round(t.bonusApplied * 100) : null;

        setText("autoTechInfo", `Couverture OSM ${cov ?? "—"}% • Bonus GPX +${bonusPts ?? "—"} pts`);
      } else {
        setText("autoTech", "À valider");
        const cov = (t && typeof t.coverage === "number") ? Math.round(t.coverage * 100) : null;
        setText("autoTechInfo", (t && t.reason) ? `Raison : ${t.reason} • Couverture ${cov ?? "—"}%` : "ScoreTech non calculable automatiquement.");
      }

      // Terrain OSM
      if (t && typeof t.terrainScoreP75 === "number") {
        const terrainPts = Math.round(t.terrainScoreP75 * 100);
        setText("autoTerrain", `${terrainPts}/100`);
        setText("autoTerrainInfo", "Estimé depuis OSM (P75 segments).");
      }

      // Discipline hint
      const d = currentGpx.discipline;
      if (d && d.hint) {
        const conf = Math.round((d.confidence || 0) * 100);
        setText("autoDisc", d.hint);
        setText("autoDiscInfo", `Confiance ${conf}%`);

        // Si l'utilisateur n'a pas choisi de discipline, on propose l'auto
        if (!val("disc")) {
          setText("discHint", `Suggestion auto : ${d.hint} (confiance ${conf}%)`);
        }
      }

      if (!currentGpx.hasElevation && $("elevWarn")) {
        $("elevWarn").style.display = "block";
      }
    } catch (e) {
      console.error(e);
      currentGpx = null;
      setPill("err");
      setText("gpxStatus", "Erreur : " + (e.message || e));
      setDashEmpty();
    }
  }

  $("gpxFile").addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    handleGpxFile(file);
  });

  function collectAgeCategories(){
    return Array.from(document.querySelectorAll(".ageCat"))
      .filter(x => x.checked)
      .map(x => x.value);
  }

  function collectLapsRules(){
    return Array.from(document.querySelectorAll(".laps"))
      .map(inp => ({
        age: inp.getAttribute("data-age"),
        sex: inp.getAttribute("data-sex"),
        laps: Math.max(1, Number(inp.value) || 1)
      }));
  }

  $("saveBtn").addEventListener("click", () => {
    const name = val("name");
    const date = val("date");
    const level = val("level");

    // Discipline: optionnelle (auto possible)
    const disc = val("disc") || (currentGpx?.discipline?.hint ?? "");

    if (!name || !date || !level) {
      alert("⚠️ Champs obligatoires : Nom, Date, Niveau");
      return;
    }
    if (!currentGpx) {
      alert("⚠️ Trace GPX obligatoire : ajoute un fichier GPX puis relance l’analyse.");
      return;
    }
    if (typeof addStoredEvent !== "function") {
      alert("Erreur: addStoredEvent() introuvable. Vérifie storage.js.");
      return;
    }

    const ev = {
      id: makeIdFromName(name),
      name,
      date,
      disc: disc || "—",
      level,
      ebike: (val("ebike") === "1"),
      meetingId: val("meetingId") || null,

      // auto from analysis
      distanceKm: currentGpx.distanceKm ?? null,
      dplusM: currentGpx.dplusM ?? null,
      gpx: currentGpx, // contient phys + techV2 + discipline

      // info
      startPlace: val("startPlace") || null,
      finishPlace: val("finishPlace") || null,
      startTime: val("startTime") || null,
      cutoffTime: val("cutoffTime") || null,
      aidStations: num("aidStations",0),
      mechStations: num("mechStations",0),
      participantsCount: num("participantsCount",0),
      bikeWash: (val("bikeWash") === "1"),
      comment: val("comment") || null,

      ageCategories: collectAgeCategories(),
      lapsRules: collectLapsRules()
    };

    addStoredEvent(ev);

    // attach to meeting if selected
    const mid = ev.meetingId;
    if (mid && typeof findMeeting === "function" && typeof updateMeeting === "function") {
      const m = findMeeting(mid);
      if (m) {
        m.raceIds = m.raceIds || [];
        if (!m.raceIds.includes(ev.id)) m.raceIds.push(ev.id);
        updateMeeting(m);
      }
    }

    setText("saveInfo", "✅ Épreuve enregistrée. Redirection vers la fiche…");
    alert("✅ Épreuve enregistrée !");
    window.location.href = `event.html?id=${encodeURIComponent(ev.id)}`;
  });
</script>

</body>
</html>
