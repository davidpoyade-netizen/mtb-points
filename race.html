<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fiche √©preuve ‚Äî MTB Points</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="./css/style.css" />

  <style>
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .blockTitle{font-weight:900;margin:0 0 10px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .item{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px}
    .label{color:#667085;font-size:12px;margin-bottom:6px}
    .value{font-weight:900;font-size:18px;color:#0f172a}
    .muted{color:#667085;font-size:12px;margin-top:6px}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid #e5e7eb;background:#f8fafc;color:#0f172a}
    .pillDot{width:10px;height:10px;border-radius:999px;background:#94a3b8}

    .scoreRow{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0 0}
    .scoreBadge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;
      font-weight:900;font-size:12px;white-space:nowrap;
    }

    .barWrap{margin-top:8px;background:#f1f5f9;border-radius:999px;overflow:hidden;border:1px solid #e5e7eb;height:16px}
    .barSeg{height:16px;display:block;float:left}
    .segRoad{background:#64748b}
    .segTrack{background:#22c55e}
    .segSingle{background:#ef4444}

    #map{height:380px;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#fff}
    #profileWrap{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    #profileCanvas{width:100%;display:block}

    .linkBtn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:12px;background:#2563eb;color:#fff;
      text-decoration:none;font-weight:900;border:1px solid #2563eb;
    }
    .linkBtn.secondary{background:#fff;color:#0f172a;border:1px solid #e5e7eb}

    @media(max-width:900px){
      .grid,.grid3,.twoCol{grid-template-columns:1fr}
      #map{height:320px}
    }
  </style>
</head>

<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1 style="margin:0;font-size:18px">MTB Points ‚Äî Fiche √©preuve</h1>
    <span class="pill"><span class="pillDot" id="statusDot"></span> <span id="statusText">Chargement‚Ä¶</span></span>
  </div>

  <nav class="nav">
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html">√âv√©nements</a>
    <a href="events.html">√âpreuves</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="headerRight" style="display:flex;gap:10px;flex-wrap:wrap">
    <a class="linkBtn secondary" href="events.html">‚Üê √âpreuves</a>
  </div>
</header>

<div class="wrap">

  <!-- Bloc 1 -->
  <section class="card">
    <h2 class="blockTitle" id="raceName">‚Äî</h2>

    <div class="grid3">
      <div class="item">
        <div class="label">Date</div>
        <div class="value" id="raceDate">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">Discipline</div>
        <div class="value" id="raceDisc">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">Cat√©gorie</div>
        <div class="value" id="raceLevel">‚Äî</div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="item">
        <div class="label">Distance</div>
        <div class="value" id="raceDistance">‚Äî</div>
        <div class="muted" id="raceDistanceHint">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">D√©nivel√© +</div>
        <div class="value" id="raceDplus">‚Äî</div>
        <div class="muted" id="raceElevInfo">‚Äî</div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="item">
        <div class="label">Type v√©lo</div>
        <div class="value" id="raceBike">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">Barri√®re horaire</div>
        <div class="value" id="raceCutoff">‚Äî</div>
      </div>
    </div>
  </section>

  <!-- Bloc 2 -->
  <section class="card" style="margin-top:14px;">
    <h3 class="blockTitle">Scores & difficult√©</h3>

    <div class="scoreRow">
      <span class="scoreBadge">üí™ Phys <b id="scorePhysVal">‚Äî</b>/100</span>
      <span class="scoreBadge">ü™® Tech <b id="scoreTechVal">‚Äî</b>/100</span>
      <span class="scoreBadge">üèÅ Global <b id="scoreGlobalVal">‚Äî</b>/100</span>
    </div>

    <div class="grid3" style="margin-top:12px;">
      <div class="item">
        <div class="label">Niveau de difficult√©</div>
        <div class="value" id="diffLabel">‚Äî</div>
        <div class="muted" id="diffHint">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">Type de voie</div>
        <div class="value" id="surfaceText">‚Äî</div>
        <div class="barWrap" aria-label="Route / Piste / Single">
          <span class="barSeg segRoad" id="barRoad" style="width:0%"></span>
          <span class="barSeg segTrack" id="barTrack" style="width:0%"></span>
          <span class="barSeg segSingle" id="barSingle" style="width:0%"></span>
        </div>
        <div class="muted">Route (gris) ‚Ä¢ Piste (vert) ‚Ä¢ Single (rouge)</div>
      </div>
      <div class="item">
        <div class="label">R√©sum√© automatique</div>
        <div class="value" id="autoSummary" style="font-size:14px;font-weight:800;">‚Äî</div>
        <div class="muted">Synth√®se depuis la trace / scores</div>
      </div>
    </div>

    <div class="item" style="margin-top:12px;">
      <div class="label">Multi-tours (si activ√©)</div>
      <div class="value" id="lapsInfo" style="font-size:14px;font-weight:800;">‚Äî</div>
      <div class="muted" id="lapsHint">‚Äî</div>
    </div>
  </section>

  <!-- Bloc 3 -->
  <section class="card" style="margin-top:14px;">
    <h3 class="blockTitle">Profil & carte</h3>

    <div class="twoCol">
      <div id="profileWrap">
        <div class="label">Profil altim√©trique</div>
        <canvas id="profileCanvas" height="220"></canvas>
        <div class="muted" id="profileInfo">‚Äî</div>
      </div>

      <div>
        <div class="label">Carte du trac√©</div>
        <div id="map"></div>
        <div class="muted">D√©part / arriv√©e affich√©s si d√©tect√©s</div>
      </div>
    </div>
  </section>

  <!-- Infos pratiques -->
  <section class="card" style="margin-top:14px;">
    <h3 class="blockTitle">Informations pratiques</h3>

    <div class="grid3">
      <div class="item">
        <div class="label">Lavage v√©los</div>
        <div class="value" id="bikeWash">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">Assistance m√©canique</div>
        <div class="value" id="mechStations">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">Ravitaillements</div>
        <div class="value" id="aidStations">‚Äî</div>
      </div>
    </div>

    <div class="item" style="margin-top:12px;">
      <div class="label">Commentaire</div>
      <div class="value" style="font-size:14px;font-weight:700;" id="raceComment">‚Äî</div>
    </div>
  </section>

  <!-- √âv√©nement -->
  <section class="card" style="margin-top:14px;">
    <h3 class="blockTitle">√âv√©nement</h3>
    <div id="meetingBlock" class="muted">‚Äî</div>
  </section>

  <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
    <a class="linkBtn secondary" href="events.html">‚Üê Retour aux √©preuves</a>
    <a class="linkBtn" id="meetingLinkBtn" href="meetings.html" style="display:none">Voir l‚Äô√©v√©nement</a>
    <a class="linkBtn secondary" id="meetingUrlBtn" href="#" target="_blank" rel="noopener" style="display:none">Ouvrir le lien officiel</a>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const params = new URLSearchParams(location.search);
  const KEY_RACES = "mtb.races.v1";
  const KEY_MEETINGS = "mtb.meetings.v1";

  function setStatus(ok, t){
    $("statusDot").style.background = ok ? "#16a34a" : "#94a3b8";
    $("statusText").textContent = t || (ok ? "OK" : "‚Äî");
  }

  function loadJSON(key){
    try{
      const raw = localStorage.getItem(key);
      const v = raw ? JSON.parse(raw) : [];
      return Array.isArray(v) ? v : [];
    }catch(_){ return []; }
  }

  function fmt1(n){ return (n==null) ? "‚Äî" : (Math.round(n*10)/10).toString().replace(".", ","); }
  function num(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }

  function diffLabelFromGlobal(g){
    if (g == null) return { label:"‚Äî", hint:"Score global indisponible." };
    if (g < 25) return { label:"Facile", hint:"Accessible √† la majorit√© des pratiquants." };
    if (g < 50) return { label:"Mod√©r√©", hint:"Relief / technicit√© interm√©diaires." };
    if (g < 75) return { label:"Difficile", hint:"Exigeant physiquement et/ou techniquement." };
    return { label:"Tr√®s difficile", hint:"Tr√®s exigeant : pr√©paration recommand√©e." };
  }

  function surfaceToBars(s){
    const road = Math.max(0, Math.min(100, Math.round(s?.roadPct ?? 0)));
    const track = Math.max(0, Math.min(100, Math.round(s?.trackPct ?? 0)));
    const single = Math.max(0, Math.min(100, Math.round(s?.singlePct ?? 0)));
    const sum = road + track + single || 1;
    return {
      road: Math.round(road/sum*100),
      track: Math.round(track/sum*100),
      single: Math.max(0, 100 - Math.round(road/sum*100) - Math.round(track/sum*100))
    };
  }

  function summarize(race){
    const dist = num(race.distanceKm);
    const dplus = num(race.dplusM);
    const g = num(race.globalScore);
    const disc = race.disc || "VTT";
    const lvl = race.level ? `(${race.level})` : "";
    const parts = [];
    parts.push(`${disc} ${lvl}`.trim());
    if (dist!=null) parts.push(`${fmt1(dist)} km`);
    if (dplus!=null) parts.push(`D+ ${Math.round(dplus)} m`);
    if (g!=null) parts.push(`Global ${Math.round(g)}/100`);
    return parts.join(" ‚Ä¢ ");
  }

  function drawProfile(points){
    const canvas = $("profileCanvas");
    const ctx = canvas.getContext("2d");
    const w = canvas.width = canvas.clientWidth;
    const h = canvas.height;

    ctx.clearRect(0,0,w,h);
    if (!Array.isArray(points) || points.length < 10){
      $("profileInfo").textContent = "Profil indisponible (points/altitude manquants).";
      return;
    }

    const ele = points.map(p => Number(p.ele)).filter(v => Number.isFinite(v));
    if (ele.length < 10){
      $("profileInfo").textContent = "Profil indisponible (altitude manquante).";
      return;
    }

    const minE = Math.min(...ele);
    const maxE = Math.max(...ele);
    const span = Math.max(1, maxE - minE);

    ctx.strokeStyle = "#2563eb";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i=0;i<points.length;i++){
      const p = points[i];
      const e = Number(p.ele);
      if (!Number.isFinite(e)) continue;
      const x = (i/(points.length-1)) * w;
      const y = h - ((e - minE)/span) * (h-10) - 5;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    $("profileInfo").textContent = `Altitude: ${Math.round(minE)}‚Äì${Math.round(maxE)} m`;
  }

  function drawMap(points){
    const map = L.map("map");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

    if (!Array.isArray(points) || points.length < 2){
      map.setView([46.5, 2.5], 5);
      return;
    }

    const latlngs = points
      .map(p => [Number(p.lat), Number(p.lon)])
      .filter(a => Number.isFinite(a[0]) && Number.isFinite(a[1]));

    if (latlngs.length < 2){
      map.setView([46.5, 2.5], 5);
      return;
    }

    const poly = L.polyline(latlngs, { weight: 4 }).addTo(map);
    map.fitBounds(poly.getBounds(), { padding:[20,20] });

    // markers start/end
    L.circleMarker(latlngs[0], { radius:6, weight:2 }).addTo(map).bindPopup("D√©part");
    L.circleMarker(latlngs[latlngs.length-1], { radius:6, weight:2 }).addTo(map).bindPopup("Arriv√©e");
  }

  function main(){
    const id = params.get("id");
    if (!id){
      setStatus(false, "ID manquant");
      $("raceName").textContent = "√âpreuve introuvable";
      return;
    }

    const races = loadJSON(KEY_RACES);
    const meetings = loadJSON(KEY_MEETINGS);
    const race = races.find(r => r && r.id === id) || null;

    if (!race){
      setStatus(false, "√âpreuve introuvable");
      $("raceName").textContent = "√âpreuve introuvable";
      return;
    }

    const meeting = race.meetingId ? (meetings.find(m => m && m.id === race.meetingId) || null) : null;

    // Bloc 1
    $("raceName").textContent = race.name || "√âpreuve";
    $("raceDate").textContent = race.date || "‚Äî";
    $("raceDisc").textContent = race.disc || "‚Äî";
    $("raceLevel").textContent = race.level || "‚Äî";

    const dist = num(race.distanceKm);
    const dplus = num(race.dplusM);

    $("raceDistance").textContent = dist==null ? "‚Äî" : `${fmt1(dist)} km`;
    $("raceDistanceHint").textContent = race.lapsConfig ? "Distance = distance GPX (1 tour) √ó tours (selon cat√©gorie/sex)." : "Distance calcul√©e depuis GPX.";
    $("raceDplus").textContent = dplus==null ? "‚Äî" : `+${Math.round(dplus)} m`;
    $("raceElevInfo").textContent = race.gpx?.hasElevation ? "Altitude OK" : "Altitude incertaine (GPX)";

    $("raceBike").textContent = race.ebike ? "Assistance √©lectrique" : "Musculaire";
    $("raceCutoff").textContent = race.cutoffTime || "‚Äî";

    // Bloc 2 scores
    const phys = num(race.physScore);
    const tech = num(race.techScore);
    const global = num(race.globalScore);

    $("scorePhysVal").textContent = phys==null ? "‚Äî" : String(Math.round(phys));
    $("scoreTechVal").textContent = tech==null ? "‚Äî" : String(Math.round(tech));
    $("scoreGlobalVal").textContent = global==null ? "‚Äî" : String(Math.round(global));

    const d = diffLabelFromGlobal(global);
    $("diffLabel").textContent = d.label;
    $("diffHint").textContent = d.hint;

    const s = race.surfaceEstimate || null;
    if (s){
      $("surfaceText").textContent = `Route ~${Math.round(s.roadPct||0)}% ‚Ä¢ Piste ~${Math.round(s.trackPct||0)}% ‚Ä¢ Single ~${Math.round(s.singlePct||0)}%`;
      const bars = surfaceToBars(s);
      $("barRoad").style.width = bars.road + "%";
      $("barTrack").style.width = bars.track + "%";
      $("barSingle").style.width = bars.single + "%";
    } else {
      $("surfaceText").textContent = "‚Äî";
      $("barRoad").style.width = "0%";
      $("barTrack").style.width = "0%";
      $("barSingle").style.width = "0%";
    }

    $("autoSummary").textContent = summarize(race);

    // Laps info
    if (race.lapsConfig && race.lapsConfig.mode === "by_age_sex"){
      const sel = Array.isArray(race.lapsConfig.selected) ? race.lapsConfig.selected : [];
      $("lapsInfo").textContent = sel.length ? `Cat√©gories: ${sel.join(", ")}` : "Multi-tours activ√© (cat√©gories non pr√©cis√©es).";
      $("lapsHint").textContent = "Les tours peuvent diff√©rer selon Homme/Femme et cat√©gorie UCI.";
    } else {
      $("lapsInfo").textContent = "Non";
      $("lapsHint").textContent = "√âpreuve en une seule boucle (ou tours identiques).";
    }

    // Infos pratiques
    $("bikeWash").textContent = race.bikeWash ? "Oui" : "Non";
    $("mechStations").textContent = String(num(race.mechStations) ?? 0);
    $("aidStations").textContent = String(num(race.aidStations) ?? 0);
    $("raceComment").textContent = race.comment || "‚Äî";

    // Meeting block
    if (meeting){
      const range = meeting.endDate ? `${meeting.date} ‚Üí ${meeting.endDate}` : (meeting.date || "‚Äî");
      const loc = meeting.location ? ` ‚Ä¢ üìç ${meeting.location}` : "";
      $("meetingBlock").innerHTML = `<b>${meeting.name}</b> ‚Ä¢ üìÖ ${range}${loc}`;
      $("meetingLinkBtn").style.display = "inline-flex";
      $("meetingLinkBtn").href = `meeting.html?id=${encodeURIComponent(meeting.id)}`;

      const url = meeting.url || race.meetingUrl || null;
      if (url){
        $("meetingUrlBtn").style.display = "inline-flex";
        $("meetingUrlBtn").href = url;
      }
    } else {
      $("meetingBlock").textContent = "Cette √©preuve n‚Äôest rattach√©e √† aucun √©v√©nement.";
    }

    // Bloc 3 map/profile
    // On essaie de normaliser les points (lat/lon/ele). Si ton analyzeGPX renvoie autre chose, on adaptera.
    const ptsRaw = race.gpx?.points || race.gpx?.raw?.points || null;

    // Normalisation flexible (on accepte {lat,lon,ele} ou {latitude,longitude,elevation})
    const points = Array.isArray(ptsRaw) ? ptsRaw.map(p => ({
      lat: p.lat ?? p.latitude,
      lon: p.lon ?? p.lng ?? p.longitude,
      ele: p.ele ?? p.alt ?? p.elevation
    })) : null;

    drawProfile(points);
    drawMap(points);

    setStatus(true, "Donn√©es charg√©es");
  }

  try{ main(); }
  catch(e){
    console.error(e);
    setStatus(false, "Erreur");
  }
})();
</script>
</body>
</html>
