<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√âpreuve ‚Äî MTB Points</title>
  <link rel="stylesheet" href="./css/style.css" />
  <style>
    .muted2{color:#64748b;font-size:12px}
    .rowBtns{display:flex;gap:10px;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .kpiGrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media(max-width:900px){.kpiGrid{grid-template-columns:1fr}}
    .kpi{border:1px solid #e5e7eb;border-radius:16px;background:#fff;padding:12px}
    .kpiLabel{color:#64748b;font-size:12px;font-weight:800}
    .kpiValue{font-weight:900;font-size:20px;margin-top:6px}
    .kpiSub{color:#64748b;font-size:12px;margin-top:4px}
    .item{border:1px solid #e5e7eb;border-radius:16px;background:#fff;padding:12px}
    .label{color:#64748b;font-size:12px;font-weight:900}
    .value{font-weight:900;font-size:18px;margin-top:6px}
    .noPrint{display:block}
    @media print{
      .noPrint{display:none !important;}
      .wrap{max-width:100% !important; padding:0 !important}
      .card{box-shadow:none !important; border:none !important}
      a{color:#000 !important; text-decoration:none !important}
    }
    #map{height:420px;border-radius:16px;border:1px solid #e5e7eb;margin-top:10px;background:#fff}
    canvas{background:#fff}
  </style>
</head>

<body>
<header class="header noPrint">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>MTB Points ‚Äî √âpreuve</h1>
    <span class="pill" id="pillMeeting"><span class="dot"></span> <span id="pillMeetingTxt">‚Äî</span></span>
  </div>

  <nav class="nav">
    <a href="index.html">Accueil</a>
    <a href="public-ranking.html">Classement</a>
    <a href="meetings.html">√âv√©nements</a>
    <a href="races.html" class="active">√âpreuves</a>
    <a href="challengemtbpoints.html">Challenge</a>
    <a href="login.html">Connexion</a>
  </nav>

  <div class="headerRight" style="display:flex;gap:8px;flex-wrap:wrap;">
    <a class="btn ghost" id="btnBack" href="races.html">‚Üê Retour</a>
    <button class="btn" id="btnPrintTop" type="button">üñ®Ô∏è Imprimer / PDF</button>
  </div>
</header>

<main class="wrap">
  <div class="card">

    <!-- HERO -->
    <section class="hero">
      <div class="heroTop">
        <div style="min-width:280px;flex:1">
          <h2 id="raceName">‚Äî</h2>
          <div class="heroMeta" id="raceMeta">‚Äî</div>
          <div class="heroDesc" id="raceComment" style="display:none;"></div>
          <div id="alertBox" class="empty" style="display:none; margin-top:12px;"></div>
        </div>

        <div class="heroActions" style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start">
          <span class="pill"><span class="dot ok"></span> Fiche √©preuve</span>
          <a class="btn ghost" id="btnOpenMeeting" href="#" style="display:none;">Voir l‚Äô√©v√©nement</a>
          <a class="btn primary" id="btnCreateSibling" href="#" style="display:none;">+ Cr√©er une autre √©preuve</a>
        </div>
      </div>
    </section>

    <!-- BLOC 1 : INFORMATIONS -->
    <h3 class="sectionTitle" style="margin-top:18px;">Bloc 1 ‚Äî Informations</h3>
    <div class="grid2">
      <div class="item">
        <div class="label">√âv√©nement</div>
        <div class="value" id="infoMeeting">‚Äî</div>
        <div class="muted2" id="infoMeetingDates">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">Date / heure</div>
        <div class="value" id="infoDateTime">‚Äî</div>
        <div class="muted2" id="infoCutoff">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">Discipline</div>
        <div class="value" id="infoDisc">‚Äî</div>
        <div class="muted2" id="infoEbike">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">Niveau</div>
        <div class="value" id="infoLevel">‚Äî</div>
        <div class="muted2" id="infoMisc">‚Äî</div>
      </div>
    </div>

    <!-- BLOC 2 : SCORES & DIFFICULT√âS -->
    <h3 class="sectionTitle" style="margin-top:18px;">Bloc 2 ‚Äî Scores & difficult√©s</h3>

    <!-- S√©lecteur tours (si dispo) -->
    <div class="filters noPrint" style="grid-template-columns: 1fr 1fr 1fr; align-items:end; margin-top:10px;">
      <div>
        <label class="lbl">Cat√©gorie (pour calcul tours)</label>
        <select class="inp" id="selAgeCat">
          <option value="">‚Äî</option>
        </select>
        <div class="muted2">Si l‚Äô√©preuve est multi-tours, choisis une cat√©gorie.</div>
      </div>
      <div>
        <label class="lbl">Sexe</label>
        <select class="inp" id="selSex">
          <option value="M">H</option>
          <option value="F">F</option>
        </select>
        <div class="muted2">Utilis√© si multi-tours par sexe.</div>
      </div>
      <div>
        <label class="lbl">Tours appliqu√©s</label>
        <input class="inp" id="lapsApplied" type="text" value="1" readonly />
        <div class="muted2" id="lapsHint">‚Äî</div>
      </div>
    </div>

    <!-- Scores -->
    <div class="kpiGrid" style="margin-top:12px;">
      <div class="kpi">
        <div class="kpiLabel">Score Physique</div>
        <div class="kpiValue"><span id="kpiPhys">‚Äî</span><span class="muted"> /100</span></div>
        <div class="kpiSub" id="kpiPhysSub">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">Score Technique</div>
        <div class="kpiValue"><span id="kpiTech">‚Äî</span><span class="muted"> /100</span></div>
        <div class="kpiSub" id="kpiTechSub">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">Score Global</div>
        <div class="kpiValue"><span id="kpiGlobal">‚Äî</span><span class="muted"> /100</span></div>
        <div class="kpiSub" id="kpiGlobalSub">‚Äî</div>
      </div>
    </div>

    <!-- Distance / D+ / Type voie (avec tours) -->
    <div class="kpiGrid" style="margin-top:12px;">
      <div class="kpi">
        <div class="kpiLabel">Distance totale (auto)</div>
        <div class="kpiValue"><span id="autoDist2">‚Äî</span></div>
        <div class="kpiSub" id="autoDistSub">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">D√©nivel√© + total (auto)</div>
        <div class="kpiValue"><span id="autoDplus2">‚Äî</span></div>
        <div class="kpiSub" id="autoDplusSub">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">Type de voie</div>
        <div class="kpiValue" style="font-size:14px" id="autoSurface2">‚Äî</div>
        <div class="kpiSub">Estimation OSM si disponible</div>
      </div>
    </div>

    <!-- R√©sum√© auto (simple placeholder) -->
    <div class="item" style="margin-top:12px;">
      <div class="label">R√©sum√©</div>
      <div class="muted2" id="summaryText">‚Äî</div>
    </div>

    <!-- BLOC 3 : PROFIL & CARTE -->
    <h3 class="sectionTitle" style="margin-top:18px;">Bloc 3 ‚Äî Profil & carte</h3>

    <div id="gpxEmpty" class="empty" style="display:none;">
      <b>Aucune trace GPX enregistr√©e</b> pour cette √©preuve.
    </div>

    <div id="gpxWrap" class="grid2" style="display:none; margin-top:10px;">
      <div class="item">
        <div class="row" style="justify-content:space-between;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <h3 style="margin:0;font-size:14px;">Carte</h3>
          <span class="pill"><span class="dot"></span> GPX</span>
        </div>
        <div id="map"></div>
        <div class="muted2" id="mapHint">‚Äî</div>
      </div>

      <div class="item">
        <div class="row" style="justify-content:space-between;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <h3 style="margin:0;font-size:14px;">Profil altim√©trique</h3>
          <span class="pill"><span class="dot"></span> GPX</span>
        </div>
        <canvas id="elevCanvas" width="900" height="360"
          style="width:100%; height:360px; border-radius:16px; border:1px solid #e5e7eb; margin-top:10px;"></canvas>
        <div class="muted2" id="elevHint">‚Äî</div>
      </div>
    </div>

    <!-- ACTIONS -->
    <h3 class="sectionTitle noPrint" style="margin-top:18px;">Actions</h3>
    <div class="rowBtns noPrint">
      <button class="btn" id="btnPrintBottom" type="button">üñ®Ô∏è Imprimer / PDF</button>
      <a class="btn" id="btnGoMeeting2" href="#" style="display:none;">Voir l‚Äô√©v√©nement</a>
      <a class="btn primary" id="btnCreateSibling2" href="#" style="display:none;">Cr√©er une autre √©preuve</a>
    </div>

  </div>
</main>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script src="js/data.js"></script>
<script src="js/storage.js"></script>
<script src="js/gpx.js"></script>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const params = new URLSearchParams(location.search);

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function num(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }
  function fmt1(n){ return (n == null) ? "‚Äî" : String(Math.round(n * 10)/10); }
  function fmt0(n){ return (n == null) ? "‚Äî" : String(Math.round(n)); }
  function fmtDate(iso){ return iso ? esc(iso) : "‚Äî"; }

  function setAlert(html){
    const box = $("alertBox");
    if (!box) return;
    box.style.display = html ? "block" : "none";
    box.innerHTML = html || "";
  }

  // ---- Storage adapters
  function listRacesSafe(){
    if (typeof window.listRaces === "function") return window.listRaces();
    if (typeof window.getRaces === "function") return window.getRaces();
    try {
      const raw = localStorage.getItem("mtb.races.v1");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch(_){ return []; }
  }
  function findRaceSafe(id){
    if (!id) return null;
    if (typeof window.findRace === "function") return window.findRace(id);
    return listRacesSafe().find(r => r && r.id === id) || null;
  }
  function listMeetingsSafe(){
    if (typeof window.listMeetings === "function") return window.listMeetings();
    if (typeof window.getMeetings === "function") return window.getMeetings();
    try {
      const raw = localStorage.getItem("mtb.meetings.v1");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch(_){ return []; }
  }
  function findMeetingSafe(id){
    if (!id) return null;
    if (typeof window.findMeeting === "function") return window.findMeeting(id);
    return listMeetingsSafe().find(m => m && m.id === id) || null;
  }

  // ---- print buttons
  function wirePrint(){
    const go = ()=> window.print();
    const t = $("btnPrintTop"); if (t) t.addEventListener("click", go);
    const b = $("btnPrintBottom"); if (b) b.addEventListener("click", go);
  }

  // ---- Map + profile helpers (simple)
  function extractPoints(race){
    // On accepte plusieurs formes
    const pts =
      race?.gpx?.points ||
      race?.analysis?.points ||
      race?.analysis?.raw?.points ||
      race?.analysis?.raw?.track?.points ||
      race?.analysis?.raw?.track ||
      null;
    return Array.isArray(pts) ? pts : null;
  }

  function drawElev(points){
    const canvas = $("elevCanvas");
    const hint = $("elevHint");
    if (!canvas || !points || points.length < 10){
      if (hint) hint.textContent = "‚Äî";
      return;
    }
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    // take ele or alt
    const elev = points.map(p => num(p.ele ?? p.alt ?? p.elevation ?? null)).filter(v => v != null);
    if (elev.length < 10){
      if (hint) hint.textContent = "Altitude indisponible dans le GPX.";
      return;
    }
    const minE = Math.min(...elev);
    const maxE = Math.max(...elev);
    const span = Math.max(1, maxE - minE);

    // use same length as points by sampling
    const N = Math.min(points.length, 900);
    function getEleAt(i){
      const idx = Math.floor(i * (points.length-1) / (N-1));
      return num(points[idx]?.ele ?? points[idx]?.alt ?? points[idx]?.elevation ?? null);
    }

    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i=0;i<N;i++){
      const e = getEleAt(i);
      if (e == null) continue;
      const x = (i/(N-1))*w;
      const y = h - ((e - minE)/span) * (h*0.85) - (h*0.07);
      if (i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.stroke();

    if (hint) hint.textContent = `Altitude: ${Math.round(minE)} m ‚Üí ${Math.round(maxE)} m`;
  }

  function renderMap(points){
    const mapEl = $("map");
    const hint = $("mapHint");
    if (!mapEl || !points || points.length < 10){
      if (hint) hint.textContent = "‚Äî";
      return;
    }

    const latlngs = points
      .map(p => [num(p.lat ?? p.latitude ?? null), num(p.lon ?? p.lng ?? p.longitude ?? null)])
      .filter(a => a[0] != null && a[1] != null);

    if (latlngs.length < 10){
      if (hint) hint.textContent = "Coordonn√©es GPX indisponibles.";
      return;
    }

    const map = L.map("map", { scrollWheelZoom:false });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19, attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    const line = L.polyline(latlngs, { weight: 4 }).addTo(map);
    map.fitBounds(line.getBounds(), { padding:[20,20] });

    if (hint) hint.textContent = `Trace: ${latlngs.length} points`;
  }

  // ---- Tours logic
  function getLapsApplied(race, ageCat, sex){
    // priority: lapsByCategorySex
    const lbs = race?.lapsByCategorySex || null;
    if (lbs && ageCat){
      const entry = lbs[ageCat] || null;
      const v = entry ? (entry[sex] ?? null) : null;
      if (Number.isFinite(Number(v)) && Number(v) > 0) return Number(v);
      // si existe mais pas renseign√© pour ce sexe -> 1
      return 1;
    }
    // fallback: race.laps
    const l = num(race?.laps);
    if (l != null && l > 0) return l;
    return 1;
  }

  function fillAgeCatSelect(race){
    const sel = $("selAgeCat");
    if (!sel) return;

    const lbs = race?.lapsByCategorySex || null;
    if (!lbs || typeof lbs !== "object"){
      // pas multi-tours: laisse juste "‚Äî"
      sel.innerHTML = `<option value="">‚Äî</option>`;
      sel.disabled = true;
      $("selSex").disabled = true;
      $("lapsHint").textContent = "Pas de multi-tours (lapsByCategorySex absent).";
      return;
    }

    const keys = Object.keys(lbs).sort((a,b)=> a.localeCompare(b, "fr"));
    sel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` + keys.map(k => `<option value="${esc(k)}">${esc(k)}</option>`).join("");
    sel.disabled = false;
    $("selSex").disabled = false;
    $("lapsHint").textContent = "Multi-tours activ√© : s√©lectionne cat√©gorie + sexe.";
  }

  function updateTotals(race){
    const ageCat = $("selAgeCat")?.value || "";
    const sex = $("selSex")?.value || "M";

    const laps = getLapsApplied(race, ageCat, sex);
    $("lapsApplied").value = String(laps);

    const baseDist = num(race?.distanceKm ?? race?.analysis?.distanceKm ?? null);
    const baseDplus = num(race?.dplusM ?? race?.analysis?.dplusM ?? null);

    const totDist = (baseDist == null) ? null : baseDist * laps;
    const totDplus = (baseDplus == null) ? null : baseDplus * laps;

    $("autoDist2").textContent = (totDist == null) ? "‚Äî" : `${fmt1(totDist)} km`;
    $("autoDplus2").textContent = (totDplus == null) ? "‚Äî" : `+${fmt0(totDplus)} m`;

    $("autoDistSub").textContent = (baseDist == null)
      ? "Distance GPX indisponible"
      : `Base: ${fmt1(baseDist)} km √ó ${laps} tour(s)`;
    $("autoDplusSub").textContent = (baseDplus == null)
      ? "D+ GPX indisponible"
      : `Base: +${fmt0(baseDplus)} m √ó ${laps} tour(s)`;

    const s2 = race?.surfaceEstimate || race?.analysis?.surfaceEstimate || null;
    if (s2){
      const road = Math.round(num(s2.roadPct) || 0);
      const track = Math.round(num(s2.trackPct) || 0);
      const single = Math.round(num(s2.singlePct) || 0);
      $("autoSurface2").textContent = `Route ~${road}% ‚Ä¢ Piste ~${track}% ‚Ä¢ Single ~${single}%`;
    } else {
      $("autoSurface2").textContent = "‚Äî";
    }

    // mini r√©sum√© auto simple
    const parts = [];
    if (race?.disc) parts.push(String(race.disc));
    if (totDist != null) parts.push(`${fmt1(totDist)} km`);
    if (totDplus != null) parts.push(`+${fmt0(totDplus)} m`);
    const g = num(race?.globalScore ?? race?.analysis?.globalScore ?? null);
    if (g != null) parts.push(`Global ${fmt0(g)}/100`);
    $("summaryText").textContent = parts.length ? parts.join(" ‚Ä¢ ") : "‚Äî";
  }

  // ---- render page
  function render(){
    const id = params.get("id");
    if (!id){
      setAlert(`‚ùå ID d‚Äô√©preuve manquant. Retourne √† la liste des √©preuves : <a href="races.html">races.html</a>`);
      return;
    }

    const race = findRaceSafe(id);
    if (!race){
      setAlert(`‚ùå √âpreuve introuvable (id: <code>${esc(id)}</code>).`);
      return;
    }

    // Back button
    $("btnBack").href = race.meetingId ? `meeting.html?id=${encodeURIComponent(race.meetingId)}` : "races.html";

    // Header
    $("raceName").textContent = race.name || "√âpreuve";
    const metaBits = [];
    metaBits.push(`üìÖ ${fmtDate(race.date)}`);
    if (race.time) metaBits.push(`üïí ${esc(race.time)}`);
    if (race.meetingName) metaBits.push(`üèÅ ${esc(race.meetingName)}`);
    $("raceMeta").textContent = metaBits.join(" ‚Ä¢ ") || "‚Äî";

    if (race.comment){
      $("raceComment").style.display = "block";
      $("raceComment").textContent = race.comment;
    }

    // Meeting pill + actions
    const meeting = race.meetingId ? findMeetingSafe(race.meetingId) : null;
    if (meeting){
      $("pillMeetingTxt").textContent = meeting.name || "√âv√©nement";
      $("btnOpenMeeting").href = `meeting.html?id=${encodeURIComponent(meeting.id)}`;
      $("btnOpenMeeting").style.display = "inline-flex";
      $("btnGoMeeting2").href = `meeting.html?id=${encodeURIComponent(meeting.id)}`;
      $("btnGoMeeting2").style.display = "inline-flex";
      $("btnCreateSibling").href = `course-create.html?meetingId=${encodeURIComponent(meeting.id)}`;
      $("btnCreateSibling").style.display = "inline-flex";
      $("btnCreateSibling2").href = `course-create.html?meetingId=${encodeURIComponent(meeting.id)}`;
      $("btnCreateSibling2").style.display = "inline-flex";
    } else {
      $("pillMeetingTxt").textContent = "Sans √©v√©nement";
    }

    // Bloc 1
    $("infoMeeting").textContent = meeting?.name || race.meetingName || "‚Äî";
    const md = meeting?.date || null;
    const me = meeting?.endDate || null;
    $("infoMeetingDates").textContent = md ? (me ? `üìÖ ${md} ‚Üí ${me}` : `üìÖ ${md}`) : "‚Äî";

    $("infoDateTime").textContent = race.date ? `${race.date}${race.time ? " ‚Ä¢ " + race.time : ""}` : "‚Äî";
    $("infoCutoff").textContent = race.cutoffTime ? `‚è±Ô∏è Barri√®re horaire: ${race.cutoffTime}` : "‚Äî";

    $("infoDisc").textContent = race.disc || "‚Äî";
    $("infoEbike").textContent = (race.ebike === true) ? "üö¥ Type: Assistance √©lectrique" : "üö¥ Type: Musculaire";

    $("infoLevel").textContent = race.level || "‚Äî";
    const misc = [];
    if (race.bikeWash) misc.push(`Lavage: ${race.bikeWash}`);
    if (race.mechAssist != null) misc.push(`Assistance m√©ca: ${race.mechAssist}`);
    if (race.feeds != null) misc.push(`Ravitos: ${race.feeds}`);
    if (race.sexAllowed && race.sexAllowed !== "all") misc.push(`Sexe: ${race.sexAllowed}`);
    $("infoMisc").textContent = misc.length ? misc.join(" ‚Ä¢ ") : "‚Äî";

    // Scores
    const phys = num(race.physScore ?? race.analysis?.physScore ?? null);
    const tech = num(race.techScore ?? race.analysis?.techScore ?? null);
    const global = num(race.globalScore ?? race.analysis?.globalScore ?? null);

    $("kpiPhys").textContent = phys == null ? "‚Äî" : fmt0(phys);
    $("kpiTech").textContent = tech == null ? "‚Äî" : fmt0(tech);
    $("kpiGlobal").textContent = global == null ? "‚Äî" : fmt0(global);

    $("kpiPhysSub").textContent = phys == null ? "‚Äî" : "Effort (distance, D+, pentes)";
    $("kpiTechSub").textContent = tech == null ? "‚Äî" : "Technicit√© (OSM + terrain)";
    $("kpiGlobalSub").textContent = global == null ? "‚Äî" : "Synth√®se";

    // Tours selectors
    fillAgeCatSelect(race);
    updateTotals(race);

    const selAge = $("selAgeCat");
    const selSex = $("selSex");
    if (selAge) selAge.addEventListener("change", ()=> updateTotals(race));
    if (selSex) selSex.addEventListener("change", ()=> updateTotals(race));

    // GPX / map / elev
    const pts = extractPoints(race);
    if (!pts || pts.length < 10){
      $("gpxEmpty").style.display = "block";
      $("gpxWrap").style.display = "none";
    } else {
      $("gpxEmpty").style.display = "none";
      $("gpxWrap").style.display = "grid";
      try{ renderMap(pts); } catch(e){ console.warn(e); }
      try{ drawElev(pts); } catch(e){ console.warn(e); }
    }
  }

  wirePrint();
  render();
})();
</script>

</body>
</html>
